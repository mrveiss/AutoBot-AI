# AutoBot Centralized Logging Configuration
# Collects ALL container logs into a single location

<system>
  log_level info
</system>

# Input: Collect logs from ALL Docker containers
<source>
  @type forward
  port 24224
  bind 0.0.0.0
  tag docker.*
</source>

# Simplified log collection - removed problematic sources
# Focus on forward input from Docker containers

# Filter: Add container metadata to all logs
<filter docker.**>
  @type record_transformer
  <record>
    hostname "#{Socket.gethostname}"
    service_name ${tag_parts[1]}
    log_source docker
    timestamp ${time}
  </record>
</filter>

# Filter: Add AutoBot metadata
<filter autobot.**>
  @type record_transformer
  <record>
    hostname "#{Socket.gethostname}"
    service_name autobot
    log_source application
    timestamp ${time}
  </record>
</filter>

# Output: Send ALL logs to single file location (modern FluentD configuration)
<match **>
  @type file
  path /var/log/autobot/all-logs
  append true
  <format>
    @type json
  </format>
  include_time_key true
  time_key timestamp

  <buffer time>
    @type file
    path /var/log/autobot/buffer
    timekey 1h
    timekey_wait 10m
    timekey_use_utc false
    flush_mode interval
    flush_interval 5s
    chunk_limit_size 10m
    queue_limit_length 128
  </buffer>
</match>

# Modern FluentD internal log handling (replaces deprecated top-level match)
<label @FLUENT_LOG>
  <match fluent.**>
    @type file
    path /var/log/fluentd/fluent
    <format>
      @type json
    </format>
    <buffer time>
      @type file
      path /var/log/fluentd/buffer
      timekey 1h
      timekey_wait 10m
      timekey_use_utc false
      flush_mode interval
      flush_interval 30s
    </buffer>
  </match>
</label>

# Elasticsearch output removed - using file-based centralized logging only
