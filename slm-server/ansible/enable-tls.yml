# AutoBot - AI-Powered Automation Platform
# Copyright (c) 2025 mrveiss
# Author: mrveiss
#
# TLS Enablement Playbook (Issue #768)
# Enables TLS/HTTPS on AutoBot services
#
# Usage:
#   # Enable TLS on frontend only
#   ansible-playbook -i inventory.yml enable-tls.yml --limit frontend
#
#   # Enable TLS on all services
#   ansible-playbook -i inventory.yml enable-tls.yml
#
#   # Enable TLS with custom certificate paths
#   ansible-playbook -i inventory.yml enable-tls.yml -e "tls_cert_dir=/custom/path"
#
# Prerequisites:
#   1. Generate certificates: python -m src.pki.setup
#   2. Distribute certificates: ansible-playbook distribute-tls-certs.yml
---

# ===== Frontend TLS Enablement =====
- name: Enable TLS on Frontend
  hosts: frontend
  become: true
  gather_facts: true

  vars:
    tls_cert_dir: "{{ lookup('env', 'AUTOBOT_TLS_CERT_DIR') | default('/etc/autobot/certs', true) }}"
    frontend_tls_enabled: true
    frontend_tls_port: 443
    frontend_tls_cert: "{{ tls_cert_dir }}/server-cert.pem"
    frontend_tls_key: "{{ tls_cert_dir }}/server-key.pem"

  tasks:
    - name: Verify TLS certificates exist
      ansible.builtin.stat:
        path: "{{ item }}"
      loop:
        - "{{ frontend_tls_cert }}"
        - "{{ frontend_tls_key }}"
      register: cert_check

    - name: Fail if certificates missing
      ansible.builtin.fail:
        msg: |
          TLS certificates not found at:
            - {{ frontend_tls_cert }}
            - {{ frontend_tls_key }}

          Run certificate distribution first:
            ansible-playbook -i inventory.yml distribute-tls-certs.yml --limit frontend
      when: not (cert_check.results | map(attribute='stat.exists') | list | min)

    - name: Allow HTTPS port in firewall
      community.general.ufw:
        rule: allow
        port: "{{ frontend_tls_port }}"
        proto: tcp
      ignore_errors: true

    - name: Deploy TLS-enabled frontend service
      ansible.builtin.template:
        src: roles/frontend/templates/autobot-frontend.service.j2
        dest: /etc/systemd/system/autobot-frontend.service
        mode: "0644"
      vars:
        frontend_user: autobot
        frontend_group: autobot
        frontend_install_dir: /opt/autobot
        frontend_log_dir: /var/log/autobot
        frontend_host: "0.0.0.0"
      notify:
        - reload systemd
        - restart frontend

    - name: Update frontend environment for HTTPS backend
      ansible.builtin.lineinfile:
        path: /opt/autobot/autobot-vue/.env.local
        regexp: '^VITE_API_BASE_URL='
        line: "VITE_API_BASE_URL=https://172.16.168.20:8443"
        create: true
        mode: "0644"
        owner: autobot
        group: autobot
      when: backend_tls_enabled | default(false)
      notify: restart frontend

  handlers:
    - name: reload systemd
      ansible.builtin.systemd:
        daemon_reload: true

    - name: restart frontend
      ansible.builtin.systemd:
        name: autobot-frontend
        state: restarted


# ===== Backend TLS Enablement =====
- name: Enable TLS on Backend
  hosts: backend
  become: true
  gather_facts: true

  vars:
    tls_cert_dir: "{{ lookup('env', 'AUTOBOT_TLS_CERT_DIR') | default('/etc/autobot/certs', true) }}"
    backend_tls_enabled: true
    backend_tls_port: 8443

  tasks:
    - name: Verify TLS certificates exist
      ansible.builtin.stat:
        path: "{{ tls_cert_dir }}/{{ item }}"
      loop:
        - server-cert.pem
        - server-key.pem
        - ca-cert.pem
      register: cert_check

    - name: Fail if certificates missing
      ansible.builtin.fail:
        msg: |
          TLS certificates not found in {{ tls_cert_dir }}
          Run: ansible-playbook -i inventory.yml distribute-tls-certs.yml --limit backend
      when: not (cert_check.results | map(attribute='stat.exists') | list | min)

    - name: Allow HTTPS port in firewall
      community.general.ufw:
        rule: allow
        port: "{{ backend_tls_port }}"
        proto: tcp
      ignore_errors: true

    - name: Update backend environment for TLS
      ansible.builtin.blockinfile:
        path: /opt/autobot/.env
        create: true
        mode: "0600"
        owner: autobot
        group: autobot
        marker: "# {mark} TLS CONFIGURATION (Issue #768)"
        block: |
          AUTOBOT_BACKEND_TLS_ENABLED=true
          AUTOBOT_BACKEND_TLS_PORT={{ backend_tls_port }}
          AUTOBOT_TLS_CERT_PATH={{ tls_cert_dir }}/server-cert.pem
          AUTOBOT_TLS_KEY_PATH={{ tls_cert_dir }}/server-key.pem
          AUTOBOT_TLS_CA_PATH={{ tls_cert_dir }}/ca-cert.pem
      notify: restart backend

  handlers:
    - name: restart backend
      ansible.builtin.systemd:
        name: autobot-backend
        state: restarted
      ignore_errors: true


# ===== Redis TLS Enablement =====
- name: Enable TLS on Redis
  hosts: redis
  become: true
  gather_facts: true

  vars:
    tls_cert_dir: "{{ lookup('env', 'AUTOBOT_TLS_CERT_DIR') | default('/etc/autobot/certs', true) }}"
    redis_tls_port: 6380

  tasks:
    - name: Verify TLS certificates exist
      ansible.builtin.stat:
        path: "{{ tls_cert_dir }}/{{ item }}"
      loop:
        - server-cert.pem
        - server-key.pem
        - ca-cert.pem
      register: cert_check

    - name: Fail if certificates missing
      ansible.builtin.fail:
        msg: |
          TLS certificates not found in {{ tls_cert_dir }}
          Run: ansible-playbook -i inventory.yml distribute-tls-certs.yml --limit redis
      when: not (cert_check.results | map(attribute='stat.exists') | list | min)

    - name: Configure Redis TLS
      ansible.builtin.blockinfile:
        path: /etc/redis/redis.conf
        marker: "# {mark} TLS CONFIGURATION (Issue #768)"
        block: |
          tls-port {{ redis_tls_port }}
          tls-cert-file {{ tls_cert_dir }}/server-cert.pem
          tls-key-file {{ tls_cert_dir }}/server-key.pem
          tls-ca-cert-file {{ tls_cert_dir }}/ca-cert.pem
          tls-auth-clients optional
      notify: restart redis

    - name: Allow Redis TLS port in firewall
      community.general.ufw:
        rule: allow
        port: "{{ redis_tls_port }}"
        proto: tcp
      ignore_errors: true

  handlers:
    - name: restart redis
      ansible.builtin.systemd:
        name: redis-server
        state: restarted
      ignore_errors: true


# ===== Summary =====
- name: TLS Enablement Summary
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Display TLS enablement summary
      ansible.builtin.debug:
        msg: |
          ============================================
          TLS ENABLEMENT COMPLETE
          ============================================

          Services configured for TLS:
            - Frontend: https://172.16.168.21:443
            - Backend:  https://172.16.168.20:8443
            - Redis:    redis://172.16.168.23:6380 (TLS)

          Update your SSOT config (.env) with:
            AUTOBOT_FRONTEND_TLS_ENABLED=true
            AUTOBOT_BACKEND_TLS_ENABLED=true
            AUTOBOT_REDIS_TLS_ENABLED=true

          Verify with:
            curl -k https://172.16.168.21:443
            curl -k https://172.16.168.20:8443/api/health
            redis-cli -h 172.16.168.23 -p 6380 --tls ping
          ============================================
