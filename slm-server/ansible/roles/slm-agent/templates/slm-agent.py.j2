#!/usr/bin/env python3
# AutoBot - AI-Powered Automation Platform
# Copyright (c) 2025 mrveiss
# Author: mrveiss
"""
SLM Fleet Agent - Health monitoring and service discovery.
"""

import configparser
import json
import logging
import subprocess
import time
from pathlib import Path

import psutil
import requests

logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s"
)
logger = logging.getLogger("slm-agent")

CONFIG_PATH = Path("/opt/slm-agent/config.conf")
AUTOBOT_SERVICES = [
    "slm-agent", "autobot-backend", "autobot-frontend",
    "redis-server", "redis", "autobot-npu-worker",
    "playwright-server", "browser-automation",
    "prometheus", "grafana-server", "node_exporter",
    "ollama", "autobot-ai-stack"
]


def load_config() -> configparser.ConfigParser:
    """Load agent configuration."""
    config = configparser.ConfigParser()
    config.read(CONFIG_PATH)
    return config


def get_system_metrics() -> dict:
    """Collect system health metrics."""
    return {
        "cpu_percent": psutil.cpu_percent(interval=1),
        "memory_percent": psutil.virtual_memory().percent,
        "disk_percent": psutil.disk_usage("/").percent,
    }


def discover_services() -> list:
    """Discover systemd services and their status."""
    services = []
    try:
        result = subprocess.run(
            ["systemctl", "list-units", "--type=service", "--all", "--no-pager", "--plain"],
            capture_output=True, text=True, check=False
        )
        for line in result.stdout.strip().split("\n"):
            parts = line.split()
            if len(parts) >= 4:
                name = parts[0].replace(".service", "")
                if name in AUTOBOT_SERVICES or name.startswith("autobot"):
                    active = parts[2] if len(parts) > 2 else "unknown"
                    sub = parts[3] if len(parts) > 3 else "unknown"
                    status = "running" if active == "active" and sub == "running" else (
                        "failed" if sub == "failed" else "stopped"
                    )
                    services.append({
                        "name": name,
                        "status": status,
                        "active_state": active,
                        "sub_state": sub,
                        "enabled": is_service_enabled(name),
                    })
    except Exception as e:
        logger.error("Service discovery failed: %s", e)
    return services


def is_service_enabled(name: str) -> bool:
    """Check if a service is enabled."""
    try:
        result = subprocess.run(
            ["systemctl", "is-enabled", name],
            capture_output=True, text=True, check=False
        )
        return result.stdout.strip() == "enabled"
    except Exception:
        return False


def send_heartbeat(config: configparser.ConfigParser) -> None:
    """Send heartbeat to SLM manager."""
    manager_url = config.get("manager", "url", fallback="http://172.16.168.19:8080")
    node_id = config.get("manager", "node_id", fallback="{{ ansible_hostname }}")
    discovery_enabled = config.getboolean("discovery", "enabled", fallback=True)

    metrics = get_system_metrics()
    payload = {
        "node_id": node_id,
        "cpu_percent": metrics["cpu_percent"],
        "memory_percent": metrics["memory_percent"],
        "disk_percent": metrics["disk_percent"],
        "agent_version": "1.0.0",
    }

    if discovery_enabled:
        payload["extra_data"] = {
            "discovered_services": discover_services()
        }

    try:
        response = requests.post(
            f"{manager_url}/api/health/heartbeat",
            json=payload,
            timeout=10
        )
        if response.status_code == 200:
            logger.debug("Heartbeat sent successfully")
        else:
            logger.warning("Heartbeat failed: %s", response.status_code)
    except requests.RequestException as e:
        logger.error("Heartbeat error: %s", e)


def main() -> None:
    """Main agent loop."""
    config = load_config()
    interval = config.getint("heartbeat", "interval", fallback=30)

    logger.info("SLM Agent starting (interval=%ds)", interval)

    while True:
        try:
            send_heartbeat(config)
        except Exception as e:
            logger.error("Heartbeat cycle error: %s", e)
        time.sleep(interval)


if __name__ == "__main__":
    main()
