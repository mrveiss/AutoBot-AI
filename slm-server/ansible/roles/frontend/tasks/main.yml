# AutoBot - AI-Powered Automation Platform
# Copyright (c) 2025 mrveiss
# Author: mrveiss
#
# Frontend Role - Vue.js frontend deployment for AutoBot
---
- name: Install Node.js prerequisites
  ansible.builtin.apt:
    name:
      - curl
      - gnupg
    state: present
    update_cache: true

- name: Add NodeSource GPG key
  ansible.builtin.apt_key:
    url: https://deb.nodesource.com/gpgkey/nodesource.gpg.key
    state: present

- name: Add NodeSource repository
  ansible.builtin.apt_repository:
    repo: "deb https://deb.nodesource.com/node_{{ nodejs_version }} {{ ansible_distribution_release }} main"
    state: present

- name: Install Node.js
  ansible.builtin.apt:
    name: nodejs
    state: present
    update_cache: true

- name: Create autobot user
  ansible.builtin.user:
    name: "{{ frontend_user }}"
    shell: /bin/bash
    create_home: true
    state: present

- name: Create frontend directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
    owner: "{{ frontend_user }}"
    group: "{{ frontend_group }}"
  loop:
    - "{{ frontend_install_dir }}"
    - "{{ frontend_log_dir }}"

- name: Clone/update AutoBot repository
  ansible.builtin.git:
    repo: "{{ frontend_repo_url }}"
    dest: "{{ frontend_install_dir }}"
    version: "{{ frontend_version }}"
    force: true
  become_user: "{{ frontend_user }}"
  when: frontend_deploy_from_git | default(true)

- name: Install npm dependencies
  community.general.npm:
    path: "{{ frontend_install_dir }}/autobot-vue"
    state: present
  become_user: "{{ frontend_user }}"

- name: Build frontend for production
  ansible.builtin.command:
    cmd: npm run build
    chdir: "{{ frontend_install_dir }}/autobot-vue"
  become_user: "{{ frontend_user }}"
  when: frontend_build_production | default(false)

- name: Deploy frontend environment file
  ansible.builtin.template:
    src: frontend.env.j2
    dest: "{{ frontend_install_dir }}/autobot-vue/.env.local"
    mode: "0644"
    owner: "{{ frontend_user }}"
    group: "{{ frontend_group }}"
  notify: restart frontend

- name: Deploy frontend systemd service
  ansible.builtin.template:
    src: autobot-frontend.service.j2
    dest: /etc/systemd/system/autobot-frontend.service
    mode: "0644"
  notify:
    - reload systemd
    - restart frontend

- name: Enable and start frontend service
  ansible.builtin.systemd:
    name: autobot-frontend
    state: started
    enabled: true
    daemon_reload: true
