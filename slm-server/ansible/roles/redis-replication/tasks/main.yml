# AutoBot - AI-Powered Automation Platform
# Copyright (c) 2025 mrveiss
# Author: mrveiss
#
# Redis Replication Role - Configure Redis replication
# Issue #726 Phase 4: Redis replication orchestration
---
- name: Check Redis is installed
  ansible.builtin.stat:
    path: /usr/bin/redis-cli
  register: redis_cli_check

- name: Fail if Redis is not installed
  ansible.builtin.fail:
    msg: "Redis is not installed. Please install Redis first using the redis role."
  when: not redis_cli_check.stat.exists

- name: Get current replication info
  ansible.builtin.command:
    cmd: >
      redis-cli
      {% if redis_password | default('') | length > 0 %}-a "{{ redis_password }}"{% endif %}
      INFO replication
  register: repl_info_before
  changed_when: false
  no_log: true

- name: Display current replication status
  ansible.builtin.debug:
    msg: "Current role: {{ 'master' if 'role:master' in repl_info_before.stdout else 'slave' }}"

# ============================================================================
# Configure as Replica
# ============================================================================
- name: Configure Redis as replica
  when: redis_replication_mode == "replica"
  block:
    - name: Verify master host is specified
      ansible.builtin.fail:
        msg: "redis_master_host must be set when configuring as replica"
      when: redis_master_host | default('') | length == 0

    - name: Configure REPLICAOF setting
      ansible.builtin.lineinfile:
        path: "{{ redis_config_file }}"
        regexp: "^replicaof "
        line: "replicaof {{ redis_master_host }} {{ redis_master_port }}"
        state: present
      notify: restart redis for replication

    - name: Configure master auth if password set
      ansible.builtin.lineinfile:
        path: "{{ redis_config_file }}"
        regexp: "^masterauth "
        line: "masterauth {{ redis_master_auth }}"
        state: present
      when: redis_master_auth | default('') | length > 0
      notify: restart redis for replication

    - name: Configure replica read-only mode
      ansible.builtin.lineinfile:
        path: "{{ redis_config_file }}"
        regexp: "^replica-read-only "
        line: "replica-read-only {{ 'yes' if redis_replica_read_only else 'no' }}"
        state: present
      notify: restart redis for replication

    - name: Configure replica priority
      ansible.builtin.lineinfile:
        path: "{{ redis_config_file }}"
        regexp: "^replica-priority "
        line: "replica-priority {{ redis_replica_priority }}"
        state: present
      notify: restart redis for replication

    - name: Configure replica serve stale data
      ansible.builtin.lineinfile:
        path: "{{ redis_config_file }}"
        regexp: "^replica-serve-stale-data "
        line: "replica-serve-stale-data {{ 'yes' if redis_replica_serve_stale_data else 'no' }}"
        state: present
      notify: restart redis for replication

    - name: Configure diskless sync
      ansible.builtin.lineinfile:
        path: "{{ redis_config_file }}"
        regexp: "^repl-diskless-sync "
        line: "repl-diskless-sync {{ 'yes' if redis_repl_diskless_sync else 'no' }}"
        state: present
      notify: restart redis for replication

# ============================================================================
# Configure as Primary (remove replica config)
# ============================================================================
- name: Configure Redis as primary
  when: redis_replication_mode == "primary"
  block:
    - name: Remove REPLICAOF setting (become primary)
      ansible.builtin.lineinfile:
        path: "{{ redis_config_file }}"
        regexp: "^replicaof "
        state: absent
      notify: restart redis for replication

    - name: Remove masterauth setting
      ansible.builtin.lineinfile:
        path: "{{ redis_config_file }}"
        regexp: "^masterauth "
        state: absent
      notify: restart redis for replication

    - name: Configure min replicas to write
      ansible.builtin.lineinfile:
        path: "{{ redis_config_file }}"
        regexp: "^min-replicas-to-write "
        line: "min-replicas-to-write {{ redis_min_replicas_to_write }}"
        state: present
      when: redis_min_replicas_to_write > 0
      notify: restart redis for replication

    - name: Configure min replicas max lag
      ansible.builtin.lineinfile:
        path: "{{ redis_config_file }}"
        regexp: "^min-replicas-max-lag "
        line: "min-replicas-max-lag {{ redis_min_replicas_max_lag }}"
        state: present
      when: redis_min_replicas_to_write > 0
      notify: restart redis for replication

# ============================================================================
# Flush handlers and verify
# ============================================================================
- name: Flush handlers
  ansible.builtin.meta: flush_handlers

- name: Wait for Redis to be ready after reconfiguration
  ansible.builtin.wait_for:
    port: "{{ redis_port }}"
    delay: 2
    timeout: 30

- name: Get new replication info
  ansible.builtin.command:
    cmd: >
      redis-cli
      {% if redis_password | default('') | length > 0 %}-a "{{ redis_password }}"{% endif %}
      INFO replication
  register: repl_info_after
  changed_when: false
  no_log: true

- name: Display new replication status
  ansible.builtin.debug:
    msg: |
      Replication mode: {{ redis_replication_mode }}
      {% if redis_replication_mode == 'replica' %}
      Master: {{ redis_master_host }}:{{ redis_master_port }}
      {% endif %}
      Status: {{ 'master' if 'role:master' in repl_info_after.stdout else 'slave' }}

- name: Verify replica is connected to master
  ansible.builtin.assert:
    that:
      - "'master_link_status:up' in repl_info_after.stdout"
    fail_msg: "Replica failed to connect to master"
    success_msg: "Replica successfully connected to master"
  when: redis_replication_mode == "replica"
