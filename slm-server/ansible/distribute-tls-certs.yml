# AutoBot - AI-Powered Automation Platform
# Copyright (c) 2025 mrveiss
# Author: mrveiss
#
# TLS Certificate Distribution Playbook (Issue #725)
# Distributes client certificates to nodes for mTLS authentication
#
# Usage:
#   ansible-playbook -i inventory.yml distribute-tls-certs.yml -e "target_host=vm1"
#   ansible-playbook -i inventory.yml distribute-tls-certs.yml --limit "frontend,backend"
#
# Environment variables:
#   AUTOBOT_TLS_CERT_DIR - Local certificate directory (default: certs)
#   AUTOBOT_TLS_REMOTE_CERT_DIR - Remote certificate directory (default: /etc/autobot/certs)
---
- name: Distribute TLS Client Certificates
  hosts: "{{ target_host | default('all') }}"
  become: true
  gather_facts: true

  vars:
    # Certificate paths
    local_cert_dir: "{{ lookup('env', 'AUTOBOT_TLS_CERT_DIR') | default('certs', true) }}"
    remote_cert_dir: "{{ lookup('env', 'AUTOBOT_TLS_REMOTE_CERT_DIR') | default('/etc/autobot/certs', true) }}"

    # Node-specific certificate directory (use hostname or custom name)
    node_cert_name: "{{ tls_cert_name | default(inventory_hostname) }}"

    # Certificate file names
    ca_cert: "ca-cert.pem"
    client_cert: "server-cert.pem"
    client_key: "server-key.pem"

    # Service user for certificate ownership
    cert_owner: "{{ tls_cert_owner | default('root') }}"
    cert_group: "{{ tls_cert_group | default('root') }}"

  tasks:
    # ===== Pre-flight checks =====
    - name: Check if CA certificate exists locally
      ansible.builtin.stat:
        path: "{{ local_cert_dir }}/ca/{{ ca_cert }}"
      delegate_to: localhost
      become: false
      register: local_ca_cert

    - name: Check if node certificate exists locally
      ansible.builtin.stat:
        path: "{{ local_cert_dir }}/{{ node_cert_name }}/{{ client_cert }}"
      delegate_to: localhost
      become: false
      register: local_node_cert

    - name: Fail if certificates not found
      ansible.builtin.fail:
        msg: |
          TLS certificates not found for {{ node_cert_name }}.
          Expected paths:
            - {{ local_cert_dir }}/ca/{{ ca_cert }}
            - {{ local_cert_dir }}/{{ node_cert_name }}/{{ client_cert }}
            - {{ local_cert_dir }}/{{ node_cert_name }}/{{ client_key }}

          Generate certificates first using:
            python -c "from src.pki import setup_pki; import asyncio; asyncio.run(setup_pki())"
      when: not (local_ca_cert.stat.exists | default(false) and local_node_cert.stat.exists | default(false))

    # ===== Create directory structure =====
    - name: Create certificate directory
      ansible.builtin.file:
        path: "{{ remote_cert_dir }}"
        state: directory
        mode: "0755"
        owner: "{{ cert_owner }}"
        group: "{{ cert_group }}"

    # ===== Distribute certificates =====
    - name: Copy CA certificate
      ansible.builtin.copy:
        src: "{{ local_cert_dir }}/ca/{{ ca_cert }}"
        dest: "{{ remote_cert_dir }}/{{ ca_cert }}"
        mode: "0644"
        owner: "{{ cert_owner }}"
        group: "{{ cert_group }}"

    - name: Copy client certificate
      ansible.builtin.copy:
        src: "{{ local_cert_dir }}/{{ node_cert_name }}/{{ client_cert }}"
        dest: "{{ remote_cert_dir }}/{{ client_cert }}"
        mode: "0644"
        owner: "{{ cert_owner }}"
        group: "{{ cert_group }}"

    - name: Copy client private key
      ansible.builtin.copy:
        src: "{{ local_cert_dir }}/{{ node_cert_name }}/{{ client_key }}"
        dest: "{{ remote_cert_dir }}/{{ client_key }}"
        mode: "0600"
        owner: "{{ cert_owner }}"
        group: "{{ cert_group }}"

    # ===== Verification =====
    - name: Verify certificate chain
      ansible.builtin.command:
        cmd: >-
          openssl verify -CAfile {{ remote_cert_dir }}/{{ ca_cert }}
          {{ remote_cert_dir }}/{{ client_cert }}
      register: cert_verify
      changed_when: false
      failed_when: "'OK' not in cert_verify.stdout"

    - name: Get certificate details
      ansible.builtin.shell:
        cmd: |
          echo "Subject: $(openssl x509 -in {{ remote_cert_dir }}/{{ client_cert }} -noout -subject)"
          echo "Issuer: $(openssl x509 -in {{ remote_cert_dir }}/{{ client_cert }} -noout -issuer)"
          echo "Expires: $(openssl x509 -in {{ remote_cert_dir }}/{{ client_cert }} -noout -enddate)"
      register: cert_details
      changed_when: false

    - name: Report certificate deployment
      ansible.builtin.debug:
        msg: |
          ============================================
          TLS CERTIFICATE DEPLOYMENT - {{ inventory_hostname }}
          ============================================
          Node certificate name: {{ node_cert_name }}
          Remote directory: {{ remote_cert_dir }}
          Verification: {{ cert_verify.stdout }}

          Certificate Details:
          {{ cert_details.stdout }}
          ============================================


# ===== Fleet-wide distribution =====
- name: TLS Distribution Summary
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Display fleet summary
      ansible.builtin.debug:
        msg: |
          TLS certificate distribution complete.

          To verify connectivity, run:
            ansible-playbook -i inventory.yml health-check.yml -e "check_tls_certs=true"
