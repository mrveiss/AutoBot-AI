# Docker Compose for AutoBot with Host Networking
# Uses --net=host for direct localhost connectivity between containers and host
# Eliminates the need for port mapping and proxy configuration

name: autobot

services:
  # Redis Stack with host networking
  autobot-redis:
    image: redis/redis-stack:7.4.0-v1
    container_name: autobot-redis
    restart: unless-stopped
    network_mode: "host"  # Use host networking
    volumes:
      - autobot_redis_data:/data
    environment:
      - REDIS_ARGS=--appendonly yes --save 60 1
      - REDISINSIGHT_PORT=8002
    healthcheck:
      test: ["CMD", "redis-cli", "-p", "6379", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - "autobot.service=redis"
      - "autobot.network=host"

  # AI Stack Container with host networking
  autobot-ai-stack:
    build:
      context: .
      dockerfile: docker/ai-stack/Dockerfile
    container_name: autobot-ai-stack
    restart: unless-stopped
    network_mode: "host"  # Use host networking
    depends_on:
      autobot-redis:
        condition: service_healthy
    volumes:
      # Centralized data volumes
      - ../volumes/prompts:/app/prompts:ro
      - ../volumes/knowledge_base:/app/knowledge_base:ro
      - ../volumes/models:/app/models
      - ../volumes/config:/app/config:ro
      # Container-specific volumes
      - autobot_ai_data:/app/data
      - autobot_ai_logs:/app/logs
      - ../../src:/app/src:ro
    environment:
      - AI_SERVER_HOST=127.0.0.1  # Use localhost with host networking
      - AI_SERVER_PORT=8080
      - AI_SERVER_WORKERS=1
      - REDIS_HOST=127.0.0.1      # Connect to Redis via localhost
      - REDIS_PORT=6379
      - OLLAMA_HOST=127.0.0.1:11434
      - CHROMA_DB_PATH=/app/data/chroma_db
      - DISABLE_EXTERNAL_APIS=true
      - PYTHONPATH=/app:/app/src
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - "autobot.service=ai-stack"
      - "autobot.network=host"

  # NPU Worker with host networking
  autobot-npu-worker:
    build:
      context: ../..
      dockerfile: docker/npu-worker/Dockerfile.npu-worker-simple-worker
    container_name: autobot-npu-worker
    restart: unless-stopped
    network_mode: "host"  # Use host networking
    depends_on:
      autobot-redis:
        condition: service_healthy
    volumes:
      - ../volumes/prompts:/app/prompts:ro
      - ../volumes/knowledge_base:/app/knowledge_base:ro
      - ../volumes/models:/app/models
      - ../volumes/config:/app/config:ro
      - autobot_npu_logs:/app/logs
      - ../../src:/app/src:ro
      # Hardware access for NPU
      - /dev:/dev:ro
      - /lib/firmware:/lib/firmware:ro
      - /usr/local/lib:/usr/local/lib:ro
    environment:
      - NPU_WORKER_HOST=127.0.0.1  # Use localhost with host networking
      - NPU_WORKER_PORT=8081
      - NPU_WORKER_WORKERS=1
      - REDIS_HOST=127.0.0.1       # Connect to Redis via localhost
      - REDIS_PORT=6379
      - NPU_LOG_LEVEL=INFO
      - OPENVINO_DEVICE=AUTO
      - OV_LOG_LEVEL=ERROR
      - PYTHONPATH=/app:/app/src
      - LD_LIBRARY_PATH=/usr/local/lib:/usr/lib/x86_64-linux-gnu:/usr/local/lib/python3.10
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:8081/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    privileged: true
    # GPU support (if available)
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    runtime: nvidia
    labels:
      - "autobot.service=npu-worker"
      - "autobot.network=host"

  # Seq centralized logging with host networking
  autobot-seq:
    image: datalust/seq:latest
    container_name: autobot-seq
    restart: unless-stopped
    network_mode: "host"  # Use host networking
    volumes:
      - autobot_seq_data:/data
    environment:
      - ACCEPT_EULA=Y
      - SEQ_FIRSTRUN_ADMINUSERNAME=admin
      - SEQ_FIRSTRUN_ADMINPASSWORD=${AUTOBOT_SEQ_ADMIN_PASSWORD}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:5341/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    labels:
      - "autobot.service=seq"
      - "autobot.logging=centralized"
      - "autobot.network=host"

volumes:
  autobot_redis_data:
    name: autobot_redis_data
  autobot_ai_data:
    name: autobot_ai_data
  autobot_ai_logs:
    name: autobot_ai_logs
  autobot_npu_logs:
    name: autobot_npu_logs
  autobot_seq_data:
    name: autobot_seq_data

# Note: Host networking eliminates the need for custom networks
# All containers can communicate via localhost (127.0.0.1)