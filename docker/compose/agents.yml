# AutoBot Agent Services
# All AI agent containers using standardized base image
# Eliminates duplicate agent service definitions

version: '3.8'

# Shared configuration for all agents (eliminates duplicate patterns)
x-agent-base: &agent-base
  build:
    context: ../../
    dockerfile: docker/base/Dockerfile.python-agent
    args:
      USER_ID: ${USER_ID:-1000}
      GROUP_ID: ${GROUP_ID:-1000}
  restart: unless-stopped
  volumes:
    # Centralized data volumes (consistent across all agents)
    - ${VOLUMES_DIR:-./docker/volumes}/prompts:/app/prompts:ro
    - ${VOLUMES_DIR:-./docker/volumes}/knowledge_base:/app/knowledge_base:ro
    - ${VOLUMES_DIR:-./docker/volumes}/models:/app/models
    - ${VOLUMES_DIR:-./docker/volumes}/config:/app/config:ro
    # Agent-specific data
    - autobot_agent_logs:/app/logs
  env_file:
    - ${ENV_DIR:-./docker/env}/common.env
    - ${ENV_DIR:-./docker/env}/redis.env
    - ${ENV_DIR:-./docker/env}/agents.env
  networks:
    - autobot
  depends_on:
    autobot-redis:
      condition: service_healthy
  deploy:
    resources:
      limits:
        memory: ${AGENT_MEMORY_LIMIT:-1G}
        cpus: '${AGENT_CPU_LIMIT:-1.0}'

services:
  # Chat Agent (lightweight, fast responses)
  autobot-chat-agent:
    <<: *agent-base
    container_name: autobot-chat-agent
    build:
      context: ../../
      dockerfile: docker/agents/Dockerfile.chat-agent
      args:
        USER_ID: ${USER_ID:-1000}
        GROUP_ID: ${GROUP_ID:-1000}
    ports:
      - "${CHAT_AGENT_PORT:-8001}:8000"
    environment:
      - AGENT_TYPE=chat
      - HEALTH_CHECK_PORT=8000
      - DEFAULT_MODEL_NAME=${CHAT_MODEL:-llama3.2:1b}
    volumes:
      - autobot_chat_data:/app/data
      - autobot_chat_logs:/app/logs
    command: ["python", "src/agents/chat_agent_server.py"]

  # RAG Agent (document processing and retrieval)
  autobot-rag-agent:
    <<: *agent-base
    container_name: autobot-rag-agent
    build:
      context: ../../
      dockerfile: docker/agents/Dockerfile.rag-agent
      args:
        USER_ID: ${USER_ID:-1000}
        GROUP_ID: ${GROUP_ID:-1000}
    ports:
      - "${RAG_AGENT_PORT:-8002}:8000"
    environment:
      - AGENT_TYPE=rag
      - HEALTH_CHECK_PORT=8000
      - DEFAULT_MODEL_NAME=${RAG_MODEL:-dolphin-llama3:8b}
      - VECTOR_DB_TYPE=chroma
    volumes:
      - autobot_rag_data:/app/data
      - autobot_rag_logs:/app/logs
    command: ["python", "src/agents/rag_agent_server.py"]

  # NPU Code Search Agent (high-performance code analysis)
  autobot-npu-agent:
    <<: *agent-base
    container_name: autobot-npu-agent
    build:
      context: ../../
      dockerfile: docker/agents/Dockerfile.npu-agent
      args:
        USER_ID: ${USER_ID:-1000}
        GROUP_ID: ${GROUP_ID:-1000}
    ports:
      - "${NPU_AGENT_PORT:-8003}:8000"
    environment:
      - AGENT_TYPE=npu_code_search
      - HEALTH_CHECK_PORT=8000
      - OPENVINO_DEVICE=AUTO
      - NPU_ACCELERATION_ENABLED=true
    volumes:
      - autobot_npu_data:/app/data
      - autobot_npu_logs:/app/logs
      # NPU device access
      - /dev:/dev:ro
      - /lib/firmware:/lib/firmware:ro
    privileged: true  # Required for NPU access
    command: ["python", "src/agents/npu_code_search_agent_server.py"]

  # Research Agent (web research and analysis)
  autobot-research-agent:
    <<: *agent-base
    container_name: autobot-research-agent
    build:
      context: ../../
      dockerfile: docker/agents/Dockerfile.research-agent
      args:
        USER_ID: ${USER_ID:-1000}
        GROUP_ID: ${GROUP_ID:-1000}
    ports:
      - "${RESEARCH_AGENT_PORT:-8004}:8000"
    environment:
      - AGENT_TYPE=research
      - HEALTH_CHECK_PORT=8000
      - DEFAULT_MODEL_NAME=${RESEARCH_MODEL:-dolphin-llama3:8b}
      - WEB_SEARCH_ENABLED=true
    volumes:
      - autobot_research_data:/app/data
      - autobot_research_logs:/app/logs
    command: ["python", "src/agents/research_agent_server.py"]

  # Knowledge Agent (knowledge base management)
  autobot-knowledge-agent:
    <<: *agent-base
    container_name: autobot-knowledge-agent
    build:
      context: ../../
      dockerfile: docker/agents/Dockerfile.knowledge-agent
      args:
        USER_ID: ${USER_ID:-1000}
        GROUP_ID: ${GROUP_ID:-1000}
    ports:
      - "${KNOWLEDGE_AGENT_PORT:-8005}:8000"
    environment:
      - AGENT_TYPE=knowledge
      - HEALTH_CHECK_PORT=8000
      - KNOWLEDGE_BASE_INDEX_ON_STARTUP=true
      - LOAD_KNOWLEDGE_BASE=true
    volumes:
      - autobot_knowledge_data:/app/data
      - autobot_knowledge_logs:/app/logs
    command: ["python", "src/agents/knowledge_agent_server.py"]

# Agent-specific volumes
volumes:
  autobot_agent_logs:
    name: autobot_agent_logs
  autobot_chat_data:
    name: autobot_chat_data
  autobot_chat_logs:
    name: autobot_chat_logs
  autobot_rag_data:
    name: autobot_rag_data
  autobot_rag_logs:
    name: autobot_rag_logs
  autobot_npu_data:
    name: autobot_npu_data
  autobot_npu_logs:
    name: autobot_npu_logs
  autobot_research_data:
    name: autobot_research_data
  autobot_research_logs:
    name: autobot_research_logs
  autobot_knowledge_data:
    name: autobot_knowledge_data
  autobot_knowledge_logs:
    name: autobot_knowledge_logs

networks:
  autobot:
    external: true
    name: autobot-network
