# Docker Compose with Read-Only Model Sharing
# Containers can use models but cannot delete them

name: autobot

services:
  # Ollama container with READ-ONLY model access
  autobot-ollama-readonly:
    image: ollama/ollama:latest
    container_name: autobot-ollama-readonly
    restart: unless-stopped
    ports:
      - "${AUTOBOT_OLLAMA_PORT:-11434}:11434"
    volumes:
      # Mount models as READ-ONLY (ro flag)
      - ${AUTOBOT_OLLAMA_MODELS_PATH:-$HOME/.ollama}:/root/.ollama:ro
      # Create writable overlay for runtime needs
      - ollama_runtime:/tmp/ollama
    environment:
      - OLLAMA_HOST=0.0.0.0
      - OLLAMA_ORIGINS=*
      # Prevent model modifications
      - OLLAMA_MODELS_READONLY=true
    networks:
      - autobot-network
    # Override entrypoint to handle read-only models
    entrypoint: >
      sh -c "
        # Create symbolic links for writable areas
        mkdir -p /tmp/ollama/logs /tmp/ollama/tmp
        ln -sf /tmp/ollama/logs /root/.ollama/logs
        ln -sf /tmp/ollama/tmp /root/.ollama/tmp

        # Start Ollama
        exec ollama serve
      "

  # Your other services remain the same...
  autobot-redis:
    image: redis/redis-stack:7.4.0-v1
    container_name: autobot-redis
    restart: unless-stopped
    ports:
      - "${AUTOBOT_REDIS_PORT:-6379}:6379"
    volumes:
      - autobot_redis_data:/data
    networks:
      - autobot-network

networks:
  autobot-network:
    driver: bridge

volumes:
  autobot_redis_data:
  ollama_runtime:  # Writable area for Ollama runtime
