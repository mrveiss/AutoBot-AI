# AutoBot NPU Code Search Agent
# Extends standardized Python agent base image
# Optimized for high-performance code analysis with NPU acceleration

# Use standardized Python agent base
FROM python-agent-base:latest AS npu-agent

# Agent-specific metadata
LABEL maintainer="AutoBot Team"
LABEL description="AutoBot NPU Agent - High-performance code search with NPU acceleration"
LABEL agent.type="npu_code_search"
LABEL agent.capabilities="code_analysis,semantic_search,npu_acceleration,pattern_detection"

# NPU agent specific configuration
ENV AGENT_TYPE=npu_code_search \
    AGENT_NAME="AutoBot NPU Code Search Agent" \
    AGENT_DESCRIPTION="High-performance code analysis agent with NPU acceleration" \
    OPENVINO_DEVICE=AUTO \
    NPU_ACCELERATION_ENABLED=true \
    CODE_SEARCH_CACHE_SIZE=1000 \
    SEMANTIC_SIMILARITY_THRESHOLD=0.8 \
    CODE_INDEXING_BATCH_SIZE=50

# NPU agent specific dependencies
RUN pip install --no-cache-dir \
    openvino==2023.2.0 \
    torch==2.1.0 \
    transformers==4.35.0 \
    sentence-transformers==2.2.2 \
    numpy==1.24.3 \
    scipy==1.11.4 \
    scikit-learn==1.3.2 \
    tree-sitter==0.20.2 \
    tree-sitter-python==0.20.4

# Install Intel OpenVINO for NPU support
RUN wget -qO- https://apt.repos.intel.com/intel-gpg-keys/GPG-PUB-KEY-INTEL-SW-PRODUCTS.PUB | \
    gpg --dearmor --output /usr/share/keyrings/intel-sw-products.gpg && \
    echo "deb [arch=amd64 signed-by=/usr/share/keyrings/intel-sw-products.gpg] https://apt.repos.intel.com/openvino/2023 ubuntu20 main" | \
    tee /etc/apt/sources.list.d/intel-openvino-2023.list && \
    apt-get update && \
    apt-get install -y openvino-2023.2.0 && \
    rm -rf /var/lib/apt/lists/*

# Create code index and cache directories
RUN mkdir -p /app/data/code_index /app/data/npu_cache && \
    chown -R ${USER_ID}:${GROUP_ID} /app/data/code_index /app/data/npu_cache

# Agent-specific health check (includes NPU device check)
ENV HEALTH_CHECK_PORT=8000
HEALTHCHECK --interval=30s --timeout=15s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:${HEALTH_CHECK_PORT}/health/npu || exit 1

# NPU agent startup command
CMD ["python", "src/agents/npu_code_search_agent_server.py"]
