# AutoBot Knowledge Agent
# Extends standardized Python agent base image
# Optimized for knowledge base management and indexing

# Use standardized Python agent base
FROM python-agent-base:latest AS knowledge-agent

# Agent-specific metadata
LABEL maintainer="AutoBot Team"
LABEL description="AutoBot Knowledge Agent - Knowledge base management and indexing"
LABEL agent.type="knowledge"
LABEL agent.capabilities="knowledge_management,document_indexing,knowledge_retrieval,auto_learning"

# Knowledge agent specific configuration
ENV AGENT_TYPE=knowledge \
    AGENT_NAME="AutoBot Knowledge Agent" \
    AGENT_DESCRIPTION="Knowledge base management and indexing agent" \
    KNOWLEDGE_BASE_INDEX_ON_STARTUP=true \
    LOAD_KNOWLEDGE_BASE=true \
    AUTO_INDEX_ENABLED=true \
    KNOWLEDGE_TTL=86400 \
    INDEX_BATCH_SIZE=100 \
    SEARCH_RESULTS_LIMIT=20

# Knowledge agent specific dependencies
RUN pip install --no-cache-dir \
    sqlalchemy==2.0.23 \
    alembic==1.12.1 \
    whoosh==2.7.4 \
    elasticsearch==8.11.0 \
    pymongo==4.6.0 \
    neo4j==5.14.1 \
    networkx==3.2.1 \
    pytz==2023.3 \
    dateparser==1.2.0

# Create knowledge base directories
RUN mkdir -p /app/data/knowledge_base /app/data/indexes /app/data/graphs && \
    chown -R ${USER_ID}:${GROUP_ID} /app/data/knowledge_base /app/data/indexes /app/data/graphs

# Initialize knowledge base schema (if using SQLite)
RUN touch /app/data/knowledge_base/knowledge.db && \
    chown ${USER_ID}:${GROUP_ID} /app/data/knowledge_base/knowledge.db

# Agent-specific health check (includes knowledge base connectivity)
# Use configurable port that defaults to backend API port
ENV HEALTH_CHECK_PORT=${AUTOBOT_BACKEND_PORT:-8001}
HEALTHCHECK --interval=30s --timeout=10s --start-period=45s --retries=3 \
    CMD curl -f http://localhost:${HEALTH_CHECK_PORT}/health/knowledge || exit 1

# Knowledge agent startup command
CMD ["python", "src/agents/knowledge_agent_server.py"]
