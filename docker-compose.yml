# Unified Docker Compose for AutoBot
# This file consolidates all service configurations with environment-based overrides

name: autobot

services:
  # Redis Stack - Core data store
  redis:
    image: redis/redis-stack:7.4.0-v1
    container_name: autobot-redis
    restart: unless-stopped
    volumes:
      - redis_data:/data
    environment:
      - REDIS_ARGS=--appendonly yes --save 60 1
      - REDISINSIGHT_PORT=${REDISINSIGHT_PORT:-8002}
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - autobot
    ports:
      - "${REDIS_PORT:-6379}:6379"
      - "${REDISINSIGHT_PORT:-8002}:8001"

  # Seq - Centralized logging
  seq:
    image: datalust/seq:latest
    container_name: autobot-seq
    restart: unless-stopped
    volumes:
      - seq_data:/data
    environment:
      - ACCEPT_EULA=Y
      - SEQ_FIRSTRUN_ADMINUSERNAME=${SEQ_ADMIN_USER:-admin}
      - SEQ_FIRSTRUN_ADMINPASSWORD=${SEQ_ADMIN_PASSWORD:-autobot123}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - autobot
    ports:
      - "${SEQ_PORT:-5341}:80"

  # Backend API - Runs on HOST for system access (desktop, network, files)
  # Started by unified script, not Docker

  # Browser Automation Service - Containerized for dependency management
  browser-service:
    build:
      context: .
      dockerfile: docker/browser/Dockerfile
    image: autobot-browser:latest
    container_name: autobot-browser
    restart: unless-stopped
    volumes:
      - ./scripts:/app/scripts
      - browser_data:/app/data
    environment:
      - PLAYWRIGHT_BROWSERS_PATH=/root/.cache/ms-playwright
      - BROWSER_PORT=${BROWSER_PORT:-3000}
    command: node /app/playwright-server.js
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    networks:
      - autobot
    ports:
      - "${BROWSER_PORT:-3000}:3000"

  # Frontend - Remove invalid backend dependency since backend runs on host
  frontend:
    build:
      context: ./autobot-vue
      dockerfile: ../docker/frontend/Dockerfile
      args:
        - NODE_VERSION=${NODE_VERSION:-20}
    image: autobot-frontend:latest
    container_name: autobot-frontend
    restart: unless-stopped
    depends_on:
      - redis
    volumes:
      - ./autobot-vue:/app
      - /app/node_modules  # Anonymous volume for node_modules
    environment:
      - VITE_API_URL=${VITE_API_URL:-http://localhost:8001}
      - NODE_ENV=${NODE_ENV:-production}
    command: ${FRONTEND_COMMAND:-npm run preview -- --host 0.0.0.0}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5173/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - autobot
    ports:
      - "${FRONTEND_PORT:-5173}:5173"

  # AI Stack Service
  ai-stack:
    build:
      context: .
      dockerfile: docker/Dockerfile.ai-stack
    image: autobot-ai-stack:latest
    container_name: autobot-ai-stack
    restart: unless-stopped
    depends_on:
      redis:
        condition: service_healthy
      seq:
        condition: service_healthy
    volumes:
      - ./src:/app/src
      - ./config:/app/config
      - ./data:/app/data
      - ./prompts:/app/prompts
      - models:/app/models
      - ai_logs:/app/logs
    environment:
      - PYTHONPATH=/app
      - AI_SERVER_HOST=0.0.0.0
      - AI_SERVER_PORT=${AI_SERVER_PORT:-8080}
      - AI_SERVER_WORKERS=1
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - SEQ_URL=${SEQ_URL:-http://seq:80}
      - OLLAMA_HOST=${OLLAMA_HOST:-127.0.0.1:11434}
      - CHROMA_DB_PATH=/app/data/chroma_db
      - DISABLE_EXTERNAL_APIS=${DISABLE_EXTERNAL_APIS:-true}
    command: python -m uvicorn src.ai_server:app --host 0.0.0.0 --port ${AI_SERVER_PORT:-8080}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${AI_SERVER_PORT:-8080}/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - autobot
    ports:
      - "${AI_SERVER_PORT:-8080}:${AI_SERVER_PORT:-8080}"

  # NPU Worker Service  
  npu-worker:
    build:
      context: .
      dockerfile: docker/npu-worker/Dockerfile.npu-worker-simple-worker
    image: autobot-npu-worker:latest
    container_name: autobot-npu-worker
    restart: unless-stopped
    depends_on:
      redis:
        condition: service_healthy
    volumes:
      - ./src:/app/src
      - ./config:/app/config
      - ./prompts:/app/prompts
      - models:/app/models
      - npu_logs:/app/logs
      # Hardware access for NPU
      - /dev:/dev:ro
      - /lib/firmware:/lib/firmware:ro
      - /usr/local/lib:/usr/local/lib:ro
    environment:
      - PYTHONPATH=/app
      - NPU_WORKER_HOST=0.0.0.0
      - NPU_WORKER_PORT=${NPU_WORKER_PORT:-8081}
      - NPU_WORKER_WORKERS=1
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - NPU_LOG_LEVEL=${NPU_LOG_LEVEL:-INFO}
      - OPENVINO_DEVICE=${OPENVINO_DEVICE:-AUTO}
      - OV_LOG_LEVEL=${OV_LOG_LEVEL:-ERROR}
      - LD_LIBRARY_PATH=/usr/local/lib:/usr/lib/x86_64-linux-gnu:/usr/local/lib/python3.10
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
    privileged: true
    # GPU support (if available)
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    runtime: nvidia
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${NPU_WORKER_PORT:-8081}/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - autobot
    ports:
      - "${NPU_WORKER_PORT:-8081}:${NPU_WORKER_PORT:-8081}"

volumes:
  redis_data:
    name: autobot_redis_data
  seq_data:
    name: autobot_seq_data
  models:
    name: autobot_models
  browser_data:
    name: autobot_browser_data
  ai_logs:
    name: autobot_ai_logs
  npu_logs:
    name: autobot_npu_logs

networks:
  autobot:
    name: autobot-network
    driver: bridge
    ipam:
      config:
        - subnet: ${DOCKER_SUBNET:-172.18.0.0/16}