#!/bin/bash
# AutoBot - AI-Powered Automation Platform
# Copyright (c) 2025 mrveiss
# Author: mrveiss
#
# Post-commit hook for automatic documentation indexing
# Issue #250: Enable Chat Agent Self-Awareness
#
# This hook automatically triggers incremental documentation indexing
# when markdown files in the docs/ directory are modified.

set -e

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Get the project root directory
PROJECT_ROOT="$(git rev-parse --show-toplevel)"

# Check if any documentation files were changed in the last commit
CHANGED_DOCS=$(git diff-tree --no-commit-id --name-only -r HEAD | grep -E '^(docs/.*\.md|CLAUDE\.md)$' || true)

if [ -z "$CHANGED_DOCS" ]; then
    # No documentation changes, skip indexing
    exit 0
fi

# Count changed documentation files
DOC_COUNT=$(echo "$CHANGED_DOCS" | wc -l)

echo ""
echo -e "${CYAN}ðŸ“š AutoBot Documentation Sync (Issue #250)${NC}"
echo "=================================================="
echo -e "${YELLOW}Detected $DOC_COUNT documentation file(s) changed:${NC}"
echo "$CHANGED_DOCS" | head -5 | sed 's/^/  â€¢ /'
if [ "$DOC_COUNT" -gt 5 ]; then
    echo "  ... and $((DOC_COUNT - 5)) more"
fi
echo ""

# Check if the indexing script exists
INDEX_SCRIPT="$PROJECT_ROOT/tools/index_documentation.py"
if [ ! -f "$INDEX_SCRIPT" ]; then
    echo -e "${YELLOW}âš ï¸ Documentation indexer not found, skipping sync${NC}"
    exit 0
fi

# Check if we're in a virtual environment or can find Python
PYTHON_CMD=""
if [ -n "$VIRTUAL_ENV" ]; then
    PYTHON_CMD="$VIRTUAL_ENV/bin/python"
elif [ -f "$PROJECT_ROOT/venv/bin/python" ]; then
    PYTHON_CMD="$PROJECT_ROOT/venv/bin/python"
elif command -v python3 &> /dev/null; then
    PYTHON_CMD="python3"
elif command -v python &> /dev/null; then
    PYTHON_CMD="python"
else
    echo -e "${YELLOW}âš ï¸ Python not found, skipping documentation sync${NC}"
    exit 0
fi

# Run incremental indexing in the background (non-blocking)
# This ensures the commit completes quickly while indexing happens asynchronously
echo -e "${GREEN}ðŸ”„ Triggering incremental documentation indexing...${NC}"

# Create a log file for the background process
LOG_FILE="$PROJECT_ROOT/logs/doc_index_$(date +%Y%m%d_%H%M%S).log"
mkdir -p "$PROJECT_ROOT/logs"

# Run in background with nohup to prevent blocking
nohup "$PYTHON_CMD" "$INDEX_SCRIPT" --incremental > "$LOG_FILE" 2>&1 &
BG_PID=$!

echo -e "${GREEN}âœ… Indexing started in background (PID: $BG_PID)${NC}"
echo -e "   Log: $LOG_FILE"
echo "=================================================="
echo ""

exit 0
