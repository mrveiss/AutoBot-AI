#!/bin/bash
# AutoBot - AI-Powered Automation Platform
# Copyright (c) 2025 mrveiss
# Author: mrveiss
#
# Pre-commit Hook: Hardcoded Value Detection (Strict Mode)
# =========================================================
#
# Blocks commits containing:
# - Hardcoded VM IPs (172.16.168.*)
# - Hardcoded infrastructure ports in URL context
# - Magic numbers that should use QueryDefaults constants
# - Hardcoded role/category strings
#
# Issue: #694 - Configuration Consolidation
#
# Install: ln -sf ../../scripts/hooks/pre-commit-hardcoded-values .git/hooks/pre-commit
# Or add to .pre-commit-config.yaml as local hook

set -uo pipefail

# Colors
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

VIOLATIONS=0
WARNINGS=0

# Get staged Python/TypeScript/Vue files (excluding tests and configs)
get_staged_files() {
    git diff --cached --name-only --diff-filter=ACM 2>/dev/null | \
        grep -E '\.(py|ts|vue)$' | \
        grep -v -E '(__pycache__|node_modules|\.venv|venv|archive|temp)' | \
        grep -v -E '(test_|_test\.py|\.test\.ts|\.spec\.ts)' | \
        grep -v -E '(ssot_config\.py|ssot-config\.ts|threshold_constants\.py)' | \
        grep -v -E '(constants/|config\.py$|\.env)' || true
}

# Check for hardcoded VM IPs
check_hardcoded_ips() {
    local file="$1"
    local line_num=0

    while IFS= read -r line; do
        ((line_num++))

        # Skip comments
        if [[ "$line" =~ ^[[:space:]]*# ]] || [[ "$line" =~ ^[[:space:]]*// ]] || [[ "$line" =~ ^[[:space:]]*\* ]]; then
            continue
        fi

        # Skip if using config/getenv
        if echo "$line" | grep -qE '(config\.|getenv|CONFIG\[|AUTOBOT_|ssot_config)'; then
            continue
        fi

        # Check for VM IPs
        if echo "$line" | grep -qE '172\.16\.168\.(19|2[0-5])'; then
            local ip
            ip=$(echo "$line" | grep -oE '172\.16\.168\.(19|2[0-5])')
            echo -e "${RED}VIOLATION${NC} $file:$line_num"
            echo "  Hardcoded VM IP: $ip"
            echo -e "  ${CYAN}Fix: Use config.vm.* from ssot_config${NC}"
            echo "  Line: ${line:0:80}"
            echo ""
            ((VIOLATIONS++))
        fi
    done < "$file"
}

# Check for hardcoded ports in URL context
check_hardcoded_ports() {
    local file="$1"
    local line_num=0

    # Infrastructure ports that should use SSOT
    local ports="8001|5173|6379|11434|6080|8080|8081|8082|3000"

    while IFS= read -r line; do
        ((line_num++))

        # Skip comments
        if [[ "$line" =~ ^[[:space:]]*# ]] || [[ "$line" =~ ^[[:space:]]*// ]]; then
            continue
        fi

        # Skip if using config/getenv
        if echo "$line" | grep -qE '(config\.|getenv|CONFIG\[|AUTOBOT_|NetworkConstants)'; then
            continue
        fi

        # Skip array slicing like [0:10] or [:5]
        if echo "$line" | grep -qE '\[[0-9]*:[0-9]*\]'; then
            continue
        fi

        # Check for ports in URL context (e.g., :8001/ or :8001" or :8001')
        if echo "$line" | grep -qE ":(${ports})[^0-9]"; then
            local port
            port=$(echo "$line" | grep -oE ":(${ports})" | head -1)
            echo -e "${RED}VIOLATION${NC} $file:$line_num"
            echo "  Hardcoded port: $port"
            echo -e "  ${CYAN}Fix: Use config.port.* from ssot_config${NC}"
            echo "  Line: ${line:0:80}"
            echo ""
            ((VIOLATIONS++))
        fi
    done < "$file"
}

# Check for magic numbers that should use QueryDefaults
check_magic_numbers() {
    local file="$1"
    local line_num=0

    while IFS= read -r line; do
        ((line_num++))

        # Skip comments
        if [[ "$line" =~ ^[[:space:]]*# ]] || [[ "$line" =~ ^[[:space:]]*// ]]; then
            continue
        fi

        # Skip imports and constants definitions
        if echo "$line" | grep -qE '(^from |^import |QueryDefaults\.|DEFAULT_|_LIMIT|_SIZE)'; then
            continue
        fi

        # Skip pure type hints (return type annotations like -> int)
        # But NOT function parameter defaults like limit: int = 10
        if echo "$line" | grep -qE '(-> int$|-> int:|List\[|Optional\[)'; then
            continue
        fi

        # Pattern 1: limit=10, limit: int = 10, default=10, Field(default=10) for limit/search context
        if echo "$line" | grep -qiE '(limit|top_k|max_results|page_size)[^a-z_].*=\s*10\b'; then
            echo -e "${RED}VIOLATION${NC} $file:$line_num"
            echo "  Magic number 10 in limit/search context"
            echo -e "  ${CYAN}Fix: Use QueryDefaults.DEFAULT_SEARCH_LIMIT${NC}"
            echo "  Line: ${line:0:80}"
            echo ""
            ((VIOLATIONS++))
            continue
        fi

        # Pattern 2: limit=50, page_size=50, Field(default=50)
        if echo "$line" | grep -qiE '(limit|page_size)[^a-z_].*=\s*50\b'; then
            echo -e "${RED}VIOLATION${NC} $file:$line_num"
            echo "  Magic number 50 in pagination context"
            echo -e "  ${CYAN}Fix: Use QueryDefaults.DEFAULT_PAGE_SIZE${NC}"
            echo "  Line: ${line:0:80}"
            echo ""
            ((VIOLATIONS++))
            continue
        fi

        # Pattern 3: limit=100 for knowledge/batch context
        if echo "$line" | grep -qiE '(limit|batch)[^a-z_].*=\s*100\b'; then
            echo -e "${RED}VIOLATION${NC} $file:$line_num"
            echo "  Magic number 100 in limit/batch context"
            echo -e "  ${CYAN}Fix: Use QueryDefaults.KNOWLEDGE_DEFAULT_LIMIT or BatchConfig.LARGE_BATCH${NC}"
            echo "  Line: ${line:0:80}"
            echo ""
            ((VIOLATIONS++))
            continue
        fi

        # Pattern 4: offset=0 (only if explicitly set, not just = 0 anywhere)
        if echo "$line" | grep -qiE 'offset[^a-z_]*[=:][^=]*\b0\b'; then
            # This is a warning, not a violation - offset=0 is common
            echo -e "${YELLOW}WARNING${NC} $file:$line_num"
            echo "  Consider using QueryDefaults.DEFAULT_OFFSET for consistency"
            echo "  Line: ${line:0:80}"
            echo ""
            ((WARNINGS++))
            continue
        fi

        # Pattern 5: max_results=5 for RAG context
        if echo "$line" | grep -qiE '(max_results|rag)[^a-z_]*[=:][^=]*\b5\b'; then
            echo -e "${RED}VIOLATION${NC} $file:$line_num"
            echo "  Magic number 5 in RAG/results context"
            echo -e "  ${CYAN}Fix: Use QueryDefaults.RAG_DEFAULT_RESULTS${NC}"
            echo "  Line: ${line:0:80}"
            echo ""
            ((VIOLATIONS++))
            continue
        fi
    done < "$file"
}

# Check for hardcoded role strings
check_hardcoded_roles() {
    local file="$1"
    local line_num=0

    while IFS= read -r line; do
        ((line_num++))

        # Skip comments
        if [[ "$line" =~ ^[[:space:]]*# ]] || [[ "$line" =~ ^[[:space:]]*// ]]; then
            continue
        fi

        # Skip if using CategoryDefaults
        if echo "$line" | grep -qE '(CategoryDefaults\.|ROLE_)'; then
            continue
        fi

        # Skip string definitions in constants files
        if echo "$line" | grep -qE '^[[:space:]]*(ROLE_|DEFAULT_).*='; then
            continue
        fi

        # Check for role="user" or role: "user" patterns (with quotes)
        if echo "$line" | grep -qE 'role[^a-z_]*[=:][^=]*["\x27](user|assistant|system)["\x27]'; then
            local role
            role=$(echo "$line" | grep -oE '["\x27](user|assistant|system)["\x27]' | head -1)
            echo -e "${RED}VIOLATION${NC} $file:$line_num"
            echo "  Hardcoded role string: $role"
            echo -e "  ${CYAN}Fix: Use CategoryDefaults.ROLE_USER/ROLE_ASSISTANT/ROLE_SYSTEM${NC}"
            echo "  Line: ${line:0:80}"
            echo ""
            ((VIOLATIONS++))
        fi
    done < "$file"
}

# Check for hardcoded category strings
check_hardcoded_categories() {
    local file="$1"
    local line_num=0

    while IFS= read -r line; do
        ((line_num++))

        # Skip comments
        if [[ "$line" =~ ^[[:space:]]*# ]] || [[ "$line" =~ ^[[:space:]]*// ]]; then
            continue
        fi

        # Skip if using CategoryDefaults
        if echo "$line" | grep -qE '(CategoryDefaults\.|GENERAL|UNKNOWN|SEARCH_MODE)'; then
            continue
        fi

        # Check for category="general" or mode="hybrid" patterns
        if echo "$line" | grep -qE '(category|search_mode|mode)[^a-z_]*[=:][^=]*["\x27](general|hybrid|unknown)["\x27]'; then
            local value
            value=$(echo "$line" | grep -oE '["\x27](general|hybrid|unknown)["\x27]' | head -1)
            echo -e "${RED}VIOLATION${NC} $file:$line_num"
            echo "  Hardcoded category/mode string: $value"
            echo -e "  ${CYAN}Fix: Use CategoryDefaults.GENERAL/SEARCH_MODE_HYBRID/UNKNOWN${NC}"
            echo "  Line: ${line:0:80}"
            echo ""
            ((VIOLATIONS++))
        fi
    done < "$file"
}

# Main execution
main() {
    echo -e "${BOLD}Pre-commit: Hardcoded Value Detection (Strict)${NC}"
    echo "Issue #694 - Configuration Consolidation"
    echo "================================================"
    echo ""

    local files
    files=$(get_staged_files)

    if [[ -z "$files" ]]; then
        echo -e "${GREEN}No Python/TypeScript/Vue files staged for commit.${NC}"
        exit 0
    fi

    local file_count
    file_count=$(echo "$files" | wc -l)
    echo "Scanning $file_count staged file(s)..."
    echo ""

    for file in $files; do
        if [[ -f "$file" ]]; then
            check_hardcoded_ips "$file"
            check_hardcoded_ports "$file"
            check_magic_numbers "$file"
            check_hardcoded_roles "$file"
            check_hardcoded_categories "$file"
        fi
    done

    echo "================================================"

    if [[ $VIOLATIONS -gt 0 ]]; then
        echo -e "${RED}COMMIT BLOCKED: $VIOLATIONS violation(s) found${NC}"
        if [[ $WARNINGS -gt 0 ]]; then
            echo -e "${YELLOW}Plus $WARNINGS warning(s)${NC}"
        fi
        echo ""
        echo "Quick fixes:"
        echo "  Python:     from src.constants.threshold_constants import QueryDefaults, CategoryDefaults"
        echo "  Python:     from src.config.ssot_config import config"
        echo "  TypeScript: import { config } from '@/config/ssot-config'"
        echo ""
        echo "Documentation: docs/developer/SSOT_CONFIG_GUIDE.md"
        echo ""
        echo "To bypass (NOT recommended): git commit --no-verify"
        exit 1
    elif [[ $WARNINGS -gt 0 ]]; then
        echo -e "${YELLOW}$WARNINGS warning(s) - commit allowed${NC}"
        echo ""
        exit 0
    else
        echo -e "${GREEN}No violations found!${NC}"
        exit 0
    fi
}

main "$@"
