# AutoBot - AI-Powered Automation Platform
# Copyright (c) 2025 mrveiss
# Author: mrveiss
#!/bin/bash
#
# Git post-commit hook for SLM code version tracking (Issue #741)
#
# This hook notifies the local SLM agent of new code commits.
# The agent then reports the new version to the SLM server,
# which can coordinate deployments to fleet nodes.
#
# Installation:
#   ln -sf /home/kali/Desktop/AutoBot/scripts/hooks/slm-post-commit .git/hooks/post-commit
#   chmod +x .git/hooks/post-commit
#

set -e

# Get the new commit hash
COMMIT_HASH=$(git rev-parse HEAD)
COMMIT_SHORT=$(git rev-parse --short HEAD)
COMMIT_MESSAGE=$(git log -1 --pretty=%B | head -1)
BRANCH=$(git rev-parse --abbrev-ref HEAD)
AUTHOR=$(git log -1 --pretty=%an)

# SLM agent socket/API endpoint (local)
SLM_AGENT_URL="${SLM_AGENT_URL:-http://localhost:8000}"
SLM_CODE_SOURCE="${SLM_CODE_SOURCE:-true}"

# Only notify if this is marked as a code source node
if [ "$SLM_CODE_SOURCE" != "true" ]; then
    exit 0
fi

# Create notification payload
PAYLOAD=$(cat <<EOF
{
    "event_type": "code_commit",
    "commit": "$COMMIT_HASH",
    "commit_short": "$COMMIT_SHORT",
    "branch": "$BRANCH",
    "author": "$AUTHOR",
    "message": "$COMMIT_MESSAGE",
    "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
    "repository": "$(pwd)"
}
EOF
)

# Notify local SLM agent (non-blocking, fail silently)
echo "[SLM] Notifying agent of commit: $COMMIT_SHORT"

# Try to notify via Unix socket or HTTP API
if [ -S "/var/run/slm-agent/notify.sock" ]; then
    # Use Unix socket if available
    echo "$PAYLOAD" | nc -U /var/run/slm-agent/notify.sock 2>/dev/null || true
else
    # Fall back to HTTP API
    curl -s -X POST \
        -H "Content-Type: application/json" \
        -d "$PAYLOAD" \
        "${SLM_AGENT_URL}/api/code-change" \
        --connect-timeout 2 \
        --max-time 5 \
        2>/dev/null || true
fi

# Also update the local version.json for immediate tracking
VERSION_FILE="/var/lib/slm-agent/version.json"
if [ -w "$(dirname $VERSION_FILE)" ] || [ -w "$VERSION_FILE" ]; then
    cat > "$VERSION_FILE" <<EOF
{
    "commit": "$COMMIT_HASH",
    "built_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
    "branch": "$BRANCH",
    "source": "git-hook"
}
EOF
    echo "[SLM] Updated version.json: $COMMIT_SHORT"
fi

exit 0
