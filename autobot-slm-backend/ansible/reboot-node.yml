# AutoBot - AI-Powered Automation Platform
# Copyright (c) 2025 mrveiss
# Author: mrveiss
#
# Reboot Node Playbook
# Safely reboots a fleet node and waits for it to come back online
---

- name: Reboot Fleet Node
  hosts: "{{ target_hosts | default('all') }}"
  become: true
  gather_facts: false

  vars:
    _reboot_timeout: "{{ reboot_timeout | default(300) }}"
    _pre_reboot_delay: "{{ pre_reboot_delay | default(5) }}"
    _post_reboot_delay: "{{ post_reboot_delay | default(30) }}"

  tasks:
    - name: Display reboot info
      ansible.builtin.debug:
        msg: |
          ╔════════════════════════════════════════════════════════════╗
          ║          NODE REBOOT INITIATED                             ║
          ╠════════════════════════════════════════════════════════════╣
          ║ Target: {{ inventory_hostname }}                           ║
          ║ Action: System reboot                                      ║
          ║ Timeout: {{ _reboot_timeout }}s                             ║
          ╚════════════════════════════════════════════════════════════╝
      run_once: false

    - name: Reboot the node
      ansible.builtin.reboot:
        reboot_timeout: "{{ _reboot_timeout }}"
        msg: "AutoBot initiated reboot via API"
        pre_reboot_delay: "{{ _pre_reboot_delay }}"
        post_reboot_delay: "{{ _post_reboot_delay }}"
      register: reboot_result

    - name: Wait for node to come back online
      ansible.builtin.wait_for_connection:
        delay: "{{ _post_reboot_delay }}"
        timeout: "{{ _reboot_timeout }}"

    - name: Verify node is responsive
      ansible.builtin.ping:

    - name: Display reboot completion
      ansible.builtin.debug:
        msg: |
          ╔════════════════════════════════════════════════════════════╗
          ║          NODE REBOOT COMPLETE                              ║
          ╠════════════════════════════════════════════════════════════╣
          ║ Target: {{ inventory_hostname }}                           ║
          ║ Status: ✅ Online and responsive                           ║
          ╚════════════════════════════════════════════════════════════╝
