# AutoBot - AI-Powered Automation Platform
# Copyright (c) 2025 mrveiss
# Author: mrveiss
---
# Fast Code Update for All Fleet Nodes (Issue #880, #1056)
#
# Deploys committed code from a specific git ref to fleet VMs.
# Uses git archive to ensure only committed code is deployed.
#
# Previously used rsync from the working tree, which could deploy
# uncommitted or feature-branch code to production (caused #1047).
#
# Two-Play Structure (Issue #880):
# 1. Play 0: Pre-flight git checks + create deploy archives
# 2. Play 1: Update SLM server FIRST (if in scope)
# 3. Play 2: Update all other nodes (after SLM is ready)
#
# Usage:
#   ansible-playbook update-all-nodes.yml                        # Deploy HEAD
#   ansible-playbook update-all-nodes.yml -e deploy_ref=Dev_new_gui
#   ansible-playbook update-all-nodes.yml -e deploy_ref=abc1234
#   ansible-playbook update-all-nodes.yml -e skip_branch_check=true
#   ansible-playbook update-all-nodes.yml --limit frontend       # Only frontend
#   ansible-playbook update-all-nodes.yml --tags backend         # Specific service
#   ansible-playbook update-all-nodes.yml --skip-tags restart    # No restart
#
# Speed: ~30 seconds per node (vs. 5+ minutes for full provision)

# =============================================================================
# PLAY 0: Pre-flight Git Safety Check & Create Deploy Archives
# =============================================================================
- name: "Play 0 - Pre-flight & Build Archives"
  hosts: localhost
  gather_facts: false

  vars:
    github_repo: "https://github.com/mrveiss/AutoBot-AI.git"
    git_repo_root: "/opt/autobot/code_source"
    deploy_ref: "Dev_new_gui"
    allowed_branches:
      - Dev_new_gui
      - main
    skip_branch_check: false
    deploy_tmp: "/tmp/autobot-deploy"

  tasks:
    - name: "[PRE-FLIGHT] Verify code_source exists"
      stat:
        path: "{{ git_repo_root }}/.git"
      register: code_source_stat
      tags: [always]

    - name: "[PRE-FLIGHT] Abort if code_source missing"
      fail:
        msg: >-
          Code source not found at {{ git_repo_root }}.
          Initialize with: git clone {{ github_repo }} {{ git_repo_root }}
      when: not code_source_stat.stat.exists
      tags: [always]

    - name: "[PRE-FLIGHT] Sync latest code from GitHub (if reachable)"
      git:
        repo: "{{ github_repo }}"
        dest: "{{ git_repo_root }}"
        version: "{{ deploy_ref }}"
        update: yes
      ignore_errors: yes
      register: github_sync
      tags: [always]

    - name: "[PRE-FLIGHT] Warn if GitHub sync skipped"
      debug:
        msg: >-
          WARNING: GitHub sync failed (no internet access?).
          Deploying from existing code_source at {{ git_repo_root }}.
      when: github_sync is failed
      tags: [always]

    - name: "[PRE-FLIGHT] Get current git branch"
      command: git -C {{ git_repo_root }} branch --show-current
      register: git_branch
      changed_when: false
      tags: [always]

    - name: "[PRE-FLIGHT] Resolve deploy ref to commit"
      command: >-
        git -C {{ git_repo_root }}
        log -1 --format='%h %s' {{ deploy_ref }}
      register: deploy_info
      changed_when: false
      tags: [always]

    - name: "[PRE-FLIGHT] Get deploy commit SHA"
      command: >-
        git -C {{ git_repo_root }}
        rev-parse --short {{ deploy_ref }}
      register: deploy_commit
      changed_when: false
      tags: [always]

    - name: "[PRE-FLIGHT] Check for uncommitted changes"
      command: git -C {{ git_repo_root }} status --porcelain
      register: git_dirty
      changed_when: false
      tags: [always]

    - name: "[PRE-FLIGHT] Display deployment summary"
      debug:
        msg: |
          =======================================================
            AutoBot Fleet Code Update (Git-Based Deploy)
          =======================================================

            Branch:  {{ git_branch.stdout }}
            Ref:     {{ deploy_ref }}
            Commit:  {{ deploy_info.stdout }}
            Dirty:   {{ 'YES (ignored - only committed code deployed)' if git_dirty.stdout else 'Clean' }}
            Method:  git archive
      tags: [always]

    - name: "[PRE-FLIGHT] ABORT - Not on allowed branch"
      fail:
        msg: >-
          Branch '{{ git_branch.stdout }}' not in allowed list
          ({{ allowed_branches | join(', ') }}).
          Override: -e skip_branch_check=true
          Or deploy specific ref: -e deploy_ref=Dev_new_gui
      when:
        - not skip_branch_check | bool
        - deploy_ref not in allowed_branches
      tags: [always]

    - name: "[PRE-FLIGHT] Create deploy archive directory"
      file:
        path: "{{ deploy_tmp }}"
        state: directory
        mode: '0755'
      tags: [always]

    - name: "[PRE-FLIGHT] Create component archives"
      shell: >-
        git -C {{ git_repo_root }} archive {{ deploy_ref }}
        -- {{ item.path }} | gzip > {{ deploy_tmp }}/{{ item.name }}.tar.gz
      loop:
        - { name: slm-backend, path: autobot-slm-backend/ }
        - { name: slm-frontend, path: autobot-slm-frontend/ }
        - { name: shared, path: autobot-shared/ }
        - { name: backend, path: autobot-backend/ }
        - { name: frontend, path: autobot-frontend/ }
        - { name: npu-worker, path: autobot-npu-worker/ }
        - { name: browser-worker, path: autobot-browser-worker/ }
      loop_control:
        label: "{{ item.name }}"
      changed_when: true
      tags: [always]

    # Issue #1164: Archive slm-agent code (autobot-slm-backend/slm/agent/)
    # Deployed to /opt/autobot/autobot-slm-agent/slm/agent/ on all fleet nodes.
    # strip-components=1 removes the leading autobot-slm-backend/ path prefix.
    - name: "[PRE-FLIGHT] Create slm-agent code archive"
      shell: >-
        git -C {{ git_repo_root }} archive {{ deploy_ref }}
        -- autobot-slm-backend/slm/agent/ | gzip > {{ deploy_tmp }}/slm-agent.tar.gz
      changed_when: true
      tags: [always, slm-agent]

    - name: "[PRE-FLIGHT] Create AI Stack archive"
      shell: >-
        git -C {{ git_repo_root }} archive {{ deploy_ref }}
        -- autobot-infrastructure/shared/docker/ai-stack/
        | gzip > {{ deploy_tmp }}/ai-stack.tar.gz
      changed_when: true
      tags: [always, ai-stack, aiml]

    - name: "[PRE-FLIGHT] Set deploy_commit fact for later plays"
      set_fact:
        deploy_commit_sha: "{{ deploy_commit.stdout }}"
      tags: [always]

# =============================================================================
# PLAY 1: Update SLM Server First (Self-Update Pattern)
# =============================================================================
- name: Play 1 - Update SLM Server First
  hosts: slm_server
  become: true
  gather_facts: false

  vars:
    code_base_dir: /opt/autobot
    restart_services: true
    verify_health: true
    deploy_tmp: "/tmp/autobot-deploy"

  pre_tasks:
    - name: "[PLAY 1] Starting SLM Server Update"
      debug:
        msg: |
          =======================================================
            PLAY 1: SLM Server Update (git archive deploy)
          =======================================================
          Target: {{ inventory_hostname }} ({{ ansible_host }})
          Action: Deploy from git archive + restart backend
      run_once: false

  tasks:
    # =========================================================================
    # SLM BACKEND
    # =========================================================================
    - name: "[PLAY 1] SLM | Deploy autobot-slm-backend"
      unarchive:
        src: "{{ deploy_tmp }}/slm-backend.tar.gz"
        dest: "{{ code_base_dir }}/"
      tags: [slm, slm-backend]

    - name: "[PLAY 1] SLM | Restart autobot-slm-backend service"
      command: systemctl restart autobot-slm-backend
      async: 1
      poll: 0
      become: true
      when: restart_services | bool
      tags: [slm, slm-backend, restart]
      changed_when: true

    # =========================================================================
    # SLM FRONTEND
    # =========================================================================
    - name: "[PLAY 1] SLM Frontend | Deploy autobot-slm-frontend"
      unarchive:
        src: "{{ deploy_tmp }}/slm-frontend.tar.gz"
        dest: "{{ code_base_dir }}/"
      tags: [slm, slm-frontend]

    - name: "[PLAY 1] SLM Frontend | Rebuild production dist"
      command:
        cmd: npm run build
        chdir: "{{ code_base_dir }}/autobot-slm-frontend"
      tags: [slm, slm-frontend]

    # =========================================================================
    # SHARED LIBRARY
    # =========================================================================
    - name: "[PLAY 1] Shared | Deploy autobot-shared"
      unarchive:
        src: "{{ deploy_tmp }}/shared.tar.gz"
        dest: "{{ code_base_dir }}/"
      tags: [shared, library]

    # =========================================================================
    # SLM AGENT - Issue #1164: Keep agent code in sync on every fleet update
    # =========================================================================
    - name: "[PLAY 1] SLM Agent | Deploy agent code to slm-agent dir"
      unarchive:
        src: "{{ deploy_tmp }}/slm-agent.tar.gz"
        dest: "{{ code_base_dir }}/autobot-slm-agent/"
        extra_opts: ['--strip-components=1']
      tags: [slm-agent]

    - name: "[PLAY 1] SLM Agent | Restart slm-agent service"
      systemd:
        name: slm-agent
        state: restarted
      when: restart_services | bool
      failed_when: false
      tags: [slm-agent, restart]

  post_tasks:
    # =========================================================================
    # HEALTH VERIFICATION
    # =========================================================================
    - name: "[PLAY 1] Verify | Wait for SLM backend to stabilize"
      pause:
        seconds: 10
      when: verify_health | bool
      tags: [verify]

    - name: "[PLAY 1] Verify | Check SLM backend health"
      uri:
        url: "https://{{ ansible_host }}/api/health"
        validate_certs: false
        status_code: 200
      register: health_check
      retries: 6
      delay: 5
      until: health_check.status == 200
      failed_when: false
      when: verify_health | bool
      tags: [verify]

    # =========================================================================
    # DATABASE VERSION UPDATE (Issue #885)
    # =========================================================================
    - name: "[PLAY 1] Database | Update SLM node version"
      shell: |
        source /etc/autobot/db-credentials.env
        PGPASSWORD=$SLM_DB_PASSWORD psql -h 127.0.0.1 -U slm_app -d slm \
          -c "UPDATE nodes SET code_version = '{{ hostvars['localhost']['deploy_commit_sha'] | default('unknown') }}', \
              code_status = 'UP_TO_DATE', updated_at = NOW() \
              WHERE node_id = '00-SLM-Manager';"
      failed_when: false
      tags: [verify, database]

    - name: "[PLAY 1] SLM Server Update Complete"
      debug:
        msg: |
          =======================================================
            PLAY 1: SLM Server Update Complete
          =======================================================
          Version: {{ hostvars['localhost']['deploy_commit_sha'] | default('unknown') }}
          Status: {{ 'Backend restarted and healthy' if restart_services else 'Code updated (no restart)' }}
      tags: [verify]

# =============================================================================
# PLAY 2: Update All Other Infrastructure Nodes
# =============================================================================
- name: Play 2 - Update Other Infrastructure Nodes
  hosts: infrastructure:!slm_server
  become: true
  gather_facts: false
  serial: 3

  vars:
    code_base_dir: /opt/autobot
    restart_services: true
    verify_health: true
    deploy_tmp: "/tmp/autobot-deploy"

  pre_tasks:
    - name: "[PLAY 2] Starting Node Update"
      debug:
        msg: |
          =======================================================
            PLAY 2: Infrastructure Node Update (git archive)
          =======================================================
          Target: {{ inventory_hostname }} ({{ ansible_host }})
          Batch: Processing up to 3 nodes at a time
      run_once: false

  tasks:
    # =========================================================================
    # USER BACKEND - Main AutoBot Backend
    # =========================================================================
    - name: "[PLAY 2] Backend | Deploy autobot-backend"
      unarchive:
        src: "{{ deploy_tmp }}/backend.tar.gz"
        dest: "{{ code_base_dir }}/"
      when: "'main' in group_names"
      tags: [backend, user-backend]

    - name: "[PLAY 2] Backend | Fix ownership"
      file:
        path: "{{ code_base_dir }}/autobot-backend"
        owner: autobot
        group: autobot
        recurse: true
      when: "'main' in group_names"
      tags: [backend, user-backend]

    - name: "[PLAY 2] Backend | Remove legacy backend symlink"
      file:
        path: "{{ code_base_dir }}/autobot-backend/backend"
        state: absent
      become: true
      when: "'main' in group_names"
      tags: [backend, user-backend]

    - name: "[PLAY 2] Backend | Restart autobot-backend service"
      systemd:
        name: autobot-backend
        state: restarted
      when:
        - "'main' in group_names"
        - restart_services | bool
      tags: [backend, user-backend, restart]

    # =========================================================================
    # USER FRONTEND - Vue Application
    # =========================================================================
    - name: "[PLAY 2] Frontend | Deploy autobot-frontend"
      unarchive:
        src: "{{ deploy_tmp }}/frontend.tar.gz"
        dest: "{{ code_base_dir }}/"
      when: "'frontend' in group_names"
      tags: [frontend, user-frontend]

    - name: "[PLAY 2] Frontend | Fix ownership before build"
      file:
        path: "{{ code_base_dir }}/autobot-frontend"
        owner: autobot
        group: autobot
        recurse: true
      when: "'frontend' in group_names"
      tags: [frontend, user-frontend]

    - name: "[PLAY 2] Frontend | Install npm dependencies"
      command:
        cmd: npm install
        chdir: "{{ code_base_dir }}/autobot-frontend"
      become_user: autobot
      when: "'frontend' in group_names"
      tags: [frontend, user-frontend]

    - name: "[PLAY 2] Frontend | Rebuild production dist"
      command:
        cmd: npx vite build
        chdir: "{{ code_base_dir }}/autobot-frontend"
      become_user: autobot
      when: "'frontend' in group_names"
      tags: [frontend, user-frontend]

    - name: "[PLAY 2] Frontend | Reload nginx"
      systemd:
        name: nginx
        state: reloaded
      when:
        - "'frontend' in group_names"
        - restart_services | bool
      tags: [frontend, user-frontend, restart]

    # =========================================================================
    # NPU WORKER
    # =========================================================================
    - name: "[PLAY 2] NPU | Deploy autobot-npu-worker"
      unarchive:
        src: "{{ deploy_tmp }}/npu-worker.tar.gz"
        dest: "{{ code_base_dir }}/"
      when: "'npu_worker' in group_names"
      tags: [npu, npu-worker]

    - name: "[PLAY 2] NPU | Restart autobot-npu-worker service"
      command: systemctl restart autobot-npu-worker
      become: true
      when:
        - "'npu_worker' in group_names"
        - restart_services | bool
      tags: [npu, npu-worker, restart]

    # =========================================================================
    # BROWSER WORKER
    # =========================================================================
    - name: "[PLAY 2] Browser | Deploy autobot-browser-worker"
      unarchive:
        src: "{{ deploy_tmp }}/browser-worker.tar.gz"
        dest: "{{ code_base_dir }}/"
      when: "'browser_worker' in group_names"
      tags: [browser, browser-worker]

    - name: "[PLAY 2] Browser | Restart autobot-playwright service"
      systemd:
        name: autobot-playwright
        state: restarted
      when:
        - "'browser_worker' in group_names"
        - restart_services | bool
      tags: [browser, browser-worker, restart]

    # =========================================================================
    # AI STACK - LangChain/LlamaIndex Agent Router + ChromaDB
    # =========================================================================
    - name: "[PLAY 2] AI Stack | Deploy ai_api_server and requirements"
      unarchive:
        src: "{{ deploy_tmp }}/ai-stack.tar.gz"
        dest: "{{ code_base_dir }}/autobot-ai-stack/"
        extra_opts: ['--strip-components=4']
      when: "'aiml' in group_names"
      tags: [ai-stack, aiml]

    - name: "[PLAY 2] AI Stack | Restart autobot-ai-stack service"
      systemd:
        name: autobot-ai-stack
        state: restarted
      when:
        - "'aiml' in group_names"
        - restart_services | bool
      tags: [ai-stack, aiml, restart]

    - name: "[PLAY 2] AI Stack | Restart autobot-chromadb service"
      systemd:
        name: autobot-chromadb
        state: restarted
      when:
        - "'aiml' in group_names"
        - restart_services | bool
      tags: [ai-stack, aiml, chromadb, restart]

    # =========================================================================
    # SHARED LIBRARY - All nodes with Python services
    # =========================================================================
    - name: "[PLAY 2] Shared | Deploy autobot-shared"
      unarchive:
        src: "{{ deploy_tmp }}/shared.tar.gz"
        dest: "{{ code_base_dir }}/"
      when: >-
        'main' in group_names or
        'npu_worker' in group_names or
        'browser_worker' in group_names or
        'aiml' in group_names
      tags: [shared, library]

    # =========================================================================
    # SLM AGENT - Issue #1164: Keep agent code in sync on every fleet update
    # =========================================================================
    - name: "[PLAY 2] SLM Agent | Deploy agent code to slm-agent dir"
      unarchive:
        src: "{{ deploy_tmp }}/slm-agent.tar.gz"
        dest: "{{ code_base_dir }}/autobot-slm-agent/"
        extra_opts: ['--strip-components=1']
      when: slm_node_id is defined
      tags: [slm-agent]

    - name: "[PLAY 2] SLM Agent | Restart slm-agent service"
      systemd:
        name: slm-agent
        state: restarted
      when:
        - slm_node_id is defined
        - restart_services | bool
      failed_when: false
      tags: [slm-agent, restart]

  post_tasks:
    # =========================================================================
    # HEALTH VERIFICATION
    # =========================================================================
    - name: "[PLAY 2] Verify | Wait for services to stabilize"
      pause:
        seconds: 5
      when: verify_health | bool
      tags: [verify]

    - name: "[PLAY 2] Verify | Check service status"
      systemd:
        name: "{{ item }}"
      register: service_status
      failed_when: false
      loop:
        - autobot-backend
        - autobot-npu-worker
        - autobot-playwright
        - autobot-ai-stack
        - autobot-chromadb
        - nginx
      when:
        - verify_health | bool
      tags: [verify]

    # =========================================================================
    # DATABASE VERSION UPDATE (Issue #885)
    # =========================================================================
    - name: "[PLAY 2] Database | Update node version"
      shell: |
        source /etc/autobot/db-credentials.env
        PGPASSWORD=$SLM_DB_PASSWORD psql -h 127.0.0.1 -U slm_app -d slm \
          -c "UPDATE nodes SET code_version = '{{ hostvars['localhost']['deploy_commit_sha'] | default('unknown') }}', \
              code_status = 'UP_TO_DATE', updated_at = NOW() \
              WHERE node_id = '{{ slm_node_id }}';"
      delegate_to: "{{ groups['slm_server'][0] }}"
      when: slm_node_id is defined
      failed_when: false
      tags: [verify, database]

    - name: "[PLAY 2] Node Update Complete"
      debug:
        msg: |
          =======================================================
            PLAY 2: Node Update Complete
          =======================================================
          Node: {{ inventory_hostname }}
          Version: {{ hostvars['localhost']['deploy_commit_sha'] | default('unknown') }}
          Status: {{ 'Services restarted' if restart_services else 'Code updated (no restart)' }}
      tags: [verify]

# =============================================================================
# FINAL SUMMARY
# =============================================================================
- name: Fleet Update Summary
  hosts: localhost
  gather_facts: false
  run_once: true

  tasks:
    - name: Clean up deploy archives
      file:
        path: /tmp/autobot-deploy
        state: absent

    - name: Display fleet update summary
      debug:
        msg: |
          =======================================================
            Fleet Update Complete (Git-Based Deploy)
          =======================================================

          Deploy ref:    {{ deploy_ref | default('HEAD') }}
          Commit:        {{ deploy_commit_sha | default('unknown') }}
          Method:        git archive (only committed code)

          Two-Play Structure Executed:
          - Play 1: SLM Server updated first (if in scope)
          - Play 2: Other infrastructure nodes updated

          Next steps:
          - Verify services via monitoring dashboards
          - Check logs for any startup errors
          - Test critical workflows

          =======================================================
