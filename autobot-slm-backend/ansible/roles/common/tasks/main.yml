---
# Common role - Base system configuration for all AutoBot hosts
# Applied to all VMs before service-specific roles

- name: "Common | Update apt cache"
  apt:
    update_cache: yes
    cache_valid_time: 3600
  become: yes
  retries: 3
  delay: 5
  register: _apt_update
  until: _apt_update is success
  tags: ['common', 'packages']

- name: "Common | Install base packages"
  apt:
    name:
      - python3
      - python3-pip
      - python3-venv
      - git
      - curl
      - wget
      - vim
      - htop
      - net-tools
      - ufw
      - rsync
      - ca-certificates
      - gnupg
      - lsb-release
      # Network diagnostics (#703)
      - netcat-openbsd
      - iputils-ping
      - dnsutils
    state: present
  become: yes
  tags: ['common', 'packages']

- name: "Common | Create autobot user"
  user:
    name: autobot
    comment: "AutoBot Service User"
    home: /home/autobot
    shell: /bin/bash
    create_home: yes
    state: present
  become: yes
  tags: ['common', 'users']

- name: "Common | Create emergency admin user"
  user:
    name: "{{ emergency_admin_user }}"
    comment: "Emergency Admin User (fallback access)"
    shell: /bin/bash
    create_home: yes
    groups: sudo
    append: yes
    password: "{{ emergency_admin_password_hash }}"
    state: present
  become: yes
  tags: ['common', 'users', 'emergency']

- name: "Common | Configure passwordless sudo for emergency admin"
  copy:
    content: "{{ emergency_admin_user }} ALL=(ALL) NOPASSWD: ALL\n"
    dest: "/etc/sudoers.d/90-{{ emergency_admin_user }}"
    owner: root
    group: root
    mode: '0440'
    validate: 'visudo -cf %s'
  become: yes
  tags: ['common', 'users', 'emergency']

- name: "Common | Create AutoBot directory structure"
  file:
    path: "{{ item }}"
    state: directory
    owner: autobot
    group: autobot
    mode: '0755'
  loop:
    - /opt/autobot
    - /opt/autobot/logs
    - /opt/autobot/data
    - /opt/autobot/config
    - /opt/autobot/scripts
  become: yes
  tags: ['common', 'directories']

- name: "Common | Configure SSH key authentication"
  authorized_key:
    user: autobot
    key: "{{ lookup('file', '~/.ssh/autobot_key.pub') }}"
    state: present
  become: yes
  when: lookup('file', '~/.ssh/autobot_key.pub', errors='ignore') is not none
  tags: ['common', 'ssh']

- name: "Common | Configure firewall - Set default policies"
  ufw:
    state: enabled
    policy: "{{ item.policy }}"
    direction: "{{ item.direction }}"
  loop:
    - { direction: 'incoming', policy: "{{ ufw_default_incoming_policy }}" }
    - { direction: 'outgoing', policy: "{{ ufw_default_outgoing_policy }}" }
    - { direction: 'routed', policy: "{{ ufw_default_routed_policy }}" }
  become: yes
  tags: ['common', 'firewall']

- name: "Common | Merge base and role-specific firewall rules (#894)"
  set_fact:
    merged_firewall_rules: "{{ (security.base_firewall_rules | default([])) + (security.firewall_rules | default([])) }}"
  tags: ['common', 'firewall']

- name: "Common | Configure firewall - Apply merged rules (#894)"
  ufw:
    rule: "{{ item.rule }}"
    port: "{{ item.port | default(omit) }}"
    proto: "{{ item.proto | default('tcp') }}"
    from_ip: "{{ item.src | default('any') }}"
    to_ip: "{{ item.dest | default('any') }}"
    comment: "{{ item.comment | default('AutoBot rule') }}"
  loop: "{{ merged_firewall_rules }}"
  become: yes
  notify: reload firewall
  when: merged_firewall_rules | length > 0
  tags: ['common', 'firewall']

- name: "Common | Configure firewall - Set logging level (#887)"
  ufw:
    logging: "{{ ufw_logging }}"
  become: yes
  tags: ['common', 'firewall']

- name: "Common | Enable firewall"
  ufw:
    state: enabled
  become: yes
  when: ufw_enabled | bool
  tags: ['common', 'firewall']

- name: "Common | Set hostname"
  hostname:
    name: "{{ inventory_hostname }}"
  become: yes
  when: inventory_hostname is defined
  tags: ['common', 'hostname']

- name: "Common | Update /etc/hosts"
  lineinfile:
    path: /etc/hosts
    line: "{{ ansible_default_ipv4.address }} {{ inventory_hostname }} {{ inventory_hostname_short }}"
    regexp: "^{{ ansible_default_ipv4.address }}"
    state: present
  become: yes
  when: ansible_default_ipv4.address is defined
  tags: ['common', 'hostname']

- name: "Common | Configure DNS resolvers"
  template:
    src: resolv.conf.j2
    dest: /etc/resolv.conf
    owner: root
    group: root
    mode: '0644'
  become: yes
  when: dns_servers is defined
  tags: ['common', 'dns']

- name: "Common | Check for PEP 668 (externally managed Python)"
  shell: ls /usr/lib/python3*/EXTERNALLY-MANAGED 2>/dev/null
  register: _pep668
  changed_when: false
  failed_when: false
  tags: ['common', 'python']

- name: "Common | Install Python packages (system-wide)"
  pip:
    name:
      - pip
      - setuptools
      - wheel
    state: latest
    executable: pip3
  become: yes
  when: _pep668.rc != 0
  tags: ['common', 'python']

- name: "Common | Create log directory"
  file:
    path: /var/log/autobot
    state: directory
    owner: autobot
    group: autobot
    mode: '0755'
  become: yes
  tags: ['common', 'logging']

- name: "Common | Display configuration summary"
  debug:
    msg:
      - "=== Common Role Configuration Complete ==="
      - "Hostname: {{ inventory_hostname }}"
      - "IP Address: {{ ansible_default_ipv4.address | default('N/A') }}"
      - "AutoBot User: autobot"
      - "Base Packages: Installed"
      - "Firewall: Enabled (SSH allowed)"
      - "Directory Structure: Created"
  tags: ['common', 'report']
