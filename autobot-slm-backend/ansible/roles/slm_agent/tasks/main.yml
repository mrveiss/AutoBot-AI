# AutoBot - AI-Powered Automation Platform
# Copyright (c) 2025 mrveiss
# Author: mrveiss
---
# SLM Agent Role - Main Tasks
# Deploys the SLM node agent as a systemd service

- name: "SLM Agent | Validate required variables"
  assert:
    that:
      - slm_node_id is defined
      - slm_node_id | length > 0
    fail_msg: "slm_node_id must be defined for each host"
  tags: ['slm_agent', 'validate']

# Clean up legacy autobot-agent.service that predated this role (#917)
- name: "SLM Agent | Check if legacy autobot-agent.service exists"
  ansible.builtin.stat:
    path: /etc/systemd/system/autobot-agent.service
  register: legacy_agent_unit
  tags: ['slm_agent', 'cleanup']

- name: "SLM Agent | Stop and disable legacy autobot-agent.service"
  ansible.builtin.systemd:
    name: autobot-agent
    state: stopped
    enabled: false
    daemon_reload: true
  when: legacy_agent_unit.stat.exists
  failed_when: false
  become: yes
  tags: ['slm_agent', 'cleanup']

- name: "SLM Agent | Remove legacy autobot-agent.service unit file"
  ansible.builtin.file:
    path: /etc/systemd/system/autobot-agent.service
    state: absent
  when: legacy_agent_unit.stat.exists
  become: yes
  notify: Reload systemd
  tags: ['slm_agent', 'cleanup']

- name: "SLM Agent | Create agent directories"
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ slm_agent_user }}"
    group: "{{ slm_agent_group }}"
    mode: '0755'
  loop:
    - "{{ slm_agent_dir }}"
    - "{{ slm_agent_dir }}/slm"
    - "{{ slm_agent_dir }}/slm/agent"
    - "{{ slm_agent_data_dir }}"
  become: yes
  tags: ['slm_agent', 'directories']

# Issue #741: Version tracking - Get git commit and deploy version.json
- name: "SLM Agent | Get current git commit hash"
  delegate_to: localhost
  run_once: true
  become: false
  ansible.builtin.command:
    cmd: git rev-parse HEAD
    chdir: "{{ playbook_dir }}/../.."
  register: git_commit_result
  changed_when: false
  failed_when: false
  tags: ['slm_agent', 'version']

- name: "SLM Agent | Set git commit fact"
  ansible.builtin.set_fact:
    git_commit: "{{ git_commit_result.stdout | default('unknown') }}"
  tags: ['slm_agent', 'version']

- name: "SLM Agent | Deploy version.json"
  ansible.builtin.template:
    src: version.json.j2
    dest: "{{ slm_agent_data_dir }}/version.json"
    owner: "{{ slm_agent_user }}"
    group: "{{ slm_agent_group }}"
    mode: '0644'
  become: yes
  tags: ['slm_agent', 'version']

- name: "SLM Agent | Install Python dependencies"
  pip:
    name: "{{ slm_agent_python_packages }}"
    state: present
    executable: pip3
  become: yes
  tags: ['slm_agent', 'packages']

- name: "SLM Agent | Copy agent source - __init__.py (slm package)"
  copy:
    content: |
      # AutoBot - AI-Powered Automation Platform
      # Copyright (c) 2025 mrveiss
      # Author: mrveiss
      """SLM Package."""
    dest: "{{ slm_agent_dir }}/slm/__init__.py"
    owner: "{{ slm_agent_user }}"
    group: "{{ slm_agent_group }}"
    mode: '0644'
  become: yes
  notify: Restart SLM agent
  tags: ['slm_agent', 'deploy']

- name: "SLM Agent | Copy agent source - __init__.py (agent module)"
  copy:
    src: slm/agent/__init__.py
    dest: "{{ slm_agent_dir }}/slm/agent/__init__.py"
    owner: "{{ slm_agent_user }}"
    group: "{{ slm_agent_group }}"
    mode: '0644'
  become: yes
  notify: Restart SLM agent
  tags: ['slm_agent', 'deploy']

- name: "SLM Agent | Copy agent source - agent.py"
  copy:
    src: slm/agent/agent.py
    dest: "{{ slm_agent_dir }}/slm/agent/agent.py"
    owner: "{{ slm_agent_user }}"
    group: "{{ slm_agent_group }}"
    mode: '0644'
  become: yes
  notify: Restart SLM agent
  tags: ['slm_agent', 'deploy']

- name: "SLM Agent | Copy agent source - health_collector.py"
  copy:
    src: slm/agent/health_collector.py
    dest: "{{ slm_agent_dir }}/slm/agent/health_collector.py"
    owner: "{{ slm_agent_user }}"
    group: "{{ slm_agent_group }}"
    mode: '0644'
  become: yes
  notify: Restart SLM agent
  tags: ['slm_agent', 'deploy']

# Issue #741: Deploy version tracking module
- name: "SLM Agent | Copy agent source - version.py"
  copy:
    src: slm/agent/version.py
    dest: "{{ slm_agent_dir }}/slm/agent/version.py"
    owner: "{{ slm_agent_user }}"
    group: "{{ slm_agent_group }}"
    mode: '0644'
  become: yes
  notify: Restart SLM agent
  tags: ['slm_agent', 'deploy']

- name: "SLM Agent | Deploy agent configuration"
  template:
    src: agent-config.yaml.j2
    dest: "{{ slm_agent_dir }}/config.yaml"
    owner: "{{ slm_agent_user }}"
    group: "{{ slm_agent_group }}"
    mode: '0640'
  become: yes
  notify: Restart SLM agent
  tags: ['slm_agent', 'config']

- name: "SLM Agent | Deploy systemd service unit"
  template:
    src: slm-agent.service.j2
    dest: /etc/systemd/system/slm-agent.service
    owner: root
    group: root
    mode: '0644'
  become: yes
  notify:
    - Reload systemd
    - Restart SLM agent
  tags: ['slm_agent', 'systemd']

- name: "SLM Agent | Configure firewall - Allow admin heartbeat port"
  ufw:
    rule: allow
    from_ip: "{{ slm_admin_url | regex_replace('^https?://([^:/]+).*$', '\\1') }}"
    port: "{{ slm_agent_api_port | default('8444') }}"
    proto: tcp
    comment: "SLM Agent API"
  become: yes
  when: slm_agent_api_port is defined
  tags: ['slm_agent', 'firewall']

- name: "SLM Agent | Enable and start service"
  systemd:
    name: slm-agent
    enabled: yes
    state: started
    daemon_reload: yes
  become: yes
  tags: ['slm_agent', 'service']

- name: "SLM Agent | Wait for agent to start"
  wait_for:
    timeout: 5
  tags: ['slm_agent', 'service']

- name: "SLM Agent | Verify agent is running"
  systemd:
    name: slm-agent
  register: slm_agent_status
  become: yes
  tags: ['slm_agent', 'verify']

- name: "SLM Agent | Display deployment summary"
  debug:
    msg:
      - "=== SLM Agent Deployment Complete ==="
      - "Node ID: {{ slm_node_id }}"
      - "Admin URL: {{ slm_admin_url }}"
      - "Heartbeat Interval: {{ slm_heartbeat_interval }}s"
      - "Agent Directory: {{ slm_agent_dir }}"
      - "Data Directory: {{ slm_agent_data_dir }}"
      - "Version: {{ slm_agent_version | default(git_commit) }}"
      - "Services Monitored: {{ slm_services_to_monitor | join(', ') | default('None') }}"
      - "Service Status: {{ slm_agent_status.status.ActiveState }}"
  tags: ['slm_agent', 'report']
