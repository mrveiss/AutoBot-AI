# AutoBot - AI-Powered Automation Platform
# Copyright (c) 2025 mrveiss
# Author: mrveiss
# ---
# Manage /etc/hosts entries for fleet DNS

- name: Remove old AutoBot DNS entries from /etc/hosts
  blockinfile:
    path: /etc/hosts
    marker: "{mark}"
    marker_begin: "{{ hosts_marker_begin }}"
    marker_end: "{{ hosts_marker_end }}"
    state: absent

- name: Add fleet DNS entries to /etc/hosts
  blockinfile:
    path: /etc/hosts
    marker: "{mark}"
    marker_begin: "{{ hosts_marker_begin }}"
    marker_end: "{{ hosts_marker_end }}"
    block: |
      # Generated by Ansible - {{ ansible_date_time.iso8601 }}
      {% for entry in fleet_host_entries %}
      {{ entry.ip }}    {{ entry.fqdn }} {{ entry.hostname }} {% if create_short_aliases %}{{ entry.aliases | join(' ') }}{% endif %}

      {% endfor %}
      {% for entry in custom_host_entries %}
      {{ entry.ip }}    {{ entry.hostnames | join(' ') }}
      {% endfor %}
    state: present
    create: yes
    mode: '0644'

- name: Verify /etc/hosts entries
  command: grep -A 10 "{{ hosts_marker_begin }}" /etc/hosts
  register: hosts_verify
  changed_when: false
  failed_when: false

- name: Display /etc/hosts fleet entries
  debug:
    msg: "{{ hosts_verify.stdout_lines }}"
  when: hosts_verify.rc == 0
