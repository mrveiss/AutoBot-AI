#!/bin/bash
# AutoBot - AI-Powered Automation Platform
# Copyright (c) 2025 mrveiss
# Author: mrveiss
#
# Test DNS resolution across AutoBot fleet
# Generated by Ansible - DO NOT EDIT MANUALLY

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo "üß™ Testing AutoBot Fleet DNS Resolution"
echo "========================================"
echo ""

# Test hostname resolution
echo "üì° Hostname Resolution Tests:"
echo "-----------------------------"

{% for entry in fleet_host_entries %}
printf "%-30s " "{{ entry.hostname }}:"
if host="{{ entry.hostname }}" && getent hosts "$host" >/dev/null 2>&1; then
    ip=$(getent hosts "$host" | awk '{print $1}')
    echo -e "${GREEN}‚úÖ $ip${NC}"
else
    echo -e "${RED}‚ùå Failed${NC}"
fi
{% endfor %}

# Test connectivity
echo ""
echo "üîå Connectivity Tests:"
echo "---------------------"

{% for entry in fleet_host_entries %}
printf "%-30s " "{{ entry.hostname }}:22:"
if timeout {{ dns_test_timeout }} bash -c "echo >/dev/tcp/{{ entry.ip }}/22" 2>/dev/null; then
    echo -e "${GREEN}‚úÖ Reachable${NC}"
else
    echo -e "${RED}‚ùå Unreachable${NC}"
fi
{% endfor %}

# Test DNS cache
echo ""
echo "üìä DNS Cache Status:"
echo "-------------------"

{% if install_dnsmasq %}
if systemctl is-active dnsmasq >/dev/null 2>&1; then
    echo -e "${GREEN}‚úÖ dnsmasq is running${NC}"
    # Show cache stats
    sudo pkill -USR1 dnsmasq
    echo "Cache stats logged to syslog"
else
    echo -e "${RED}‚ùå dnsmasq is not running${NC}"
fi
{% elif use_systemd_resolved %}
if systemctl is-active systemd-resolved >/dev/null 2>&1; then
    echo -e "${GREEN}‚úÖ systemd-resolved is running${NC}"
    resolvectl statistics 2>/dev/null || echo "Statistics not available"
else
    echo -e "${RED}‚ùå systemd-resolved is not running${NC}"
fi
{% else %}
echo "No DNS caching service configured"
{% endif %}

echo ""
echo "‚úÖ DNS resolution tests complete"
