#!/bin/bash
# AutoBot Time Synchronization Monitoring Script
# Generated by Ansible for {{ ansible_hostname }}
# Timezone: {{ time_sync.timezone }}

# Configuration
LOG_FILE="{{ time_sync.logging.log_file }}"
MAX_DRIFT="{{ time_sync.validation.max_drift_seconds }}"
HOSTNAME="{{ ansible_hostname }}"
TIMEZONE="{{ time_sync.timezone }}"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Logging function
log_message() {
    local level="$1"
    local message="$2"
    echo "$(date '+%Y-%m-%d %H:%M:%S') [$level] [$HOSTNAME] $message" >> "$LOG_FILE"
    if [[ "$level" == "ERROR" ]] || [[ "$level" == "WARNING" ]]; then
        echo -e "${RED}[$level]${NC} $message" >&2
    elif [[ "$level" == "INFO" ]]; then
        echo -e "${GREEN}[$level]${NC} $message"
    fi
}

# Check if time is synchronized
check_time_sync() {
    local sync_status
    sync_status=$(timedatectl status | grep "System clock synchronized" | awk '{print $4}')

    if [[ "$sync_status" == "yes" ]]; then
        return 0
    else
        return 1
    fi
}

# Check timezone
check_timezone() {
    local current_tz
    current_tz=$(timedatectl show --property=Timezone --value)

    if [[ "$current_tz" == "$TIMEZONE" ]]; then
        return 0
    else
        log_message "ERROR" "Timezone mismatch: current=$current_tz, expected=$TIMEZONE"
        return 1
    fi
}

# Check NTP service status
check_ntp_service() {
{% if time_sync.ntp.use_chrony %}
    local service="chrony"
{% else %}
    local service="systemd-timesyncd"
{% endif %}

    if systemctl is-active "$service" >/dev/null 2>&1; then
        return 0
    else
        log_message "ERROR" "NTP service $service is not running"
        return 1
    fi
}

# Get time drift information
get_time_drift() {
{% if time_sync.ntp.use_chrony %}
    # For chrony
    if command -v chronyc >/dev/null 2>&1; then
        chronyc tracking 2>/dev/null | grep "Last offset" | awk '{print $4}'
    else
        echo "unknown"
    fi
{% else %}
    # For systemd-timesyncd
    if timedatectl timesync-status >/dev/null 2>&1; then
        timedatectl timesync-status | grep "Offset:" | awk '{print $2}'
    else
        echo "unknown"
    fi
{% endif %}
}

# Main health check
main() {
    local exit_code=0
    local current_time
    current_time=$(date '+%Y-%m-%d %H:%M:%S %Z (UTC%z)')

    log_message "INFO" "Starting time synchronization health check"
    log_message "INFO" "Current time: $current_time"

    # Check timezone
    if ! check_timezone; then
        exit_code=1
    else
        log_message "INFO" "Timezone check passed: $TIMEZONE"
    fi

    # Check NTP service
    if ! check_ntp_service; then
        exit_code=1
    else
        log_message "INFO" "NTP service check passed"
    fi

    # Check time synchronization
    if ! check_time_sync; then
        log_message "ERROR" "System clock is not synchronized"
        exit_code=1
    else
        log_message "INFO" "System clock synchronization check passed"
    fi

    # Check time drift
    local drift
    drift=$(get_time_drift)
    if [[ "$drift" != "unknown" ]]; then
        # Convert to absolute value for comparison
        local abs_drift
        abs_drift=$(echo "$drift" | sed 's/^-//' | sed 's/s$//')

        if (( $(echo "$abs_drift > $MAX_DRIFT" | bc -l) )); then
            log_message "WARNING" "Time drift ($drift) exceeds maximum allowed ($MAX_DRIFT seconds)"
            exit_code=1
        else
            log_message "INFO" "Time drift check passed: $drift"
        fi
    else
        log_message "WARNING" "Could not determine time drift"
    fi

    # Summary
    if [[ $exit_code -eq 0 ]]; then
        log_message "INFO" "All time synchronization checks passed"
    else
        log_message "ERROR" "One or more time synchronization checks failed"
    fi

    return $exit_code
}

# Handle command line arguments
case "${1:-check}" in
    "check")
        main
        ;;
    "status")
        echo "=== AutoBot Time Synchronization Status ==="
        echo "Hostname: $HOSTNAME"
        echo "Timezone: $TIMEZONE"
        echo "Current time: $(date '+%Y-%m-%d %H:%M:%S %Z (UTC%z)')"
        echo ""
        timedatectl status
        echo ""
{% if time_sync.ntp.use_chrony %}
        echo "=== Chrony Status ==="
        chronyc sources -v 2>/dev/null || echo "Chrony not available"
{% else %}
        echo "=== systemd-timesyncd Status ==="
        timedatectl timesync-status 2>/dev/null || echo "timesync-status not available"
{% endif %}
        ;;
    "force-sync")
        log_message "INFO" "Forcing time synchronization"
{% if time_sync.ntp.use_chrony %}
        chronyc makestep
{% else %}
        systemctl restart systemd-timesyncd
        sleep 5
{% endif %}
        main
        ;;
    *)
        echo "Usage: $0 {check|status|force-sync}"
        echo "  check      - Run health checks (default)"
        echo "  status     - Show detailed status"
        echo "  force-sync - Force immediate synchronization"
        exit 1
        ;;
esac
