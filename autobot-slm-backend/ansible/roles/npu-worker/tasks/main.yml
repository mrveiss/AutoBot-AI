# AutoBot - AI-Powered Automation Platform
# Copyright (c) 2025 mrveiss
# Author: mrveiss
#
# NPU Worker Role - Intel NPU acceleration worker for AutoBot
---

# ============================================================
# Phase 1 CLEAN - remove legacy/wrong-node dirs  (#926 Phase 4)
# ============================================================
- name: "NPU Worker | Include clean tasks"
  ansible.builtin.import_tasks: clean.yml
  tags: ['clean']

# ============================================================
# Per-role service account  (#926 Phase 4)
# ============================================================
- name: "NPU Worker | Create autobot-npu system group"
  ansible.builtin.group:
    name: "{{ npu_group }}"
    system: true
    state: present
  tags: ['npu', 'users']

- name: "NPU Worker | Create per-role service account"
  ansible.builtin.user:
    name: "{{ npu_user }}"
    system: true
    shell: /usr/sbin/nologin
    create_home: false
    group: "{{ npu_group }}"
    comment: "AutoBot NPU worker service account"
    state: present
  tags: ['npu', 'users']

# ============================================================
# Per-role env at /etc/autobot/  (#926 Phase 4)
# ============================================================
- name: "NPU Worker | Ensure /etc/autobot dir exists"
  ansible.builtin.file:
    path: /etc/autobot
    state: directory
    mode: "0755"
    owner: root
    group: root
  tags: ['npu', 'config']

- name: "NPU Worker | Deploy /etc/autobot/autobot-npu-worker.env"
  ansible.builtin.template:
    src: npu-worker.env.j2
    dest: /etc/autobot/autobot-npu-worker.env
    mode: "0640"
    owner: root
    group: "{{ npu_group }}"
  notify: restart npu-worker
  tags: ['npu', 'config']

# ============================================================
- name: Install NPU worker dependencies
  ansible.builtin.apt:
    name:
      - python3
      - python3-pip
      - python3-venv
      # NumPy / SciPy / OpenVINO linear algebra acceleration
      - libopenblas-dev
      - libblas-dev
      - liblapack-dev
    state: present
    update_cache: true

- name: Create NPU worker directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
    owner: "{{ npu_user }}"
    group: "{{ npu_group }}"
  loop:
    - "{{ npu_install_dir }}"
    - "{{ npu_log_dir }}"
    - "{{ npu_models_dir }}"

- name: Create Python virtual environment
  ansible.builtin.command:
    cmd: python3 -m venv {{ npu_install_dir }}/venv
    creates: "{{ npu_install_dir }}/venv/bin/python"

- name: Fix venv ownership
  ansible.builtin.file:
    path: "{{ npu_install_dir }}/venv"
    state: directory
    owner: "{{ npu_user }}"
    group: "{{ npu_group }}"
    recurse: true

- name: Upgrade pip in venv
  ansible.builtin.pip:
    name: pip
    virtualenv: "{{ npu_install_dir }}/venv"
    state: latest
  become_user: "{{ npu_user }}"

- name: Check if OpenVINO is already installed
  ansible.builtin.command:
    cmd: "{{ npu_install_dir }}/venv/bin/pip show openvino"
  register: _openvino_check
  changed_when: false
  failed_when: false
  become_user: "{{ npu_user }}"

- name: Install FastAPI and web server dependencies
  ansible.builtin.pip:
    name:
      - fastapi>=0.100.0
      - uvicorn[standard]>=0.20.0
    virtualenv: "{{ npu_install_dir }}/venv"
    state: present
  become_user: "{{ npu_user }}"

- name: Install OpenVINO and dependencies
  ansible.builtin.pip:
    name:
      - openvino>=2024.0
      - openvino-dev
      - numpy
      - pillow
      - transformers
      - optimum[openvino]
    virtualenv: "{{ npu_install_dir }}/venv"
    state: present
    extra_args: "--timeout 120"
  become_user: "{{ npu_user }}"
  when:
    - npu_install_openvino | default(true)
    - _openvino_check.rc != 0

- name: Deploy NPU worker script
  ansible.builtin.template:
    src: npu-worker.py.j2
    dest: "{{ npu_install_dir }}/npu-worker.py"
    mode: "0755"
    owner: "{{ npu_user }}"
    group: "{{ npu_group }}"
  notify: restart npu-worker

- name: Deploy NPU worker configuration
  ansible.builtin.template:
    src: npu-worker.env.j2
    dest: "{{ npu_install_dir }}/.env"
    mode: "0600"
    owner: "{{ npu_user }}"
    group: "{{ npu_group }}"
  notify: restart npu-worker

- name: Deploy NPU worker systemd service
  ansible.builtin.template:
    src: autobot-npu-worker.service.j2
    dest: /etc/systemd/system/autobot-npu-worker.service
    mode: "0644"
  notify:
    - reload systemd
    - restart npu-worker

- name: Check if UFW is installed
  ansible.builtin.command: which ufw
  register: _ufw_installed
  changed_when: false
  failed_when: false

- name: Configure UFW for NPU worker
  community.general.ufw:
    rule: allow
    port: "{{ npu_port }}"
    proto: tcp
    comment: "NPU Worker API"
  when: _ufw_installed.rc == 0

- name: Enable and start NPU worker service
  ansible.builtin.systemd:
    name: autobot-npu-worker
    state: started
    enabled: true
    daemon_reload: true
