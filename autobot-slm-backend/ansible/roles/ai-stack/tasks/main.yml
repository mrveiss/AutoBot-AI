# AutoBot - AI-Powered Automation Platform
# Copyright (c) 2025 mrveiss
# Author: mrveiss
#
# AI Stack Role - AI processing components for AutoBot
---

# ============================================================
# Phase 1 CLEAN - remove legacy/wrong-node dirs  (#926 Phase 4)
# ============================================================
- name: "AI Stack | Include clean tasks"
  ansible.builtin.import_tasks: clean.yml
  tags: ['clean']

# ============================================================
# Per-role service account  (#926 Phase 4)
# ============================================================
- name: "AI Stack | Create autobot-ai system group"
  ansible.builtin.group:
    name: "{{ ai_group }}"
    system: true
    state: present
  tags: ['ai', 'users']

- name: "AI Stack | Create per-role service account"
  ansible.builtin.user:
    name: "{{ ai_user }}"
    system: true
    shell: /usr/sbin/nologin
    create_home: false
    group: "{{ ai_group }}"
    comment: "AutoBot AI stack service account"
    state: present
  tags: ['ai', 'users']

# ============================================================
# Per-role env at /etc/autobot/  (#926 Phase 4)
# ============================================================
- name: "AI Stack | Ensure /etc/autobot dir exists"
  ansible.builtin.file:
    path: /etc/autobot
    state: directory
    mode: "0755"
    owner: root
    group: root
  tags: ['ai', 'config']

- name: "AI Stack | Deploy /etc/autobot/autobot-ai-stack.env"
  ansible.builtin.template:
    src: ai-stack.env.j2
    dest: /etc/autobot/autobot-ai-stack.env
    mode: "0640"
    owner: root
    group: "{{ ai_group }}"
  notify: restart ai-stack
  tags: ['ai', 'config']

# ============================================================
- name: Install AI stack dependencies
  ansible.builtin.apt:
    name:
      - python3
      - python3-pip
      - python3-venv
      - build-essential
    state: present
    update_cache: true

- name: Create AI stack directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
    owner: "{{ ai_user }}"
    group: "{{ ai_group }}"
  loop:
    - "{{ ai_install_dir }}"
    - "{{ ai_log_dir }}"
    - "{{ ai_data_dir }}"
    - "{{ ai_data_dir }}/chromadb"

- name: Create Python virtual environment
  ansible.builtin.command:
    cmd: python3 -m venv {{ ai_install_dir }}/venv
    creates: "{{ ai_install_dir }}/venv/bin/python"

- name: Fix venv ownership
  ansible.builtin.file:
    path: "{{ ai_install_dir }}/venv"
    state: directory
    owner: "{{ ai_user }}"
    group: "{{ ai_group }}"
    recurse: true

- name: Upgrade pip in venv
  ansible.builtin.pip:
    name: pip
    virtualenv: "{{ ai_install_dir }}/venv"
    state: latest
  become_user: "{{ ai_user }}"

- name: Check if requirements-ai.txt exists
  ansible.builtin.stat:
    path: "{{ ai_install_dir }}/requirements-ai.txt"
  register: _ai_requirements_file

- name: Install AI Python packages from requirements-ai.txt
  ansible.builtin.pip:
    requirements: "{{ ai_install_dir }}/requirements-ai.txt"
    virtualenv: "{{ ai_install_dir }}/venv"
    state: present
    extra_args: "--timeout 300"
  become_user: "{{ ai_user }}"
  when: _ai_requirements_file.stat.exists

- name: Install AI Python packages (fallback list)
  ansible.builtin.pip:
    name:
      - chromadb>=0.4.0
      - langchain>=0.1.0
      - langchain-community
      - transformers>=4.30.0
      - sentence-transformers
      - torch>=2.0.0
      - numpy
      - pandas
      - pillow
      - openai
      - anthropic
      - fastapi>=0.115.0
      - "uvicorn[standard]>=0.35.0"
      - httpx
      - pydantic>=2.0.0
      - python-dotenv
      - redis>=5.0.0
      - sqlalchemy>=2.0.0
      - aiosqlite
    virtualenv: "{{ ai_install_dir }}/venv"
    state: present
    extra_args: "--timeout 300"
  become_user: "{{ ai_user }}"
  when: not _ai_requirements_file.stat.exists

- name: Deploy AI stack environment file
  ansible.builtin.template:
    src: ai-stack.env.j2
    dest: "{{ ai_install_dir }}/.env"
    mode: "0600"
    owner: "{{ ai_user }}"
    group: "{{ ai_group }}"
  notify: restart ai-stack

- name: Deploy ChromaDB systemd service
  ansible.builtin.template:
    src: autobot-chromadb.service.j2
    dest: /etc/systemd/system/autobot-chromadb.service
    mode: "0644"
  notify:
    - reload systemd
    - restart chromadb

- name: Deploy AI Stack API systemd service
  ansible.builtin.template:
    src: autobot-ai-stack.service.j2
    dest: /etc/systemd/system/autobot-ai-stack.service
    mode: "0644"
  notify:
    - reload systemd
    - restart ai-stack

- name: Enable and start ChromaDB service
  ansible.builtin.systemd:
    name: autobot-chromadb
    state: started
    enabled: true
    daemon_reload: true

- name: Enable and start AI Stack API service
  ansible.builtin.systemd:
    name: autobot-ai-stack
    state: started
    enabled: true
    daemon_reload: true
