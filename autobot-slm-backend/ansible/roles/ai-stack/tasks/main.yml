# AutoBot - AI-Powered Automation Platform
# Copyright (c) 2025 mrveiss
# Author: mrveiss
#
# AI Stack Role - AI processing components for AutoBot
---
- name: Install AI stack dependencies
  ansible.builtin.apt:
    name:
      - python3
      - python3-pip
      - python3-venv
      - build-essential
    state: present
    update_cache: true

- name: Create AI stack directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
    owner: "{{ ai_user }}"
    group: "{{ ai_group }}"
  loop:
    - "{{ ai_install_dir }}"
    - "{{ ai_log_dir }}"
    - "{{ ai_data_dir }}"
    - "{{ ai_data_dir }}/chromadb"

- name: Create Python virtual environment
  ansible.builtin.command:
    cmd: python3 -m venv {{ ai_install_dir }}/venv
    creates: "{{ ai_install_dir }}/venv/bin/python"

- name: Fix venv ownership
  ansible.builtin.file:
    path: "{{ ai_install_dir }}/venv"
    state: directory
    owner: "{{ ai_user }}"
    group: "{{ ai_group }}"
    recurse: true

- name: Check if AI packages are already installed
  ansible.builtin.command:
    cmd: "{{ ai_install_dir }}/venv/bin/pip show chromadb"
  register: _ai_packages_check
  changed_when: false
  failed_when: false
  become_user: "{{ ai_user }}"

- name: Install AI Python packages
  ansible.builtin.pip:
    name:
      - chromadb>=0.4.0
      - langchain>=0.1.0
      - langchain-community
      - transformers>=4.30.0
      - sentence-transformers
      - torch>=2.0.0
      - numpy
      - pillow
      - openai
      - anthropic
    virtualenv: "{{ ai_install_dir }}/venv"
    state: present
    extra_args: "--timeout 120"
  become_user: "{{ ai_user }}"
  when: _ai_packages_check.rc != 0

- name: Deploy AI stack environment file
  ansible.builtin.template:
    src: ai-stack.env.j2
    dest: "{{ ai_install_dir }}/.env"
    mode: "0600"
    owner: "{{ ai_user }}"
    group: "{{ ai_group }}"
  notify: restart ai-stack

- name: Deploy AI stack systemd service
  ansible.builtin.template:
    src: autobot-ai-stack.service.j2
    dest: /etc/systemd/system/autobot-ai-stack.service
    mode: "0644"
  notify:
    - reload systemd
    - restart ai-stack

- name: Enable and start AI stack service
  ansible.builtin.systemd:
    name: autobot-ai-stack
    state: started
    enabled: true
    daemon_reload: true
