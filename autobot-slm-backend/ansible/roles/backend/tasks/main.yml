# AutoBot - AI-Powered Automation Platform
# Copyright (c) 2025 mrveiss
# Author: mrveiss
#
# Backend Role - FastAPI backend deployment for AutoBot
---

# ============================================================
# Phase 1 CLEAN - remove legacy/wrong-node dirs  (#926 Phase 4)
# ============================================================
- name: "Backend | Include clean tasks"
  ansible.builtin.import_tasks: clean.yml
  tags: ['clean']

# ============================================================
# Per-role service account  (#926 Phase 4)
# ============================================================
- name: "Backend | Create per-role service account"
  ansible.builtin.user:
    name: "{{ backend_service_account }}"
    system: true
    shell: /usr/sbin/nologin
    create_home: false
    groups: "{{ backend_group }}"
    append: true
    comment: "AutoBot backend service account"
    state: present
  tags: ['backend', 'users']

# ============================================================
# Per-role env at /etc/autobot/  (#926 Phase 4)
# ============================================================
- name: "Backend | Ensure /etc/autobot dir exists"
  ansible.builtin.file:
    path: /etc/autobot
    state: directory
    mode: "0755"
    owner: root
    group: root
  tags: ['backend', 'config']

- name: "Backend | Deploy /etc/autobot/autobot-backend.env"
  ansible.builtin.template:
    src: backend.env.j2
    dest: /etc/autobot/autobot-backend.env
    mode: "0640"
    owner: root
    group: "{{ backend_service_account }}"
  notify: restart backend
  tags: ['backend', 'config']

# ============================================================
- name: Install Python and build dependencies for pyenv
  ansible.builtin.apt:
    name:
      - python3
      - python3-pip
      - python3-venv
      - git
      - curl
      - build-essential
      - libssl-dev
      - zlib1g-dev
      - libbz2-dev
      - libreadline-dev
      - libsqlite3-dev
      - libncursesw5-dev
      - xz-utils
      - tk-dev
      - libxml2-dev
      - libxmlsec1-dev
      - libffi-dev
      - liblzma-dev
      # GUI / display (VNC, xvfb headless, GUI automation)
      - xvfb
      - x11-utils
      - x11-apps
      # Audio / voice processing (PyAudio, librosa, Whisper)
      - ffmpeg
      - libsndfile1
      - libsndfile1-dev
      - portaudio19-dev
      # OCR / CAPTCHA solver (tesseract, Issue #206)
      - tesseract-ocr
      - libtesseract-dev
      # Matplotlib GUI backend
      - python3-tk
    state: present
    update_cache: true

- name: Check if pyenv is already installed
  ansible.builtin.stat:
    path: "/home/{{ backend_user }}/.pyenv"
  register: pyenv_exists
  become_user: "{{ backend_user }}"

- name: Install pyenv for Python 3.12 management
  ansible.builtin.shell: |
    curl https://pyenv.run | bash
  args:
    creates: "/home/{{ backend_user }}/.pyenv/bin/pyenv"
  become_user: "{{ backend_user }}"
  when: not pyenv_exists.stat.exists

- name: Add pyenv to backend user's bashrc
  ansible.builtin.blockinfile:
    path: "/home/{{ backend_user }}/.bashrc"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - PYENV"
    block: |
      export PYENV_ROOT="$HOME/.pyenv"
      export PATH="$PYENV_ROOT/bin:$PATH"
      eval "$(pyenv init --path)"
      eval "$(pyenv init -)"
    create: yes
  become_user: "{{ backend_user }}"

- name: Install Python 3.12.7 via pyenv
  ansible.builtin.shell: |
    export PYENV_ROOT="/home/{{ backend_user }}/.pyenv"
    export PATH="$PYENV_ROOT/bin:$PATH"
    eval "$(pyenv init --path)"
    pyenv install 3.12.7 --skip-existing
  args:
    executable: /bin/bash
  become_user: "{{ backend_user }}"
  register: pyenv_install
  changed_when: "'Installed' in pyenv_install.stdout"


- name: Create autobot user
  ansible.builtin.user:
    name: "{{ backend_user }}"
    shell: /bin/bash
    create_home: true
    state: present

- name: Create backend directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
    owner: "{{ backend_user }}"
    group: "{{ backend_group }}"
  loop:
    - "{{ backend_install_dir }}"
    - "{{ backend_log_dir }}"
    - "{{ backend_data_dir }}"
    - "{{ backend_data_dir }}/conversation_files"

- name: Create backend symlink for imports
  ansible.builtin.file:
    src: "{{ backend_code_dir }}"
    dest: "{{ backend_install_dir }}/backend"
    state: link
    owner: "{{ backend_user }}"
    group: "{{ backend_group }}"

- name: Create autobot_shared symlink (underscore) so Python can import it
  ansible.builtin.file:
    src: "{{ backend_install_dir }}/autobot-shared"
    dest: "{{ backend_install_dir }}/autobot_shared"
    state: link
    owner: "{{ backend_user }}"
    group: "{{ backend_group }}"

# Issue #912: Deploy error catalog so it is always available on the VM.
# path_constants.py resolves PROJECT_ROOT as 3 levels up from constants/,
# putting CONFIG_DIR at /opt/autobot/infrastructure/shared/config/ which is
# not synced by default. Deploying via Ansible ensures it is always present.
- name: Create infrastructure shared config directory  # Issue #912
  ansible.builtin.file:
    path: "{{ backend_install_dir | dirname }}/infrastructure/shared/config"
    state: directory
    mode: "0755"
    owner: "{{ backend_user }}"
    group: "{{ backend_group }}"

- name: Deploy error catalog to infrastructure config path  # Issue #912
  ansible.builtin.copy:
    src: error_messages.yaml
    dest: "{{ backend_install_dir | dirname }}/infrastructure/shared/config/error_messages.yaml"
    mode: "0644"
    owner: "{{ backend_user }}"
    group: "{{ backend_group }}"

- name: Clone/update AutoBot repository
  ansible.builtin.git:
    repo: "{{ backend_repo_url }}"
    dest: "{{ backend_install_dir }}"
    version: "{{ backend_version }}"
    force: true
  become_user: "{{ backend_user }}"
  when: backend_deploy_from_git | default(true)

- name: Check if valid venv exists
  ansible.builtin.stat:
    path: "{{ backend_code_dir }}/venv/bin/python"
  register: venv_check

- name: Remove old/broken venv if it's a symlink
  ansible.builtin.file:
    path: "{{ backend_code_dir }}/venv"
    state: absent
  when: venv_check.stat.exists and venv_check.stat.islnk

- name: Create Python 3.12 virtual environment with pyenv
  ansible.builtin.shell: |
    export PYENV_ROOT="/home/{{ backend_user }}/.pyenv"
    export PATH="$PYENV_ROOT/bin:$PATH"
    eval "$(pyenv init --path)"
    /home/{{ backend_user }}/.pyenv/versions/3.12.7/bin/python3.12 -m venv {{ backend_code_dir }}/venv
  args:
    creates: "{{ backend_code_dir }}/venv/bin/activate"
    executable: /bin/bash
  become_user: "{{ backend_user }}"

- name: Fix venv ownership
  ansible.builtin.file:
    path: "{{ backend_code_dir }}/venv"
    state: directory
    owner: "{{ backend_user }}"
    group: "{{ backend_group }}"
    recurse: true

- name: Upgrade pip
  ansible.builtin.pip:
    name: pip
    state: latest
    virtualenv: "{{ backend_code_dir }}/venv"
  become_user: "{{ backend_user }}"

- name: Install autobot-shared as editable package
  ansible.builtin.pip:
    name: "{{ backend_install_dir }}/autobot-shared"
    editable: true
    virtualenv: "{{ backend_code_dir }}/venv"
  become_user: "{{ backend_user }}"
  when: backend_install_dir is defined

- name: Install root requirements first
  ansible.builtin.pip:
    requirements: "{{ backend_install_dir }}/requirements.txt"
    virtualenv: "{{ backend_code_dir }}/venv"
  become_user: "{{ backend_user }}"
  environment:
    PIP_USE_DEPRECATED: "legacy-resolver"  # Issue #858: Handle complex OpenTelemetry+ChromaDB dependency graph

- name: Create filtered backend requirements file
  ansible.builtin.shell:
    cmd: "grep -Ev '^-e.*autobot-shared|^-r' {{ backend_code_dir }}/requirements.txt > /tmp/requirements-filtered.txt"
  become_user: "{{ backend_user }}"

- name: Install filtered backend requirements
  ansible.builtin.pip:
    requirements: "/tmp/requirements-filtered.txt"
    virtualenv: "{{ backend_code_dir }}/venv"
  become_user: "{{ backend_user }}"
  environment:
    PIP_USE_DEPRECATED: "legacy-resolver"  # Issue #858: Handle complex OpenTelemetry+ChromaDB dependency graph
  register: pip_install_result
  failed_when: false  # Issue #892: pip module doesn't expose rc, rely on default error handling
  changed_when: pip_install_result.changed

- name: Deploy aioredis compatibility shim for Python 3.12
  ansible.builtin.template:
    src: aioredis_shim.py.j2
    dest: "{{ backend_code_dir }}/venv/lib/python3.12/site-packages/aioredis.py"
    mode: '0644'
    owner: "{{ backend_user }}"
    group: "{{ backend_group }}"

- name: Reinstall autobot-shared to pick up ssot_config fixes
  ansible.builtin.pip:
    name: "{{ backend_install_dir }}/autobot-shared"
    editable: true
    virtualenv: "{{ backend_code_dir }}/venv"
    state: forcereinstall
    extra_args: "--no-deps"
  become_user: "{{ backend_user }}"
  when: backend_install_dir is defined

# ==========================================================
# TLS Certificate Generation (Issue #892)
# ==========================================================
- name: Create TLS certificate directory
  ansible.builtin.file:
    path: /etc/autobot/certs
    state: directory
    mode: "0755"
    owner: root
    group: root

- name: Check if TLS certificate exists
  ansible.builtin.stat:
    path: /etc/autobot/certs/server-cert.pem
  register: backend_cert_stat

- name: Check certificate expiry
  ansible.builtin.command:
    cmd: openssl x509 -checkend 604800 -noout -in /etc/autobot/certs/server-cert.pem
  register: backend_cert_valid
  changed_when: false
  failed_when: false
  when: backend_cert_stat.stat.exists

- name: Generate self-signed TLS certificate
  ansible.builtin.command:
    cmd: >-
      openssl req -x509 -nodes -days 365 -newkey rsa:2048
      -keyout /etc/autobot/certs/server-key.pem
      -out /etc/autobot/certs/server-cert.pem
      -subj '/C=US/ST=State/L=City/O=AutoBot/CN=autobot-backend'
  when: >-
    not backend_cert_stat.stat.exists
    or (backend_cert_valid.rc | default(1)) != 0
  notify: restart backend

- name: Set certificate key permissions
  ansible.builtin.file:
    path: "{{ item }}"
    mode: "0600"
    owner: "{{ backend_user }}"
    group: "{{ backend_group }}"
  loop:
    - /etc/autobot/certs/server-key.pem
    - /etc/autobot/certs/server-cert.pem

- name: Deploy backend environment file (install dir — backwards compat)
  ansible.builtin.template:
    src: backend.env.j2
    dest: "{{ backend_install_dir }}/.env"
    mode: "0600"
    owner: "{{ backend_user }}"
    group: "{{ backend_group }}"
  notify: restart backend

- name: Deploy backend systemd service
  ansible.builtin.template:
    src: autobot-backend.service.j2
    dest: /etc/systemd/system/autobot-backend.service
    mode: "0644"
  notify:
    - reload systemd
    - restart backend

- name: Enable and start backend service
  ansible.builtin.systemd:
    name: autobot-backend
    state: started
    enabled: true
    daemon_reload: true

# Issue #863: Deploy Celery worker service for background tasks
- name: Deploy Celery worker systemd service
  ansible.builtin.template:
    src: autobot-celery.service.j2
    dest: /etc/systemd/system/autobot-celery.service
    mode: "0644"
  notify:
    - reload systemd
    - restart celery

- name: Enable and start Celery worker service
  ansible.builtin.systemd:
    name: autobot-celery
    state: started
    enabled: true
    daemon_reload: true

# ==========================================================
# nginx reverse proxy (Issue #957)
# Holds port backend_nginx_port (8443) permanently so WDF
# rule is evaluated once for nginx, not on every uvicorn restart.
# ==========================================================
- name: "Backend nginx | Install nginx"
  ansible.builtin.apt:
    name: nginx
    state: present
    update_cache: true
  tags: ['backend', 'nginx']

- name: "Backend nginx | Deploy reverse-proxy vhost config"
  ansible.builtin.template:
    src: nginx-backend.conf.j2
    dest: /etc/nginx/sites-available/autobot-backend.conf
    mode: "0644"
    owner: root
    group: root
  notify: reload nginx backend
  tags: ['backend', 'nginx']

- name: "Backend nginx | Enable vhost (symlink)"
  ansible.builtin.file:
    src: /etc/nginx/sites-available/autobot-backend.conf
    dest: /etc/nginx/sites-enabled/autobot-backend.conf
    state: link
  notify: reload nginx backend
  tags: ['backend', 'nginx']

- name: "Backend nginx | Disable default vhost"
  ansible.builtin.file:
    path: /etc/nginx/sites-enabled/default
    state: absent
  notify: reload nginx backend
  tags: ['backend', 'nginx']

- name: "Backend nginx | Validate nginx config"
  ansible.builtin.command: nginx -t
  changed_when: false
  tags: ['backend', 'nginx']

- name: "Backend nginx | Enable and start nginx"
  ansible.builtin.systemd:
    name: nginx
    state: started
    enabled: true
    daemon_reload: true
  tags: ['backend', 'nginx']

# ==========================================================
# UFW loopback0 rule (WSL2 mirrored networking)
# WSL2 mirrored networking routes 127.0.0.1 traffic through
# the loopback0 interface, NOT lo. UFW's default lo accept
# rule does NOT cover loopback0, so nginx→uvicorn (port 8001)
# connections are dropped by UFW INPUT DROP policy.
# This rule is harmless on non-WSL2 hosts (no loopback0 traffic).
# ==========================================================
- name: "Backend | Allow loopback0 interface (WSL2 mirrored networking)"
  community.general.ufw:
    rule: allow
    interface: loopback0
    direction: in
  failed_when: false
  tags: ['backend', 'ufw']
