# AutoBot - AI-Powered Automation Platform
# Copyright (c) 2025 mrveiss
# Author: mrveiss
#
# Backend Role - FastAPI backend deployment for AutoBot
---
- name: Install Python and dependencies
  ansible.builtin.apt:
    name:
      - python3
      - python3-pip
      - python3-venv
      - git
    state: present
    update_cache: true

- name: Create autobot user
  ansible.builtin.user:
    name: "{{ backend_user }}"
    shell: /bin/bash
    create_home: true
    state: present

- name: Create backend directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
    owner: "{{ backend_user }}"
    group: "{{ backend_group }}"
  loop:
    - "{{ backend_install_dir }}"
    - "{{ backend_log_dir }}"
    - "{{ backend_data_dir }}"

- name: Clone/update AutoBot repository
  ansible.builtin.git:
    repo: "{{ backend_repo_url }}"
    dest: "{{ backend_install_dir }}"
    version: "{{ backend_version }}"
    force: true
  become_user: "{{ backend_user }}"
  when: backend_deploy_from_git | default(true)

- name: Create Python virtual environment
  ansible.builtin.command:
    cmd: python3 -m venv {{ backend_code_dir }}/venv
    creates: "{{ backend_code_dir }}/venv/bin/python"

- name: Fix venv ownership
  ansible.builtin.file:
    path: "{{ backend_code_dir }}/venv"
    state: directory
    owner: "{{ backend_user }}"
    group: "{{ backend_group }}"
    recurse: true

- name: Upgrade pip
  ansible.builtin.pip:
    name: pip
    state: latest
    virtualenv: "{{ backend_code_dir }}/venv"
  become_user: "{{ backend_user }}"

- name: Install autobot-shared as editable package
  ansible.builtin.pip:
    name: "{{ backend_install_dir }}/autobot-shared"
    editable: true
    virtualenv: "{{ backend_code_dir }}/venv"
  become_user: "{{ backend_user }}"
  when: backend_install_dir is defined

- name: Install Python requirements (excluding autobot-shared)
  ansible.builtin.shell:
    cmd: "{{ backend_code_dir }}/venv/bin/pip install -r {{ backend_code_dir }}/requirements.txt"
    chdir: "{{ backend_code_dir }}"
  become_user: "{{ backend_user }}"
  environment:
    PIP_NO_BINARY: ":none:"

- name: Deploy backend environment file
  ansible.builtin.template:
    src: backend.env.j2
    dest: "{{ backend_install_dir }}/.env"
    mode: "0600"
    owner: "{{ backend_user }}"
    group: "{{ backend_group }}"
  notify: restart backend

- name: Deploy backend systemd service
  ansible.builtin.template:
    src: autobot-backend.service.j2
    dest: /etc/systemd/system/autobot-backend.service
    mode: "0644"
  notify:
    - reload systemd
    - restart backend

- name: Enable and start backend service
  ansible.builtin.systemd:
    name: autobot-backend
    state: started
    enabled: true
    daemon_reload: true

# Issue #863: Deploy Celery worker service for background tasks
- name: Deploy Celery worker systemd service
  ansible.builtin.template:
    src: autobot-celery.service.j2
    dest: /etc/systemd/system/autobot-celery.service
    mode: "0644"
  notify:
    - reload systemd
    - restart celery

- name: Enable and start Celery worker service
  ansible.builtin.systemd:
    name: autobot-celery
    state: started
    enabled: true
    daemon_reload: true
