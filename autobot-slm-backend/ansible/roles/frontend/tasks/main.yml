---
# Frontend role - Vue.js + nginx deployment for AutoBot web interface

- name: "Frontend | Check if Node.js is already installed"
  ansible.builtin.command:
    cmd: node --version
  register: _node_check
  changed_when: false
  failed_when: false
  tags: ['frontend', 'packages']

- name: "Frontend | Install Node.js prerequisites"
  apt:
    name:
      - curl
      - gnupg
      - ca-certificates
    state: present
  become: yes
  when: _node_check.rc != 0
  tags: ['frontend', 'packages']

- name: "Frontend | Check if NodeSource repo exists"
  ansible.builtin.stat:
    path: /etc/apt/sources.list.d/nodesource.list
  register: _nodesource_repo
  tags: ['frontend', 'packages']

- name: "Frontend | Add NodeSource repository for Node.js"
  ansible.builtin.shell: |
    curl -fsSL https://deb.nodesource.com/setup_{{ nodejs_version }} | bash -
  when:
    - _node_check.rc != 0
    - not _nodesource_repo.stat.exists
  become: yes
  tags: ['frontend', 'packages']

- name: "Frontend | Install Node.js and nginx"
  apt:
    name:
      - nodejs
      - nginx
      - build-essential
    state: present
    update_cache: yes
  become: yes
  when: _node_check.rc != 0
  tags: ['frontend', 'packages']

- name: "Frontend | Ensure nginx is installed"
  apt:
    name: nginx
    state: present
  become: yes
  when: _node_check.rc == 0
  tags: ['frontend', 'packages']

- name: "Frontend | Verify Node.js installation"
  command: node --version
  register: node_version
  changed_when: false
  tags: ['frontend', 'validation']

- name: "Frontend | Display Node.js version"
  debug:
    msg: "Node.js version: {{ node_version.stdout }}"
  tags: ['frontend', 'validation']

- name: "Frontend | Ensure autobot-vue directory exists"
  file:
    path: /home/autobot/autobot-vue
    state: directory
    owner: autobot
    group: autobot
    mode: '0755'
  become: yes
  tags: ['frontend', 'directories']

- name: "Frontend | Check if package.json exists"
  stat:
    path: /home/autobot/autobot-vue/package.json
  register: package_json_path
  tags: ['frontend', 'npm']

- name: "Frontend | Install npm dependencies (if package.json exists)"
  npm:
    path: /home/autobot/autobot-vue
    state: present
  become: yes
  become_user: autobot
  when: package_json_path.stat.exists
  tags: ['frontend', 'npm']
  register: npm_install_result
  ignore_errors: yes

- name: "Frontend | Configure nginx"
  template:
    src: nginx-frontend.conf.j2
    dest: /etc/nginx/sites-available/autobot-frontend
    mode: '0644'
    backup: yes
  become: yes
  notify:
    - test nginx config
    - restart nginx
  tags: ['frontend', 'nginx']

- name: "Frontend | Enable nginx site"
  file:
    src: /etc/nginx/sites-available/autobot-frontend
    dest: /etc/nginx/sites-enabled/autobot-frontend
    state: link
  become: yes
  notify: restart nginx
  tags: ['frontend', 'nginx']

- name: "Frontend | Remove default nginx site"
  file:
    path: /etc/nginx/sites-enabled/default
    state: absent
  become: yes
  notify: restart nginx
  tags: ['frontend', 'nginx']

- name: "Frontend | Create systemd service"
  template:
    src: frontend.service.j2
    dest: /etc/systemd/system/autobot-frontend.service
    mode: '0644'
  become: yes
  notify:
    - reload systemd
    - restart frontend
  tags: ['frontend', 'systemd']

- name: "Frontend | Configure firewall - Allow HTTP"
  ufw:
    rule: allow
    port: "80"
    proto: tcp
    comment: "HTTP"
  become: yes
  notify: reload firewall
  tags: ['frontend', 'firewall']

- name: "Frontend | Configure firewall - Allow HTTPS"
  ufw:
    rule: allow
    port: "443"
    proto: tcp
    comment: "HTTPS"
  become: yes
  notify: reload firewall
  tags: ['frontend', 'firewall']

- name: "Frontend | Configure firewall - Allow Frontend Dev Server"
  ufw:
    rule: allow
    port: "{{ frontend_port }}"
    proto: tcp
    from_ip: "{{ network_subnet }}"
    comment: "Frontend Dev Server"
  become: yes
  notify: reload firewall
  tags: ['frontend', 'firewall']

- name: "Frontend | Enable and start nginx"
  systemd:
    name: nginx
    enabled: yes
    state: started
    daemon_reload: yes
  become: yes
  tags: ['frontend', 'service']

- name: "Frontend | Enable frontend service"
  systemd:
    name: autobot-frontend
    enabled: yes
    daemon_reload: yes
  become: yes
  tags: ['frontend', 'service']

- name: "Frontend | Display configuration summary"
  debug:
    msg:
      - "=== Frontend Configuration Complete ==="
      - "Node.js: {{ node_version.stdout }}"
      - "Frontend URL: http://{{ ansible_default_ipv4.address }}"
      - "Dev Server: http://{{ ansible_default_ipv4.address }}:{{ frontend_port }}"
      - "Nginx: Enabled"
      - "Service: autobot-frontend (configured)"
      - "Note: Service will start when code is synced"
  tags: ['frontend', 'report']
