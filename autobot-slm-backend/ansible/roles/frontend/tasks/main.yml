---
# Frontend role - User frontend (autobot-frontend) deployment
# Serves production build via nginx + SSL on Frontend VM (.21)

- name: "Frontend | Check if Node.js is already installed"
  ansible.builtin.command:
    cmd: node --version
  register: _node_check
  changed_when: false
  failed_when: false
  tags: ['frontend', 'packages']

- name: "Frontend | Install Node.js prerequisites"
  apt:
    name:
      - curl
      - gnupg
      - ca-certificates
    state: present
  become: yes
  when: _node_check.rc != 0
  tags: ['frontend', 'packages']

- name: "Frontend | Check if NodeSource repo exists"
  ansible.builtin.stat:
    path: /etc/apt/sources.list.d/nodesource.list
  register: _nodesource_repo
  tags: ['frontend', 'packages']

- name: "Frontend | Add NodeSource repository for Node.js"
  ansible.builtin.shell: |
    curl -fsSL https://deb.nodesource.com/setup_{{ nodejs_version }} | bash -
  when:
    - _node_check.rc != 0
    - not _nodesource_repo.stat.exists
  become: yes
  tags: ['frontend', 'packages']

- name: "Frontend | Install Node.js and nginx"
  apt:
    name:
      - nodejs
      - nginx
      - build-essential
    state: present
    update_cache: yes
  become: yes
  when: _node_check.rc != 0
  tags: ['frontend', 'packages']

- name: "Frontend | Ensure nginx is installed"
  apt:
    name: nginx
    state: present
  become: yes
  when: _node_check.rc == 0
  tags: ['frontend', 'packages']

- name: "Frontend | Verify Node.js installation"
  command: node --version
  register: node_version
  changed_when: false
  tags: ['frontend', 'validation']

- name: "Frontend | Ensure frontend directory exists"
  file:
    path: "{{ frontend_install_dir }}/autobot-frontend"
    state: directory
    owner: "{{ frontend_user }}"
    group: "{{ frontend_group }}"
    mode: '0755'
  become: yes
  tags: ['frontend', 'directories']

- name: "Frontend | Ensure TLS cert directory exists"
  file:
    path: "{{ frontend_tls_cert_dir }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  become: yes
  tags: ['frontend', 'tls']

- name: "Frontend | Check existing TLS certificate"
  stat:
    path: "{{ frontend_tls_cert }}"
  register: _tls_cert
  tags: ['frontend', 'tls']

- name: "Frontend | Generate self-signed TLS certificate"
  command: >
    openssl req -x509 -nodes
    -newkey rsa:2048
    -days 365
    -keyout {{ frontend_tls_key }}
    -out {{ frontend_tls_cert }}
    -subj "/CN={{ ansible_host | default('172.16.168.21') }}/O=AutoBot/C=US"
  become: yes
  when: not _tls_cert.stat.exists
  notify: restart nginx
  tags: ['frontend', 'tls']

- name: "Frontend | Set TLS key permissions"
  file:
    path: "{{ frontend_tls_key }}"
    owner: root
    group: root
    mode: '0644'
  become: yes
  when: not _tls_cert.stat.exists
  tags: ['frontend', 'tls']

- name: "Frontend | Check if package.json exists"
  stat:
    path: "{{ frontend_install_dir }}/autobot-frontend/package.json"
  register: package_json_path
  tags: ['frontend', 'npm']

- name: "Frontend | Install npm dependencies"
  community.general.npm:
    path: "{{ frontend_install_dir }}/autobot-frontend"
    state: present
  become: yes
  become_user: "{{ frontend_user }}"
  environment:
    CYPRESS_INSTALL_BINARY: "0"
  when: package_json_path.stat.exists
  tags: ['frontend', 'npm']
  ignore_errors: yes

- name: "Frontend | Build production frontend"
  command: npx vite build
  args:
    chdir: "{{ frontend_install_dir }}/autobot-frontend"
  become: yes
  become_user: "{{ frontend_user }}"
  when: package_json_path.stat.exists
  tags: ['frontend', 'build']

- name: "Frontend | Configure nginx"
  template:
    src: nginx-frontend.conf.j2
    dest: /etc/nginx/sites-available/autobot-frontend
    mode: '0644'
    backup: yes
  become: yes
  notify:
    - test nginx config
    - restart nginx
  tags: ['frontend', 'nginx']

- name: "Frontend | Enable nginx site"
  file:
    src: /etc/nginx/sites-available/autobot-frontend
    dest: /etc/nginx/sites-enabled/autobot-frontend
    state: link
  become: yes
  notify: restart nginx
  tags: ['frontend', 'nginx']

- name: "Frontend | Remove default nginx site"
  file:
    path: /etc/nginx/sites-enabled/default
    state: absent
  become: yes
  notify: restart nginx
  tags: ['frontend', 'nginx']

- name: "Frontend | Configure firewall - Allow HTTP"
  ufw:
    rule: allow
    port: "{{ nginx_http_port }}"
    proto: tcp
    comment: "HTTP (redirects to HTTPS)"
  become: yes
  notify: reload firewall
  tags: ['frontend', 'firewall']

- name: "Frontend | Configure firewall - Allow HTTPS"
  ufw:
    rule: allow
    port: "{{ frontend_port }}"
    proto: tcp
    comment: "HTTPS"
  become: yes
  notify: reload firewall
  tags: ['frontend', 'firewall']

- name: "Frontend | Enable and start nginx"
  systemd:
    name: nginx
    enabled: yes
    state: started
    daemon_reload: yes
  become: yes
  tags: ['frontend', 'service']

- name: "Frontend | Stop legacy Vite dev server (if running)"
  systemd:
    name: autobot-frontend
    state: stopped
    enabled: no
  become: yes
  ignore_errors: yes
  tags: ['frontend', 'cleanup']

- name: "Frontend | Display configuration summary"
  debug:
    msg:
      - "=== Frontend Configuration Complete ==="
      - "Node.js: {{ node_version.stdout }}"
      - "Frontend URL: https://{{ ansible_default_ipv4.address }}"
      - "TLS: Enabled ({{ frontend_tls_cert }})"
      - "API Proxy: {{ backend_host }}:{{ backend_port }}"
      - "Nginx: Enabled (production build)"
  tags: ['frontend', 'report']
