# AutoBot - AI-Powered Automation Platform
# Copyright (c) 2025 mrveiss
# Author: mrveiss
#
# SLM Manager Role - Configures the SLM server (172.16.168.19)
# Expects code to be already synced via rsync before running.
---

# ============================================================
# Phase 1 CLEAN - remove legacy/wrong-node dirs  (#926 Phase 4)
# ============================================================
- name: "SLM | Include clean tasks"
  ansible.builtin.import_tasks: clean.yml
  tags: ['clean']

# ==========================================================
# System packages (assume blank host)
# ==========================================================
- name: "SLM | Install prerequisites"
  ansible.builtin.apt:
    name:
      - curl
      - gnupg
      - ca-certificates
      - python3
      - python3-pip
      - python3-venv
      - nginx
      - openssl
      - software-properties-common
      - build-essential
    state: present
    update_cache: true
  tags: ['slm', 'packages']

# ==========================================================
# Ansible PPA (for latest Ansible 2.17+)
# ==========================================================
- name: "SLM | Add Ansible PPA repository"
  ansible.builtin.apt_repository:
    repo: ppa:ansible/ansible
    state: present
    update_cache: true
  tags: ['slm', 'packages', 'ansible']

- name: "SLM | Install Ansible from PPA (2.17+)"
  ansible.builtin.apt:
    name: ansible
    state: present
  tags: ['slm', 'packages', 'ansible']

- name: "SLM | Check if NodeSource repo exists"
  ansible.builtin.stat:
    path: /etc/apt/sources.list.d/nodesource.list
  register: slm_nodesource_repo
  tags: ['slm', 'packages']

- name: "SLM | Add NodeSource repository for Node.js 20.x"
  ansible.builtin.shell: |
    curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
  when: not slm_nodesource_repo.stat.exists
  tags: ['slm', 'packages']

- name: "SLM | Install Node.js (includes npm)"
  ansible.builtin.apt:
    name: nodejs
    state: present
    update_cache: true
  tags: ['slm', 'packages']

# ==========================================================
# User and directories
# ==========================================================
- name: "SLM | Ensure autobot user exists"
  ansible.builtin.user:
    name: "{{ slm_user }}"
    shell: /bin/bash
    create_home: true
    state: present
  tags: ['slm', 'user']

- name: "SLM | Create directory structure"
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
    owner: "{{ slm_user }}"
    group: "{{ slm_group }}"
  loop:
    - "{{ slm_base_dir }}"
    - "{{ slm_backend_dir }}"
    - "{{ slm_frontend_dir }}"
    - "{{ slm_shared_dir }}"
    - "{{ slm_log_dir }}"
    - "{{ slm_certs_dir }}"
  tags: ['slm', 'directories']

# ==========================================================
# TLS certificates (idempotent - skip if valid cert exists)
# ==========================================================
- name: "SLM | Check if TLS certificate exists"
  ansible.builtin.stat:
    path: "{{ slm_tls_cert }}"
  register: slm_cert_stat
  tags: ['slm', 'tls']

- name: "SLM | Check certificate expiry"
  ansible.builtin.command:
    cmd: openssl x509 -checkend 604800 -noout -in {{ slm_tls_cert }}
  register: slm_cert_valid
  changed_when: false
  failed_when: false
  when: slm_cert_stat.stat.exists
  tags: ['slm', 'tls']

- name: "SLM | Generate self-signed TLS certificate"
  ansible.builtin.command:
    cmd: >-
      openssl req -x509 -nodes -days {{ slm_tls_days }} -newkey rsa:2048
      -keyout {{ slm_tls_key }}
      -out {{ slm_tls_cert }}
      -subj '{{ slm_tls_subject }}'
  when: >-
    not slm_cert_stat.stat.exists
    or (slm_cert_valid.rc | default(1)) != 0
  notify: restart nginx
  tags: ['slm', 'tls']

- name: "SLM | Set certificate key permissions"
  ansible.builtin.file:
    path: "{{ slm_tls_key }}"
    mode: "0600"
    owner: root
    group: root
  tags: ['slm', 'tls']

# Issue #1103: Prevent nginx start when SSL cert missing
- name: "SLM | Create nginx systemd override directory"
  ansible.builtin.file:
    path: /etc/systemd/system/nginx.service.d
    state: directory
    mode: "0755"
  tags: ['slm', 'nginx', 'tls']

- name: "SLM | Deploy nginx SSL cert pre-check"
  ansible.builtin.template:
    src: nginx-override.conf.j2
    dest: /etc/systemd/system/nginx.service.d/ssl-cert-check.conf
    mode: "0644"
  notify:
    - reload systemd
    - restart nginx
  tags: ['slm', 'nginx', 'tls']

# ==========================================================
# Backend Python venv and dependencies
# ==========================================================
- name: "SLM | Check if requirements.txt exists"
  ansible.builtin.stat:
    path: "{{ slm_backend_dir }}/requirements.txt"
  register: slm_requirements_stat
  tags: ['slm', 'backend']

- name: "SLM | Check venv Python version matches system"
  ansible.builtin.shell:
    cmd: >-
      {{ slm_backend_dir }}/venv/bin/python3 --version 2>/dev/null
      | grep -oP '\d+\.\d+'
  register: _venv_py_version
  changed_when: false
  failed_when: false
  when: slm_requirements_stat.stat.exists
  tags: ['slm', 'backend']

- name: "SLM | Get system Python version"
  ansible.builtin.shell:
    cmd: python3 --version | grep -oP '\d+\.\d+'
  register: _sys_py_version
  changed_when: false
  when: slm_requirements_stat.stat.exists
  tags: ['slm', 'backend']

- name: "SLM | Remove stale venv after OS/Python upgrade"
  ansible.builtin.file:
    path: "{{ slm_backend_dir }}/venv"
    state: absent
  when:
    - slm_requirements_stat.stat.exists
    - _venv_py_version.rc != 0 or _venv_py_version.stdout != _sys_py_version.stdout
  tags: ['slm', 'backend']

- name: "SLM | Create Python virtual environment"
  ansible.builtin.command:
    cmd: python3 -m venv {{ slm_backend_dir }}/venv
    creates: "{{ slm_backend_dir }}/venv/bin/python"
  become_user: "{{ slm_user }}"
  when: slm_requirements_stat.stat.exists
  tags: ['slm', 'backend']

- name: "SLM | Bootstrap pip in virtual environment"
  ansible.builtin.command:
    cmd: "{{ slm_backend_dir }}/venv/bin/python3 -m ensurepip --upgrade"
  become_user: "{{ slm_user }}"
  when: slm_requirements_stat.stat.exists
  changed_when: true
  tags: ['slm', 'backend']

# Issue #937: Sync and install autobot-shared before requirements (prometheus metrics)
- name: "SLM | Sync autobot-shared to SLM server"
  ansible.posix.synchronize:
    src: "{{ playbook_dir }}/../../autobot-shared/"
    dest: "{{ slm_base_dir }}/autobot-shared/"
    rsync_opts:
      - "--exclude=__pycache__"
      - "--exclude=*.pyc"
      - "--exclude=*.egg-info"
      - "--exclude=.git"
  when: slm_requirements_stat.stat.exists
  tags: ['slm', 'backend']

- name: "SLM | Install autobot-shared in venv (editable)"
  ansible.builtin.command:
    cmd: "{{ slm_backend_dir }}/venv/bin/pip install -e {{ slm_base_dir }}/autobot-shared"
  become_user: "{{ slm_user }}"
  when: slm_requirements_stat.stat.exists
  changed_when: true
  tags: ['slm', 'backend']

- name: "SLM | Install Python requirements"
  ansible.builtin.pip:
    requirements: "{{ slm_backend_dir }}/requirements.txt"
    virtualenv: "{{ slm_backend_dir }}/venv"
    state: present
  become_user: "{{ slm_user }}"
  when: slm_requirements_stat.stat.exists
  tags: ['slm', 'backend']

# ==========================================================
# Security secrets (idempotent - generate once, keep forever)
# ==========================================================
- name: "SLM | Check if secrets file exists"
  ansible.builtin.stat:
    path: "{{ slm_credentials_dir }}/{{ slm_credentials_file }}"
  register: slm_secrets_stat
  tags: ['slm', 'secrets']

- name: "SLM | Generate security secrets"
  ansible.builtin.set_fact:
    slm_secret_key: "{{ lookup('password', '/dev/null length=48 chars=ascii_letters,digits') }}"
    slm_encryption_key: "{{ lookup('password', '/dev/null length=48 chars=ascii_letters,digits') }}"
    slm_admin_password: >-
      {{ slm_admin_password
         if (slm_admin_password | default('') | length > 0)
         else lookup('password', '/dev/null length=24 chars=ascii_letters,digits') }}
  when: not slm_secrets_stat.stat.exists
  no_log: true
  tags: ['slm', 'secrets']

- name: "SLM | Deploy secrets file"
  ansible.builtin.template:
    src: slm-secrets.env.j2
    dest: "{{ slm_credentials_dir }}/{{ slm_credentials_file }}"
    owner: "{{ slm_user }}"
    group: "{{ slm_group }}"
    mode: "0600"
  when: not slm_secrets_stat.stat.exists
  no_log: true
  tags: ['slm', 'secrets']

# ==========================================================
# Backend systemd service
# ==========================================================
- name: "SLM | Deploy backend systemd service"
  ansible.builtin.template:
    src: autobot-slm-backend.service.j2
    dest: /etc/systemd/system/{{ slm_backend_service }}.service
    mode: "0644"
  notify:
    - reload systemd
    - restart slm backend
  tags: ['slm', 'backend', 'systemd']

- name: "SLM | Enable backend service"
  ansible.builtin.systemd:
    name: "{{ slm_backend_service }}"
    enabled: true
    daemon_reload: true
  tags: ['slm', 'backend', 'systemd']

# ==========================================================
# Frontend build
# ==========================================================
- name: "SLM | Check if package.json exists"
  ansible.builtin.stat:
    path: "{{ slm_frontend_dir }}/package.json"
  register: slm_package_json
  tags: ['slm', 'frontend']

- name: "SLM | Install frontend npm dependencies"
  community.general.npm:
    path: "{{ slm_frontend_dir }}"
    state: present
  become_user: "{{ slm_user }}"
  when: slm_frontend_build and slm_package_json.stat.exists
  tags: ['slm', 'frontend']

- name: "SLM | Build frontend for production"
  ansible.builtin.command:
    cmd: npm run build
    chdir: "{{ slm_frontend_dir }}"
  become_user: "{{ slm_user }}"
  when: slm_frontend_build and slm_package_json.stat.exists
  register: slm_frontend_build_result
  changed_when: slm_frontend_build_result.rc == 0
  tags: ['slm', 'frontend']

# ==========================================================
# Grafana monitoring (Issue #853)
# ==========================================================
- name: "SLM | Include Grafana configuration tasks"
  ansible.builtin.import_tasks: grafana.yml
  tags: ['slm', 'grafana']

# ==========================================================
# Nginx configuration
# ==========================================================
- name: "SLM | Deploy nginx configuration"
  ansible.builtin.template:
    src: autobot-slm.conf.j2
    dest: /etc/nginx/sites-available/{{ slm_nginx_config }}
    mode: "0644"
    backup: true
  notify:
    - test nginx config
    - reload nginx
  tags: ['slm', 'nginx']

- name: "SLM | Enable nginx site"
  ansible.builtin.file:
    src: /etc/nginx/sites-available/{{ slm_nginx_config }}
    dest: /etc/nginx/sites-enabled/{{ slm_nginx_config }}
    state: link
  notify: reload nginx
  tags: ['slm', 'nginx']

- name: "SLM | Remove default nginx site"
  ansible.builtin.file:
    path: /etc/nginx/sites-enabled/default
    state: absent
  notify: reload nginx
  tags: ['slm', 'nginx']

- name: "SLM | Ensure nginx is running"
  ansible.builtin.systemd:
    name: nginx
    state: started
    enabled: true
  tags: ['slm', 'nginx']

# ==========================================================
# Firewall
# ==========================================================
- name: "SLM | Allow HTTP"
  community.general.ufw:
    rule: allow
    port: "80"
    proto: tcp
    comment: "HTTP - AutoBot SLM"
  ignore_errors: true
  tags: ['slm', 'firewall']

- name: "SLM | Allow HTTPS"
  community.general.ufw:
    rule: allow
    port: "443"
    proto: tcp
    comment: "HTTPS - AutoBot SLM"
  ignore_errors: true
  tags: ['slm', 'firewall']

# ==========================================================
# Start services
# ==========================================================
- name: "SLM | Start backend service"
  ansible.builtin.systemd:
    name: "{{ slm_backend_service }}"
    state: started
  ignore_errors: true
  tags: ['slm', 'service']

- name: "SLM | Flush handlers to apply pending restarts"
  ansible.builtin.meta: flush_handlers
  tags: ['slm', 'service']

- name: "SLM | Wait for backend port to be ready"
  ansible.builtin.wait_for:
    host: "{{ slm_backend_host }}"
    port: "{{ slm_backend_port }}"
    delay: 3
    timeout: 60
    state: started
  tags: ['slm', 'service']

- name: "SLM | Verify backend health via API"
  ansible.builtin.uri:
    url: "http://{{ slm_backend_host }}:{{ slm_backend_port }}/api/health"
    method: GET
    status_code: 200
  register: _slm_health
  retries: 10
  delay: 3
  until: _slm_health.status == 200
  tags: ['slm', 'service']

- name: "SLM | Export admin password for downstream plays"
  ansible.builtin.shell:
    cmd: >-
      grep '^SLM_ADMIN_PASSWORD='
      {{ slm_credentials_dir }}/{{ slm_credentials_file }}
      | cut -d= -f2
  register: _slm_admin_password_result
  changed_when: false
  no_log: true
  tags: ['slm', 'service']

- name: "SLM | Set admin password fact for seed play"
  ansible.builtin.set_fact:
    slm_admin_password: "{{ _slm_admin_password_result.stdout }}"
  no_log: true
  tags: ['slm', 'service']

- name: "SLM | Display deployment summary"
  ansible.builtin.debug:
    msg:
      - "=== SLM Manager Deployment Complete ==="
      - "Backend: {{ slm_backend_host }}:{{ slm_backend_port }}"
      - "Frontend: {{ slm_frontend_dir }}/dist"
      - "Nginx: HTTPS on port 443"
      - "TLS cert: {{ slm_tls_cert }}"
      - "Logs: {{ slm_log_dir }}/"
  tags: ['slm', 'report']
