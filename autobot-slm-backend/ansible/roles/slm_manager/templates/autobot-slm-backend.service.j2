[Unit]
Description=AutoBot SLM Backend Service
After=network.target
Wants=network-online.target

[Service]
Type=simple
User={{ slm_user }}
Group={{ slm_group }}
WorkingDirectory={{ slm_backend_dir }}
Environment="PATH={{ slm_backend_dir }}/venv/bin:/usr/local/bin:/usr/bin:/bin"
EnvironmentFile=-{{ postgresql_credentials_dir }}/{{ postgresql_credentials_file }}
EnvironmentFile=-{{ slm_credentials_dir }}/{{ slm_credentials_file }}
ExecStart={{ slm_backend_dir }}/venv/bin/uvicorn main:app --host {{ slm_backend_host }} --port {{ slm_backend_port }}
ExecReload=/bin/kill -HUP $MAINPID
Restart=on-failure
RestartSec=5
StandardOutput=append:{{ slm_log_dir }}/slm-backend.log
StandardError=append:{{ slm_log_dir }}/slm-backend-error.log

# Security hardening
# NoNewPrivileges intentionally omitted: the backend needs sudo systemctl
# for self-restart during GUI-triggered SLM sync (#926 code_sync.py)
PrivateTmp=true
ProtectSystem=strict
ProtectHome=read-only
ReadWritePaths={{ slm_base_dir }} /var/lib/slm

[Install]
WantedBy=multi-user.target
