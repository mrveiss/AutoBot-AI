# AutoBot - AI-Powered Automation Platform
# Copyright (c) 2025 mrveiss
# Author: mrveiss
#
# TTS Worker Role - Kani-TTS-2 text-to-speech service (#928)
---

# ============================================================
# Per-role service account
# ============================================================
- name: "TTS Worker | Create autobot-tts system group"
  ansible.builtin.group:
    name: "{{ tts_group }}"
    system: true
    state: present
  tags: ['tts', 'users']

- name: "TTS Worker | Create per-role service account"
  ansible.builtin.user:
    name: "{{ tts_user }}"
    system: true
    shell: /usr/sbin/nologin
    create_home: false
    group: "{{ tts_group }}"
    comment: "AutoBot TTS worker service account"
    state: present
  tags: ['tts', 'users']

# ============================================================
# Per-role env at /etc/autobot/
# ============================================================
- name: "TTS Worker | Ensure /etc/autobot dir exists"
  ansible.builtin.file:
    path: /etc/autobot
    state: directory
    mode: "0755"
    owner: root
    group: root
  tags: ['tts', 'config']

- name: "TTS Worker | Deploy /etc/autobot/autobot-tts-worker.env"
  ansible.builtin.template:
    src: tts-worker.env.j2
    dest: /etc/autobot/autobot-tts-worker.env
    mode: "0640"
    owner: root
    group: "{{ tts_group }}"
  notify: restart tts-worker
  tags: ['tts', 'config']

# ============================================================
# System dependencies
# ============================================================
- name: "TTS Worker | Install system dependencies"
  ansible.builtin.apt:
    name:
      - python3
      - python3-pip
      - python3-venv
      - libsndfile1
    state: present
    update_cache: true
  tags: ['tts', 'packages']

# ============================================================
# Directories
# ============================================================
- name: "TTS Worker | Create service directories"
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
    owner: "{{ tts_user }}"
    group: "{{ tts_group }}"
  loop:
    - "{{ tts_install_dir }}"
    - "{{ tts_log_dir }}"
    - "{{ tts_models_dir }}"
  tags: ['tts', 'dirs']

# ============================================================
# Python venv
# ============================================================
- name: "TTS Worker | Create Python virtual environment"
  ansible.builtin.command:
    cmd: python3 -m venv {{ tts_install_dir }}/venv
    creates: "{{ tts_install_dir }}/venv/bin/python"
  tags: ['tts', 'venv']

- name: "TTS Worker | Fix venv ownership"
  ansible.builtin.file:
    path: "{{ tts_install_dir }}/venv"
    state: directory
    owner: "{{ tts_user }}"
    group: "{{ tts_group }}"
    recurse: true
  tags: ['tts', 'venv']

- name: "TTS Worker | Upgrade pip in venv"
  ansible.builtin.pip:
    name: pip
    virtualenv: "{{ tts_install_dir }}/venv"
    state: latest
  become_user: "{{ tts_user }}"
  tags: ['tts', 'venv']

- name: "TTS Worker | Install FastAPI and server dependencies"
  ansible.builtin.pip:
    name:
      - fastapi>=0.100.0
      - uvicorn[standard]>=0.20.0
      - python-multipart>=0.0.6
      - aiofiles>=23.0.0
    virtualenv: "{{ tts_install_dir }}/venv"
    state: present
  become_user: "{{ tts_user }}"
  tags: ['tts', 'packages']

- name: "TTS Worker | Install torch CPU-only (avoids 4GB NVIDIA CUDA wheels)"
  ansible.builtin.pip:
    name:
      - torch>=2.0.0
    virtualenv: "{{ tts_install_dir }}/venv"
    state: present
    extra_args: "--index-url https://download.pytorch.org/whl/cpu --timeout 300"
  become_user: "{{ tts_user }}"
  when: "not tts_device.startswith('cuda')"
  tags: ['tts', 'packages']

- name: "TTS Worker | Install torch with CUDA support (GPU node)"
  ansible.builtin.pip:
    name:
      - torch>=2.0.0
    virtualenv: "{{ tts_install_dir }}/venv"
    state: present
    extra_args: "--timeout 300"
  become_user: "{{ tts_user }}"
  when: "tts_device.startswith('cuda')"
  tags: ['tts', 'packages']

- name: "TTS Worker | Install kani-tts-2 package and audio dependencies"
  ansible.builtin.pip:
    name:
      - kani-tts-2
      - soundfile>=0.12.0
      - numpy>=1.24.0
      - huggingface_hub>=0.20.0
    virtualenv: "{{ tts_install_dir }}/venv"
    state: present
    extra_args: "--timeout 300"
  become_user: "{{ tts_user }}"
  tags: ['tts', 'packages']

- name: "TTS Worker | Pin transformers==4.56.0 (required by kani-tts-2)"
  ansible.builtin.pip:
    name:
      - "transformers==4.56.0"
    virtualenv: "{{ tts_install_dir }}/venv"
    state: present
    extra_args: "--upgrade --timeout 300"
  become_user: "{{ tts_user }}"
  tags: ['tts', 'packages']

# ============================================================
# Deploy service files
# ============================================================
- name: "TTS Worker | Deploy tts-worker.py"
  ansible.builtin.template:
    src: tts-worker.py.j2
    dest: "{{ tts_install_dir }}/tts-worker.py"
    mode: "0755"
    owner: "{{ tts_user }}"
    group: "{{ tts_group }}"
  notify: restart tts-worker
  tags: ['tts', 'deploy']

- name: "TTS Worker | Deploy .env file"
  ansible.builtin.template:
    src: tts-worker.env.j2
    dest: "{{ tts_install_dir }}/.env"
    mode: "0600"
    owner: "{{ tts_user }}"
    group: "{{ tts_group }}"
  notify: restart tts-worker
  tags: ['tts', 'deploy']

- name: "TTS Worker | Deploy systemd service"
  ansible.builtin.template:
    src: autobot-tts-worker.service.j2
    dest: /etc/systemd/system/autobot-tts-worker.service
    mode: "0644"
  notify:
    - reload systemd
    - restart tts-worker
  tags: ['tts', 'deploy']

# ============================================================
# Firewall
# ============================================================
- name: "TTS Worker | Check if UFW is installed"
  ansible.builtin.command: which ufw
  register: _ufw_installed
  changed_when: false
  failed_when: false
  tags: ['tts', 'firewall']

- name: "TTS Worker | Allow TTS worker port via UFW"
  community.general.ufw:
    rule: allow
    port: "{{ tts_port }}"
    proto: tcp
    comment: "TTS Worker API"
  when: _ufw_installed.rc == 0
  tags: ['tts', 'firewall']

# ============================================================
# Enable and start
# ============================================================
- name: "TTS Worker | Enable and start service"
  ansible.builtin.systemd:
    name: autobot-tts-worker
    state: started
    enabled: true
    daemon_reload: true
  tags: ['tts', 'service']
