#!/bin/bash
# Redis Stack Backup Script for AutoBot
# Generated by Ansible - Redis Role

set -e

BACKUP_DIR="/var/backups/redis"
REDIS_DATA_DIR="/var/lib/redis-stack"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
RETENTION_DAYS={{ redis_backup_retention_days }}

echo "[$(date)] Starting Redis Stack backup..."

# Create backup directory if it doesn't exist
mkdir -p "$BACKUP_DIR"

# Trigger Redis save
redis-cli -h {{ ansible_default_ipv4.address }} -p {{ redis_port }} BGSAVE

# Wait for save to complete
sleep 5
while redis-cli -h {{ ansible_default_ipv4.address }} -p {{ redis_port }} LASTSAVE | grep -q "$(date +%s)"; do
    echo "Waiting for BGSAVE to complete..."
    sleep 2
done

# Copy dump file
if [ -f "$REDIS_DATA_DIR/dump.rdb" ]; then
    cp "$REDIS_DATA_DIR/dump.rdb" "$BACKUP_DIR/dump-$TIMESTAMP.rdb"
    echo "[$(date)] Backup created: dump-$TIMESTAMP.rdb"
else
    echo "[$(date)] ERROR: dump.rdb not found"
    exit 1
fi

# Copy AOF file if persistence is enabled
{% if redis_persistence %}
if [ -f "$REDIS_DATA_DIR/appendonly.aof" ]; then
    cp "$REDIS_DATA_DIR/appendonly.aof" "$BACKUP_DIR/appendonly-$TIMESTAMP.aof"
    echo "[$(date)] AOF backup created: appendonly-$TIMESTAMP.aof"
fi
{% endif %}

# Compress backups
cd "$BACKUP_DIR"
tar -czf "redis-backup-$TIMESTAMP.tar.gz" dump-$TIMESTAMP.rdb {% if redis_persistence %}appendonly-$TIMESTAMP.aof{% endif %}
rm -f dump-$TIMESTAMP.rdb {% if redis_persistence %}appendonly-$TIMESTAMP.aof{% endif %}

echo "[$(date)] Backup compressed: redis-backup-$TIMESTAMP.tar.gz"

# Cleanup old backups
find "$BACKUP_DIR" -name "redis-backup-*.tar.gz" -mtime +$RETENTION_DAYS -delete
echo "[$(date)] Old backups cleaned up (retention: $RETENTION_DAYS days)"

echo "[$(date)] Redis Stack backup complete"
