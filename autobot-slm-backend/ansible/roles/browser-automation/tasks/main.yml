# AutoBot - AI-Powered Automation Platform
# Copyright (c) 2025 mrveiss
# Author: mrveiss
#
# Browser Automation Role - Playwright browser automation for AutoBot
---
- name: Install browser dependencies
  ansible.builtin.apt:
    name:
      - nodejs
      - npm
      - xvfb
      - libxcomposite1
      - libxdamage1
      - libxrandr2
      - libgbm1
      - libpango-1.0-0
      - libcairo2
      - libasound2
      - libatspi2.0-0
      - libcups2
      - libdbus-1-3
      - libdrm2
      - libgtk-3-0
      - libnspr4
      - libnss3
      - libxshmfence1
    state: present
    update_cache: true

- name: Create browser automation directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
    owner: "{{ browser_user }}"
    group: "{{ browser_group }}"
  loop:
    - "{{ browser_install_dir }}"
    - "{{ browser_log_dir }}"

- name: Initialize npm package
  ansible.builtin.command:
    cmd: npm init -y
    chdir: "{{ browser_install_dir }}"
    creates: "{{ browser_install_dir }}/package.json"
  become_user: "{{ browser_user }}"

- name: Install Playwright
  community.general.npm:
    name: "playwright"
    path: "{{ browser_install_dir }}"
    state: present
  become_user: "{{ browser_user }}"

- name: Install Playwright MCP server
  community.general.npm:
    name: "@anthropic/mcp-server-playwright"
    path: "{{ browser_install_dir }}"
    state: present
  become_user: "{{ browser_user }}"
  when: browser_install_mcp | default(true)

- name: Install Playwright browsers
  ansible.builtin.command:
    cmd: npx playwright install chromium
    chdir: "{{ browser_install_dir }}"
  become_user: "{{ browser_user }}"
  changed_when: false

- name: Deploy browser automation systemd service
  ansible.builtin.template:
    src: browser-automation.service.j2
    dest: /etc/systemd/system/browser-automation.service
    mode: "0644"
  notify:
    - reload systemd
    - restart browser-automation

- name: Enable and start browser automation service
  ansible.builtin.systemd:
    name: browser-automation
    state: started
    enabled: true
    daemon_reload: true
