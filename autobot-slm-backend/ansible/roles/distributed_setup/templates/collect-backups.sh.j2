#!/bin/bash
# AutoBot - AI-Powered Automation Platform
# Copyright (c) 2025 mrveiss
# Author: mrveiss
#
# Collect backups from all distributed AutoBot VMs
# Generated by Ansible - DO NOT EDIT MANUALLY

set -e

# Load environment
[ -f "{{ config_dir }}/distributed/environment.env" ] && source "{{ config_dir }}/distributed/environment.env"

BACKUP_DIR="{{ backup_dir }}/distributed/$(date +%Y%m%d_%H%M%S)"
mkdir -p "$BACKUP_DIR"

echo "Collecting backups from distributed AutoBot infrastructure..."
echo "Backup directory: $BACKUP_DIR"

# Backup local data
echo "Backing up local data..."
[ -d "{{ project_root }}/data" ] && cp -r "{{ project_root }}/data" "$BACKUP_DIR/local_data"
[ -d "{{ config_dir }}" ] && cp -r "{{ config_dir }}" "$BACKUP_DIR/local_config"

{% for node in fleet_nodes %}
# Backup from {{ node.name }}
echo "Collecting logs from {{ node.name }} ({{ node.host }})..."
if ssh -o ConnectTimeout=5 -o BatchMode=yes "{{ service_user }}@{{ node.host }}" "test -d {{ logs_dir }}" 2>/dev/null; then
    mkdir -p "$BACKUP_DIR/logs/{{ node.name }}"
    scp -r "{{ service_user }}@{{ node.host }}:{{ logs_dir }}/*" "$BACKUP_DIR/logs/{{ node.name }}/" 2>/dev/null || true
    echo "{{ node.name }} logs collected"
else
    echo "Could not collect logs from {{ node.name }} (SSH required)"
fi

{% endfor %}

echo "Backup collection complete: $BACKUP_DIR"
echo ""
echo "Backup size: $(du -sh $BACKUP_DIR | cut -f1)"
