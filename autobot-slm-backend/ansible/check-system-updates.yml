# AutoBot - AI-Powered Automation Platform
# Copyright (c) 2025 mrveiss
# Author: mrveiss
#
# Check System Updates Playbook
# Discovers available apt package updates on fleet nodes.
# Output is parsed by the SLM backend to populate UpdateInfo records.
---

- name: Check System Updates
  hosts: "{{ target_hosts | default('all') }}"
  become: true
  gather_facts: true

  tasks:
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 0
      when: ansible_os_family == "Debian"

    - name: Get list of upgradable packages
      ansible.builtin.shell: |
        apt list --upgradable 2>/dev/null | grep -v '^Listing' | head -500
      register: upgradable_raw
      changed_when: false
      when: ansible_os_family == "Debian"

    - name: Get held packages
      ansible.builtin.shell: |
        apt-mark showhold 2>/dev/null || true
      register: held_packages
      changed_when: false
      when: ansible_os_family == "Debian"

    - name: Get security sources
      ansible.builtin.shell: |
        grep -l security /etc/apt/sources.list /etc/apt/sources.list.d/*.list 2>/dev/null | head -1 || echo ""
      register: security_source
      changed_when: false
      when: ansible_os_family == "Debian"

    - name: Check security updates separately
      ansible.builtin.shell: |
        apt list --upgradable 2>/dev/null | grep -i security | head -200 || true
      register: security_updates_raw
      changed_when: false
      when: ansible_os_family == "Debian"

    - name: Parse upgradable packages into JSON
      ansible.builtin.set_fact:
        parsed_packages: >-
          {{
            upgradable_raw.stdout_lines | default([])
            | map('regex_replace', '^([^ /]+)/\S+ (\S+) \S+ \[upgradable from: ([^\]]+)\]$', '{"p":"\1","a":"\2","c":"\3"}')
            | select('match', '^\{')
            | list
          }}
        held_list: "{{ (held_packages.stdout_lines | default([])) }}"
        security_pkgs: >-
          {{
            security_updates_raw.stdout_lines | default([])
            | map('regex_replace', '^([^ /]+)/.*', '\1')
            | list
          }}
      when: ansible_os_family == "Debian"

    - name: Output discovered packages as JSON
      ansible.builtin.debug:
        msg: >-
          AUTOBOT_UPDATES_JSON:{{ {
            'hostname': ansible_hostname,
            'ip_address': ansible_default_ipv4.address | default('unknown'),
            'os_family': ansible_os_family,
            'packages': parsed_packages | default([]),
            'held': held_list | default([]),
            'security_packages': security_pkgs | default([]),
            'total': (parsed_packages | default([])) | length
          } | to_json }}
