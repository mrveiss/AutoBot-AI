# AutoBot - AI-Powered Automation Platform
# Copyright (c) 2025 mrveiss
# Author: mrveiss
#
# Check System Updates Playbook
# Checks for available system package updates across fleet nodes
---

- name: Check System Updates
  hosts: "{{ target_hosts | default('all') }}"
  become: true
  gather_facts: true

  vars:
    check_security_only: "{{ check_security_only | default(false) }}"
    output_format: "{{ output_format | default('json') }}"

  tasks:
    # =========================================================================
    # UPDATE CACHE
    # =========================================================================
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600
      when: ansible_os_family == "Debian"

    - name: Update yum cache
      ansible.builtin.yum:
        update_cache: true
      when: ansible_os_family == "RedHat"

    # =========================================================================
    # CHECK FOR UPDATES
    # =========================================================================
    - name: Check for available updates (Debian/Ubuntu)
      ansible.builtin.shell: |
        apt list --upgradable 2>/dev/null | grep -v "^Listing" | awk -F'/' '{print $1}' | sort
      register: available_updates_debian
      changed_when: false
      when: ansible_os_family == "Debian"
      ignore_errors: true

    - name: Count available updates
      ansible.builtin.set_fact:
        update_count: "{{ available_updates_debian.stdout_lines | length }}"
      when: ansible_os_family == "Debian"

    # =========================================================================
    # CHECK FOR SECURITY UPDATES
    # =========================================================================
    - name: Check for security updates (Ubuntu)
      ansible.builtin.shell: |
        unattended-upgrade --dry-run -d 2>&1 | grep "^Inst" | wc -l
      register: security_updates_count
      changed_when: false
      when:
        - ansible_distribution == "Ubuntu"
        - check_security_only | bool
      ignore_errors: true

    # =========================================================================
    # CHECK IF REBOOT REQUIRED
    # =========================================================================
    - name: Check if reboot is required
      ansible.builtin.stat:
        path: /var/run/reboot-required
      register: reboot_required

    - name: Get reboot reason
      ansible.builtin.command:
        cmd: cat /var/run/reboot-required.pkgs
      register: reboot_packages
      changed_when: false
      when: reboot_required.stat.exists
      ignore_errors: true

    # =========================================================================
    # GET CURRENT KERNEL VERSION
    # =========================================================================
    - name: Get running kernel version
      ansible.builtin.command:
        cmd: uname -r
      register: running_kernel
      changed_when: false

    - name: Get installed kernel version
      ansible.builtin.shell: |
        dpkg -l | grep linux-image | awk '{print $2}' | sort -V | tail -1
      register: installed_kernel
      changed_when: false
      when: ansible_os_family == "Debian"

    # =========================================================================
    # SUMMARY REPORT
    # =========================================================================
    - name: Generate update summary
      ansible.builtin.set_fact:
        update_summary:
          hostname: "{{ ansible_hostname }}"
          ip_address: "{{ ansible_default_ipv4.address }}"
          os: "{{ ansible_distribution }} {{ ansible_distribution_version }}"
          total_updates: "{{ update_count | default(0) | int }}"
          security_updates: "{{ security_updates_count.stdout | default(0) | int }}"
          reboot_required: "{{ reboot_required.stat.exists }}"
          reboot_reason: "{{ reboot_packages.stdout_lines | default([]) | join(', ') }}"
          running_kernel: "{{ running_kernel.stdout }}"
          installed_kernel: "{{ installed_kernel.stdout | default('unknown') }}"
          available_packages: "{{ available_updates_debian.stdout_lines | default([]) }}"

    - name: Display update summary
      ansible.builtin.debug:
        msg: |
          ╔════════════════════════════════════════════════════════════╗
          ║          SYSTEM UPDATE CHECK                               ║
          ╠════════════════════════════════════════════════════════════╣
          ║ Host:        {{ ansible_hostname }}                        ║
          ║ OS:          {{ ansible_distribution }} {{ ansible_distribution_version }} ║
          ║                                                            ║
          ║ Total Updates:    {{ update_count | default(0) }}         ║
          ║ Security Updates: {{ security_updates_count.stdout | default(0) }} ║
          ║ Reboot Required:  {{ 'Yes' if reboot_required.stat.exists else 'No' }} ║
          ║                                                            ║
          ║ Running Kernel:   {{ running_kernel.stdout }}             ║
          ║ Installed Kernel: {{ installed_kernel.stdout | default('unknown') }} ║
          ╚════════════════════════════════════════════════════════════╝

    # Save summary to file for API consumption
    - name: Save update summary to file
      ansible.builtin.copy:
        content: "{{ update_summary | to_json }}"
        dest: "/tmp/update-check-{{ ansible_hostname }}.json"
        mode: '0644'
      delegate_to: localhost
