# AutoBot - AI-Powered Automation Platform
# Copyright (c) 2025 mrveiss
# Author: mrveiss
#
# Emergency backup admin user setup
# Creates a secondary sudo user in case primary user is locked out
#
# Usage:
#   ansible-playbook -i inventory.yml setup-backup-admin.yml -e "backup_admin_password=YourSecurePassword"
#
# Or with SSH key only (no password):
#   ansible-playbook -i inventory.yml setup-backup-admin.yml
---
- name: Setup backup admin user for emergency access
  hosts: all
  become: true
  gather_facts: true

  vars:
    backup_admin_user: "autobot_admin"
    backup_admin_comment: "AutoBot Backup Admin (Emergency Access)"
    backup_admin_shell: "/bin/bash"
    # Password provided via command line: -e "backup_admin_password=YourSecurePassword"
    # Will be hashed automatically
    backup_admin_password: ""
    # Use the same SSH key as autobot user for emergency access
    copy_autobot_ssh_key: true

  tasks:
    - name: Create backup admin group
      ansible.builtin.group:
        name: "{{ backup_admin_user }}"
        state: present

    - name: Create backup admin user
      ansible.builtin.user:
        name: "{{ backup_admin_user }}"
        comment: "{{ backup_admin_comment }}"
        shell: "{{ backup_admin_shell }}"
        groups:
          - sudo
          - "{{ backup_admin_user }}"
        append: true
        create_home: true
        state: present
      register: user_created

    - name: Set backup admin password (if provided)
      ansible.builtin.user:
        name: "{{ backup_admin_user }}"
        password: "{{ backup_admin_password | password_hash('sha512') }}"
      when: backup_admin_password | length > 0

    - name: Configure passwordless sudo for backup admin
      ansible.builtin.copy:
        dest: "/etc/sudoers.d/{{ backup_admin_user }}"
        content: |
          # AutoBot Backup Admin - Emergency Access
          # Created: {{ ansible_date_time.iso8601 }}
          # WARNING: This user has full root access
          {{ backup_admin_user }} ALL=(ALL) NOPASSWD: ALL
        mode: "0440"
        owner: root
        group: root
        validate: "visudo -cf %s"

    - name: Setup SSH directory for backup admin
      ansible.builtin.file:
        path: "/home/{{ backup_admin_user }}/.ssh"
        state: directory
        owner: "{{ backup_admin_user }}"
        group: "{{ backup_admin_user }}"
        mode: "0700"

    - name: Copy autobot SSH authorized_keys to backup admin
      ansible.builtin.copy:
        src: /home/autobot/.ssh/authorized_keys
        dest: "/home/{{ backup_admin_user }}/.ssh/authorized_keys"
        remote_src: true
        owner: "{{ backup_admin_user }}"
        group: "{{ backup_admin_user }}"
        mode: "0600"
      when: copy_autobot_ssh_key
      ignore_errors: true

    - name: Verify backup admin can sudo
      ansible.builtin.command:
        cmd: "sudo -u {{ backup_admin_user }} sudo whoami"
      register: sudo_test
      changed_when: false

    - name: Display setup result
      ansible.builtin.debug:
        msg: |
          ✓ Backup admin '{{ backup_admin_user }}' created on {{ inventory_hostname }}
          ✓ Sudo test: {{ sudo_test.stdout }}
          {% if backup_admin_password | length == 0 %}
          ⚠ No password set - SSH key only access
          To set a password: ssh {{ ansible_host }} "sudo passwd {{ backup_admin_user }}"
          {% else %}
          ✓ Password has been set
          {% endif %}
