# AutoBot - AI-Powered Automation Platform
# Copyright (c) 2025 mrveiss
# Author: mrveiss
---
# Setup AI Stack from Blank Ubuntu 22.04
#
# This playbook provisions the AI processing stack with:
# - ChromaDB vector database
# - Ollama LLM runtime (optional)
# - Model storage
# - API endpoints
#
# Usage:
#   ansible-playbook setup-ai-stack.yml --limit ai-stack
#   ansible-playbook setup-ai-stack.yml --limit 172.16.168.24

- name: Setup AI Stack Node
  hosts: ai_stack
  become: true
  gather_facts: true

  vars:
    ai_stack_install_dir: /opt/autobot/ai-stack
    ai_stack_user: autobot
    ai_stack_group: autobot
    chromadb_port: 8000
    chromadb_data_dir: /var/lib/autobot/chromadb
    ollama_port: 11434
    enable_ollama: false

  pre_tasks:
    - name: Display provisioning info
      debug:
        msg: |
          ═══════════════════════════════════════════════════════════════
          AI Stack Node Provisioning
          ═══════════════════════════════════════════════════════════════
          Target: {{ inventory_hostname }} ({{ ansible_host }})
          ChromaDB Port: {{ chromadb_port }}
          Ollama: {{ 'Enabled' if enable_ollama else 'Disabled' }}
          Data: {{ chromadb_data_dir }}
          ═══════════════════════════════════════════════════════════════

  roles:
    - role: common
      tags: [common, base]

    - role: ai-stack
      tags: [ai, chromadb]

    - role: llm
      tags: [llm, ollama]
      when: enable_ollama | default(false)

  post_tasks:
    - name: Verify ChromaDB service
      systemd:
        name: autobot-chromadb
        state: started
        enabled: true
      tags: [verify]

    - name: Verify AI Stack API service
      systemd:
        name: autobot-ai-stack
        state: started
        enabled: true
      tags: [verify]

    - name: Check ChromaDB health
      uri:
        url: "http://{{ ansible_host }}:{{ chromadb_port }}/api/v1/heartbeat"
        status_code: [200, 404]
        timeout: 5
      register: chromadb_check
      failed_when: false
      tags: [verify]

    - name: Check AI Stack API health
      uri:
        url: "http://{{ ansible_host }}:{{ ai_stack_port | default(8080) }}/health"
        status_code: [200, 404]
        timeout: 5
      register: ai_stack_check
      failed_when: false
      tags: [verify]

    - name: Display setup summary
      debug:
        msg: |
          ═══════════════════════════════════════════════════════════════
          AI Stack Setup Complete
          ═══════════════════════════════════════════════════════════════
          ChromaDB: {{ 'Running' if chromadb_check.status | default(0) == 200 else 'Starting' }}
          ChromaDB URL: http://{{ ansible_host }}:{{ chromadb_port }}
          AI Stack API: {{ 'Running' if ai_stack_check.status | default(0) == 200 else 'Starting' }}
          AI Stack URL: http://{{ ansible_host }}:{{ ai_stack_port | default(8080) }}
          Ollama: Remote on {{ ollama_host }}:{{ ollama_port }}
          Data: {{ chromadb_data_dir }}
          ═══════════════════════════════════════════════════════════════
      tags: [verify]
