# AutoBot - AI-Powered Automation Platform
# Copyright (c) 2025 mrveiss
# Author: mrveiss
---
# Setup Browser Worker Node from Blank Ubuntu 22.04
#
# This playbook provisions a complete browser automation worker with:
# - Playwright + Chromium
# - autobot-browser-worker service
# - Screenshot storage
# - Systemd service configuration
# - TLS certificates
#
# Usage:
#   ansible-playbook setup-browser-worker.yml --limit browser-worker
#   ansible-playbook setup-browser-worker.yml --limit 172.16.168.25

- name: Setup Browser Worker Node
  hosts: browser_worker
  become: true
  gather_facts: true

  vars:
    browser_worker_install_dir: /opt/autobot
    browser_worker_code_dir: "{{ browser_worker_install_dir }}/autobot-browser-worker"
    browser_worker_user: autobot
    browser_worker_group: autobot
    browser_worker_port: 3000
    browser_worker_service_name: autobot-browser-worker
    backend_host: "172.16.168.20"
    backend_port: 8001

  pre_tasks:
    - name: Display provisioning info
      debug:
        msg: |
          ═══════════════════════════════════════════════════════════════
          Browser Worker Node Provisioning
          ═══════════════════════════════════════════════════════════════
          Target: {{ inventory_hostname }} ({{ ansible_host }})
          Code: {{ browser_worker_code_dir }}
          Port: {{ browser_worker_port }}
          User: {{ browser_worker_user }}
          ═══════════════════════════════════════════════════════════════

  roles:
    - role: common
      tags: [common, base]

    - role: browser
      tags: [browser, worker]

  post_tasks:
    - name: Verify browser worker service
      systemd:
        name: "{{ browser_worker_service_name }}"
        state: started
        enabled: true
      tags: [verify]

    - name: Check browser worker health
      uri:
        url: "http://{{ ansible_host }}:{{ browser_worker_port }}/health"
        status_code: [200, 404]
        timeout: 5
      register: health_check
      failed_when: false
      tags: [verify]

    - name: Display setup summary
      debug:
        msg: |
          ═══════════════════════════════════════════════════════════════
          Browser Worker Setup Complete
          ═══════════════════════════════════════════════════════════════
          Service: {{ browser_worker_service_name }}
          Status: {{ 'Running' if health_check.status == 200 else 'Not responding' }}
          URL: http://{{ ansible_host }}:{{ browser_worker_port }}
          Code: {{ browser_worker_code_dir }}
          ═══════════════════════════════════════════════════════════════
      tags: [verify]
