---
# Database VM Configuration (VM3)
# Services: Redis Stack, Model storage, Data persistence

# ==========================================
# REDIS CONFIGURATION
# ==========================================

redis:
  # Installation configuration
  version: "7.4"
  package: "redis-stack-server"
  service: "redis-stack-server"

  # Basic configuration
  bind: "0.0.0.0"  # Allow connections from all VMs
  port: 6379
  protected_mode: false  # Disabled for internal network

  # Memory and persistence
  memory:
    maxmemory: "6gb"
    maxmemory_policy: "allkeys-lru"

  persistence:
    # RDB snapshots
    save:
      - "900 1"    # Save if at least 1 key changed in 900 seconds
      - "300 10"   # Save if at least 10 keys changed in 300 seconds
      - "60 10000" # Save if at least 10000 keys changed in 60 seconds
    rdb_filename: "autobot-dump.rdb"
    rdb_dir: "/var/lib/redis-stack"

    # AOF (Append Only File)
    appendonly: true
    appendfilename: "autobot-appendonly.aof"
    appendfsync: "everysec"

  # Performance tuning
  performance:
    tcp_keepalive: 300
    timeout: 0
    tcp_backlog: 511
    databases: 16
    # Multi-threaded I/O (Redis 6.0+) - utilizes multiple CPU cores
    # Recommended: (total_cores - 2) for best performance
    # Redis VM has 12 cores, so use 10 I/O threads
    io_threads: 10  # Enable multi-threaded I/O for vector operations

  # Connection pooling configuration
  connection:
    max_connections: 50  # Increased from 20 for higher load
    min_connections: 5
    timeout: 5
    socket_timeout: 5    # Increased from 2 for slower operations
    socket_connect_timeout: 2
    retry_on_timeout: true

  # Log configuration
  log:
    level: "notice"
    file: "/var/log/redis-stack/redis-server.log"
    syslog_enabled: true
    syslog_ident: "redis-stack"

# ==========================================
# REDIS INSIGHT CONFIGURATION
# ==========================================

redis_insight:
  enabled: true
  port: 8001  # Internal port (exposed as 8002 externally)
  bind: "0.0.0.0"

  # Configuration
  config:
    analytics_enabled: false
    auto_discover_databases: true

  # Security (for internal network)
  security:
    https_enabled: false
    auth_enabled: false  # Internal network only

# ==========================================
# DATABASE SCHEMA ORGANIZATION
# ==========================================

database_schema:
  # Redis database assignments (matching complete.yaml)
  databases:
    main:
      id: 0
      description: "Main application data and RediSearch indexes"
      backup_priority: "critical"
      note: "MUST be DB 0 for RediSearch compatibility"

    knowledge:
      id: 0
      description: "Knowledge base vectors and documents (RediSearch)"
      backup_priority: "critical"
      note: "RediSearch indexes REQUIRE DB 0"

    metrics:
      id: 1
      description: "Performance metrics and monitoring data"
      backup_priority: "low"

    prompts:
      id: 2
      description: "Prompt templates and management"
      backup_priority: "medium"

    agents:
      id: 3
      description: "Agent communication and coordination"
      backup_priority: "high"

    cache:
      id: 4
      description: "General application cache"
      backup_priority: "low"

    sessions:
      id: 6
      description: "User sessions and authentication"
      backup_priority: "high"

    chat_history:
      id: 8
      description: "Chat conversation history"
      backup_priority: "high"

    backup:
      id: 10
      description: "Backup and recovery data"
      backup_priority: "medium"

    testing:
      id: 15
      description: "Test data (isolated from production)"
      backup_priority: "low"

# ==========================================
# MODEL STORAGE CONFIGURATION
# ==========================================

model_storage:
  # Storage directories
  directories:
    base_dir: "/var/lib/autobot/models"
    cache_dir: "/var/lib/autobot/models/cache"
    versions_dir: "/var/lib/autobot/models/versions"
    temp_dir: "/tmp/autobot/models"

  # Storage limits
  limits:
    max_total_size: "50gb"
    max_file_size: "5gb"
    max_cache_age: 30  # days

  # Model categories
  categories:
    embeddings:
      path: "{{ model_storage.directories.base_dir }}/embeddings"
      formats: ["bin", "safetensors", "onnx"]

    language_models:
      path: "{{ model_storage.directories.base_dir }}/llm"
      formats: ["gguf", "bin", "safetensors"]

    vision_models:
      path: "{{ model_storage.directories.base_dir }}/vision"
      formats: ["onnx", "pb", "tflite"]

    audio_models:
      path: "{{ model_storage.directories.base_dir }}/audio"
      formats: ["onnx", "pb", "wav2vec2"]

# ==========================================
# BACKUP CONFIGURATION
# ==========================================

backup:
  # Backup schedule
  schedule:
    # Critical data (knowledge, main) - every 4 hours
    critical:
      frequency: "0 */4 * * *"
      databases: [0]  # main and knowledge (both on DB 0)
      retention: 72  # hours

    # High priority data - every 6 hours
    high:
      frequency: "0 */6 * * *"
      databases: [3, 6, 8]  # agents, sessions, chat_history
      retention: 48  # hours

    # Medium priority data - daily
    medium:
      frequency: "0 2 * * *"
      databases: [2, 5, 9]  # prompts, logs, models
      retention: 168  # hours (7 days)

    # Full backup - weekly
    full:
      frequency: "0 1 * * 0"  # Sunday 1 AM
      databases: "all"
      retention: 2160  # hours (90 days)

  # Backup methods
  methods:
    redis_dump:
      enabled: true
      command: "redis-cli --rdb"
      compression: true

    filesystem_sync:
      enabled: true
      tool: "rsync"
      compression: true

  # Backup destinations
  destinations:
    local:
      path: "/opt/autobot/backups/database"
      enabled: true

    network:
      enabled: false  # Can be enabled for network storage
      host: "backup.autobot.internal"
      path: "/backups/autobot/database"

# ==========================================
# SYSTEMD SERVICE CONFIGURATION
# ==========================================

systemd_services:
  # Redis Stack Server
  - name: "redis-stack-server"
    description: "Redis Stack Server for AutoBot"
    type: "simple"
    user: "autobot"
    group: "autobot"
    exec_start: "/opt/redis-stack/bin/redis-stack-server /etc/redis-stack/redis-stack.conf"
    restart: "always"
    restart_sec: 5

    # Service dependencies
    wants:
      - "network-online.target"
    after:
      - "network-online.target"
    requires:
      - "network-online.target"

    # Resource limits
    limit_nofile: 65536
    limit_memlock: "infinity"

  # Model Storage Management
  - name: "autobot-model-manager"
    description: "AutoBot Model Storage Manager"
    type: "simple"
    user: "{{ autobot.user }}"
    group: "{{ autobot.group }}"
    working_directory: "{{ model_storage.directories.base_dir }}"
    exec_start: "/opt/autobot/scripts/model-manager.py"
    restart: "always"
    restart_sec: 30

    # Service dependencies
    wants:
      - "network-online.target"
      - "redis-stack-server.service"
    after:
      - "network-online.target"
      - "redis-stack-server.service"

  # Backup Service
  - name: "autobot-backup"
    description: "AutoBot Database Backup Service"
    type: "oneshot"
    user: "{{ autobot.user }}"
    group: "{{ autobot.group }}"
    exec_start: "/opt/autobot/scripts/backup-database.sh"

    # Timer configuration (runs via systemd timer)
    timer:
      on_calendar: "{{ backup.schedule.critical.frequency }}"
      persistent: true

# ==========================================
# FIREWALL CONFIGURATION
# ==========================================

ufw_rules:
  # Redis database port
  - rule: allow
    port: 6379
    protocol: tcp
    src: "172.16.168.0/24"
    comment: "Redis Stack database"

  # RedisInsight web interface
  - rule: allow
    port: 8002
    protocol: tcp
    src: "172.16.168.0/24"
    comment: "RedisInsight web interface"

  # Model storage HTTP API (if enabled)
  - rule: allow
    port: 8003
    protocol: tcp
    src: "172.16.168.0/24"
    comment: "Model storage API"

# ==========================================
# MONITORING CONFIGURATION
# ==========================================

monitoring:
  # Redis monitoring
  redis_monitoring:
    enabled: true

    # Key metrics to monitor
    metrics:
      - "used_memory"
      - "connected_clients"
      - "total_connections_received"
      - "total_commands_processed"
      - "keyspace_hits"
      - "keyspace_misses"
      - "expired_keys"
      - "evicted_keys"

    # Thresholds
    thresholds:
      memory_usage: 85  # percent
      connection_count: 100
      hit_rate: 90  # percent

  # Model storage monitoring
  model_monitoring:
    enabled: true
    check_interval: 300  # seconds

    # Disk usage monitoring
    disk_thresholds:
      warning: 80   # percent
      critical: 90  # percent

  # Health checks
  health_checks:
    - name: "redis-ping"
      command: "redis-cli ping"
      expected_output: "PONG"
      interval: 30

    - name: "redis-info"
      command: "redis-cli info server"
      check_pattern: "redis_version"
      interval: 60

    - name: "model-storage"
      command: "df -h {{ model_storage.directories.base_dir }}"
      check_pattern: "{{ model_storage.directories.base_dir }}"
      interval: 300

# ==========================================
# SECURITY CONFIGURATION
# ==========================================

security:
  # Redis security
  redis_security:
    # Authentication enabled for security
    auth_enabled: true
    password: "{{ vault_redis_password }}"

    # Access control (Redis 6.0+)
    acl_enabled: false

    # Network security
    protected_mode: false  # Internal network only
    bind_all_interfaces: true

  # File system security
  filesystem:
    # Model storage permissions
    model_storage_permissions:
      owner: "{{ autobot.user }}"
      group: "{{ autobot.group }}"
      directories: "755"
      files: "644"

    # Redis data permissions
    redis_data_permissions:
      owner: "autobot"
      group: "autobot"
      directories: "750"
      files: "640"

# ==========================================
# PERFORMANCE TUNING
# ==========================================

performance:
  # System-level optimizations
  system:
    # Kernel parameters for Redis
    kernel_params:
      vm.overcommit_memory: 1
      net.core.somaxconn: 1024
      vm.swappiness: 1

    # Disable transparent huge pages (Redis recommendation)
    transparent_hugepages: "never"

  # Redis-specific optimizations
  redis_optimization:
    # Client connections
    tcp_backlog: 511
    tcp_keepalive: 300

    # Memory optimization
    hash_max_ziplist_entries: 512
    hash_max_ziplist_value: 64
    list_max_ziplist_entries: 512
    list_max_ziplist_value: 64

    # I/O optimization
    stop_writes_on_bgsave_error: false
    rdbcompression: true
    rdbchecksum: true

# ==========================================
# CLEANUP CONFIGURATION
# ==========================================

cleanup:
  # Automated cleanup tasks
  tasks:
    # Clean expired keys
    - name: "cleanup-expired"
      schedule: "0 * * * *"  # hourly
      command: "redis-cli EVAL 'return redis.call(\"DEL\", unpack(redis.call(\"KEYS\", \"*:expired:*\")))' 0"

    # Clean old logs
    - name: "cleanup-logs"
      schedule: "0 2 * * *"  # daily at 2 AM
      command: "find /var/log/redis-stack -name '*.log' -mtime +30 -delete"

    # Model cache cleanup
    - name: "cleanup-model-cache"
      schedule: "0 3 * * *"  # daily at 3 AM
      command: "/opt/autobot/scripts/cleanup-model-cache.sh"

  # Retention policies
  retention:
    logs: 30        # days
    temp_files: 7   # days
    cache_files: 30 # days
