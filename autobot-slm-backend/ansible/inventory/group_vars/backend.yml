---
# Backend VM Configuration (VM2)
# Services: FastAPI, Python 3.10+, Log aggregation

# ==========================================
# BACKEND SERVICE CONFIGURATION
# ==========================================

backend:
  # Python and FastAPI configuration
  python:
    version: "3.10"
    pip_version: "latest"
    virtual_env: "{{ autobot.base_dir }}/backend/venv"
    packages_file: "{{ autobot.base_dir }}/requirements.txt"

  # FastAPI application
  fastapi:
    app_name: "autobot-backend"
    app_module: "backend.fast_app_factory_fix:app"
    host: "0.0.0.0"
    port: 8001
    workers: 4
    worker_class: "uvicorn.workers.UvicornWorker"
    worker_connections: 1000
    max_requests: 1000
    max_requests_jitter: 50
    timeout: 30
    keepalive: 2

  # Application directories
  directories:
    app_dir: "{{ autobot.base_dir }}/backend"
    log_dir: "/var/log/autobot/backend"
    data_dir: "/var/lib/autobot/backend"
    config_dir: "/etc/autobot/backend"

  # Environment variables
  environment:
    PYTHONPATH: "{{ autobot.base_dir }}"
    FASTAPI_ENV: "production"
    LOG_LEVEL: "INFO"

    # Service connections
    AUTOBOT_REDIS_HOST: "{{ redis_host }}"
    AUTOBOT_REDIS_PORT: "{{ redis_port }}"
    AUTOBOT_AI_STACK_HOST: "{{ ai_stack_host }}"
    AUTOBOT_AI_STACK_PORT: "{{ ai_stack_port }}"
    AUTOBOT_NPU_WORKER_HOST: "{{ npu_worker_host }}"
    AUTOBOT_NPU_WORKER_PORT: "{{ npu_worker_port }}"

    # Database configuration
    AUTOBOT_REDIS_DB_MAIN: 0
    AUTOBOT_REDIS_DB_KNOWLEDGE: 1
    AUTOBOT_REDIS_DB_PROMPTS: 2
    AUTOBOT_REDIS_DB_AGENTS: 3
    AUTOBOT_REDIS_DB_METRICS: 4
    AUTOBOT_REDIS_DB_LOGS: 5
    AUTOBOT_REDIS_DB_SESSIONS: 6
    AUTOBOT_REDIS_DB_WORKFLOWS: 7
    AUTOBOT_REDIS_DB_VECTORS: 8
    AUTOBOT_REDIS_DB_MODELS: 9
    AUTOBOT_REDIS_DB_TESTING: 15

    # AI/ML configuration
    TF_USE_LEGACY_KERAS: 1
    KERAS_BACKEND: "tensorflow"

    # Deployment settings
    AUTOBOT_DEPLOYMENT_MODE: "production"  # Infrastructure mode: local/hybrid/distributed/production
    AUTOBOT_USER_MODE: "single_user"       # User management: single_user/single_company/multi_company/provider
    AUTOBOT_BACKEND_HOST: "0.0.0.0"
    AUTOBOT_BACKEND_PORT: 8001

# ==========================================
# SYSTEM PACKAGES
# ==========================================

packages:
  system:
    - python3
    - python3-pip
    - python3-venv
    - python3-dev
    - build-essential
    - curl
    - wget
    - git
    - rsyslog
    - logrotate
    - supervisor
    - htop
    - iotop
    - netcat
    - redis-tools

  python:
    # Core framework dependencies
    - fastapi>=0.115.0
    - uvicorn>=0.30.0
    - gunicorn>=20.1.0
    - aiohttp>=3.12.15
    - aiofiles>=23.0.0
    - websockets>=11.0.0
    - pydantic>=2.8.0
    - python-multipart>=0.0.9

    # Database and caching
    - redis>=5.0.0
    - aiosqlite>=0.17.0

    # AI/ML dependencies
    - torch>=2.0.0
    - transformers>=4.55.2
    - sentence-transformers>=2.2.0

    # Monitoring and logging
    - prometheus-client>=0.16.0
    - structlog>=22.0.0

# ==========================================
# SYSTEMD SERVICE CONFIGURATION
# ==========================================

systemd_services:
  # Main FastAPI backend service
  - name: "autobot-backend"
    description: "AutoBot FastAPI Backend Service"
    type: "simple"
    user: "{{ autobot.user }}"
    group: "{{ autobot.group }}"
    working_directory: "{{ backend.directories.app_dir }}"
    exec_start: "{{ backend.python.virtual_env }}/bin/uvicorn {{ backend.fastapi.app_module }} --host {{ backend.fastapi.host }} --port {{ backend.fastapi.port }} --workers {{ backend.fastapi.workers }}"
    restart: "always"
    restart_sec: 10
    environment_file: "/etc/autobot/backend.env"

    # Service dependencies
    wants:
      - "network-online.target"
    after:
      - "network-online.target"
      - "redis.service"
    requires:
      - "network-online.target"

    # Resource limits
    limit_nofile: 65536
    limit_nproc: 4096

  # Log aggregation service
  - name: "autobot-log-aggregator"
    description: "AutoBot Log Aggregation Service"
    type: "simple"
    user: "syslog"
    group: "adm"
    exec_start: "/usr/sbin/rsyslogd -n -f /etc/rsyslog.conf"
    restart: "always"
    wants:
      - "network-online.target"
    after:
      - "network-online.target"

# ==========================================
# NGINX REVERSE PROXY (Optional)
# ==========================================

nginx_backend:
  enabled: false  # Enable if direct backend access needed
  upstream:
    name: "autobot_backend"
    servers:
      - "127.0.0.1:{{ backend.fastapi.port }}"

  # Reverse proxy configuration
  proxy:
    connect_timeout: 30s
    send_timeout: 30s
    read_timeout: 30s
    buffer_size: 64k
    buffers: "8 64k"
    busy_buffers_size: 128k

# ==========================================
# LOG AGGREGATION CONFIGURATION
# ==========================================

log_aggregation:
  # Rsyslog configuration for centralized logging
  rsyslog:
    enabled: true
    server_port: 514
    protocol: "tcp"

    # Log sources
    sources:
      - facility: "local0"
        service: "autobot-backend"
      - facility: "local1"
        service: "autobot-frontend"
      - facility: "local2"
        service: "autobot-ai-stack"
      - facility: "local3"
        service: "autobot-npu-worker"
      - facility: "local4"
        service: "autobot-database"

  # Log rotation
  rotation:
    enabled: true
    files:
      - path: "/var/log/autobot/backend/*.log"
        frequency: "daily"
        count: 30
        size: "100M"
        compress: true
      - path: "/var/log/autobot/aggregated/*.log"
        frequency: "daily"
        count: 30
        size: "100M"
        compress: true

# ==========================================
# MONITORING CONFIGURATION
# ==========================================

monitoring:
  # Prometheus metrics
  prometheus:
    enabled: true
    port: 9090
    endpoint: "/metrics"

  # Health check endpoints
  health_checks:
    - path: "/api/health"
      method: "GET"
      expected_status: 200
    - path: "/api/system/status"
      method: "GET"
      expected_status: 200

  # Performance monitoring
  performance:
    cpu_alert_threshold: 80
    memory_alert_threshold: 85
    disk_alert_threshold: 90
    response_time_threshold: 5000  # milliseconds

# ==========================================
# FIREWALL CONFIGURATION
# ==========================================

ufw_rules:
  # FastAPI backend API
  - rule: allow
    port: 8001
    protocol: tcp
    src: "192.168.100.0/24"
    comment: "FastAPI backend API"

  # Log aggregation
  - rule: allow
    port: 514
    protocol: tcp
    src: "192.168.100.0/24"
    comment: "Rsyslog aggregation"

  # Prometheus metrics (if enabled)
  - rule: allow
    port: 9090
    protocol: tcp
    src: "192.168.100.0/24"
    comment: "Prometheus metrics"

  # WebSocket connections
  - rule: allow
    port: 8001
    protocol: tcp
    src: "192.168.100.0/24"
    comment: "WebSocket connections"

# ==========================================
# SECURITY CONFIGURATION
# ==========================================

security:
  # API security
  api:
    rate_limiting: true
    cors_enabled: true
    cors_origins:
      - "http://192.168.100.10"  # Frontend VM
      - "http://autobot.internal"

  # File permissions
  file_permissions:
    app_files: "644"
    config_files: "600"
    log_files: "644"
    data_files: "600"

# ==========================================
# BACKUP CONFIGURATION
# ==========================================

backup_paths:
  # Application code
  - path: "{{ backend.directories.app_dir }}"
    type: "directory"
    compress: true
    exclude:
      - "__pycache__"
      - "*.pyc"
      - ".git"
      - "venv"

  # Configuration files
  - path: "{{ backend.directories.config_dir }}"
    type: "directory"
    compress: true

  # Application data
  - path: "{{ backend.directories.data_dir }}"
    type: "directory"
    compress: true

  # Logs (compressed, 30-day retention)
  - path: "{{ backend.directories.log_dir }}"
    type: "directory"
    compress: true
    retention: 30

# ==========================================
# DEVELOPMENT/DEBUG CONFIGURATION
# ==========================================

debug:
  # Enable debug mode (set to false for production)
  enabled: false
  log_level: "INFO"

  # Development tools (only installed if debug enabled)
  dev_packages:
    - ipython
    - pytest
    - black
    - flake8
    - mypy
