# AutoBot - AI-Powered Automation Platform
# Copyright (c) 2025 mrveiss
# Author: mrveiss
---
# Setup User Backend (Main) from Blank Ubuntu 22.04
#
# This playbook provisions the main AutoBot backend with:
# - FastAPI backend service
# - Python virtual environment
# - Database migrations
# - TLS certificates
# - VNC server for desktop access
# - Integration with Redis, AI Stack, NPU
#
# Usage:
#   ansible-playbook setup-user-backend.yml --limit main
#   ansible-playbook setup-user-backend.yml --limit 172.16.168.20

- name: Setup User Backend Node
  hosts: main
  become: true
  gather_facts: true

  vars:
    backend_install_dir: /opt/autobot
    backend_code_dir: "{{ backend_install_dir }}/autobot-user-backend"
    backend_shared_dir: "{{ backend_install_dir }}/autobot-shared"
    backend_user: autobot
    backend_group: autobot
    backend_port: 8001
    backend_https_port: 8443
    backend_service_name: autobot-backend
    vnc_port: 6080

    # Integration endpoints
    redis_host: "172.16.168.23"
    redis_port: 6379
    ai_stack_host: "172.16.168.24"
    ai_stack_port: 8080
    npu_worker_host: "172.16.168.22"
    npu_worker_port: 8081
    browser_worker_host: "172.16.168.25"
    browser_worker_port: 3000

  pre_tasks:
    - name: Display provisioning info
      debug:
        msg: |
          ═══════════════════════════════════════════════════════════════
          User Backend Node Provisioning
          ═══════════════════════════════════════════════════════════════
          Target: {{ inventory_hostname }} ({{ ansible_host }})
          Code: {{ backend_code_dir }}
          HTTP: {{ backend_port }}
          HTTPS: {{ backend_https_port }}
          VNC: {{ vnc_port }}
          User: {{ backend_user }}
          ═══════════════════════════════════════════════════════════════
          Integrations:
          - Redis: {{ redis_host }}:{{ redis_port }}
          - AI Stack: {{ ai_stack_host }}:{{ ai_stack_port }}
          - NPU Worker: {{ npu_worker_host }}:{{ npu_worker_port }}
          - Browser: {{ browser_worker_host }}:{{ browser_worker_port }}
          ═══════════════════════════════════════════════════════════════

  roles:
    - role: common
      tags: [common, base]

    - role: backend
      tags: [backend, api]

    - role: vnc
      tags: [vnc, desktop]
      when: enable_vnc | default(true)

  post_tasks:
    - name: Run database migrations
      command:
        cmd: "{{ backend_code_dir }}/venv/bin/python -m alembic upgrade head"
        chdir: "{{ backend_code_dir }}"
      become_user: "{{ backend_user }}"
      environment:
        PYTHONPATH: "{{ backend_code_dir }}"
      tags: [migrations]
      register: migration_result
      failed_when: false

    - name: Display migration result
      debug:
        msg: "Migrations: {{ migration_result.stdout if migration_result.rc == 0 else 'Skipped or failed' }}"
      tags: [migrations]

    - name: Verify backend service
      systemd:
        name: "{{ backend_service_name }}"
        state: started
        enabled: true
      tags: [verify]

    - name: Check backend health
      uri:
        url: "https://{{ ansible_host }}:{{ backend_https_port }}/api/health"
        validate_certs: false
        status_code: [200, 404]
        timeout: 10
      register: health_check
      failed_when: false
      tags: [verify]

    - name: Display setup summary
      debug:
        msg: |
          ═══════════════════════════════════════════════════════════════
          User Backend Setup Complete
          ═══════════════════════════════════════════════════════════════
          Service: {{ backend_service_name }}
          Status: {{ 'Running' if health_check.status == 200 else 'Starting' }}
          HTTP: http://{{ ansible_host }}:{{ backend_port }}
          HTTPS: https://{{ ansible_host }}:{{ backend_https_port }}
          VNC: http://{{ ansible_host }}:{{ vnc_port }}
          Code: {{ backend_code_dir }}
          Migrations: {{ 'Applied' if migration_result.rc == 0 else 'Check logs' }}
          ═══════════════════════════════════════════════════════════════
      tags: [verify]
