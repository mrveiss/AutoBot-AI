# AutoBot - AI-Powered Automation Platform
# Copyright (c) 2025 mrveiss
# Author: mrveiss
#
# Playbook: Deploy SLM Agent
# Deploys the SLM node agent to all managed nodes for automatic heartbeats
#
# Usage:
#   ansible-playbook -i inventory/slm-nodes.yml deploy-slm-agent.yml
#   ansible-playbook -i inventory/slm-nodes.yml deploy-slm-agent.yml --limit 01-Backend
---
- name: Deploy SLM Agent to Managed Nodes
  hosts: slm_nodes
  become: yes
  gather_facts: yes

  pre_tasks:
    - name: "Pre-check | Verify connectivity"
      ping:
      tags: ['always']

    - name: "Pre-check | Ensure autobot user exists"
      user:
        name: autobot
        state: present
        system: yes
        create_home: yes
        shell: /bin/bash
      tags: ['setup']

  roles:
    - role: slm_agent
      tags: ['slm_agent']

  post_tasks:
    - name: "Post-check | Verify agent is running"
      systemd:
        name: slm-agent
      register: agent_status
      tags: ['verify']

    - name: "Post-check | Display agent status"
      debug:
        msg: "Agent {{ slm_node_id }} status: {{ agent_status.status.ActiveState }}"
      tags: ['verify']
