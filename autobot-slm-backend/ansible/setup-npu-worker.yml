# AutoBot - AI-Powered Automation Platform
# Copyright (c) 2025 mrveiss
# Author: mrveiss
---
# Setup NPU Worker Node from Blank Ubuntu 22.04
#
# This playbook provisions a complete NPU worker node with:
# - System packages and NPU drivers
# - autobot-npu-worker service (new structure)
# - OpenVINO acceleration
# - Systemd service configuration
# - TLS certificates
# - Monitoring integration
#
# Usage:
#   ansible-playbook setup-npu-worker.yml --limit npu-worker
#   ansible-playbook setup-npu-worker.yml --limit 172.16.168.22
#
# Requirements:
#   - Target: Ubuntu 22.04 Server (blank or existing)
#   - SSH: Password-less sudo access
#   - Network: Access to package repos
#
# Idempotency:
#   - Safe to re-run on existing nodes
#   - Will migrate from old npu-worker/ structure if detected
#   - Updates code and restarts services

- name: Setup NPU Worker Node
  hosts: npu_worker
  become: true
  gather_facts: true

  vars:
    # NPU worker configuration
    npu_worker_install_dir: /opt/autobot
    npu_worker_code_dir: "{{ npu_worker_install_dir }}/autobot-npu-worker"
    npu_worker_old_code_dir: "{{ npu_worker_install_dir }}/npu-worker"
    npu_worker_user: autobot
    npu_worker_group: autobot
    npu_worker_port: 8081
    npu_worker_service_name: autobot-npu-worker

    # Backend connection
    backend_host: "172.16.168.20"
    backend_port: 8001

    # Migration flag
    migrate_from_old_structure: true

  pre_tasks:
    - name: Display provisioning info
      debug:
        msg: |
          ═══════════════════════════════════════════════════════════════
          NPU Worker Node Provisioning
          ═══════════════════════════════════════════════════════════════
          Target: {{ inventory_hostname }} ({{ ansible_host }})
          Code: {{ npu_worker_code_dir }}
          Port: {{ npu_worker_port }}
          User: {{ npu_worker_user }}
          ═══════════════════════════════════════════════════════════════

    - name: Check if old structure exists
      stat:
        path: "{{ npu_worker_old_code_dir }}"
      register: old_structure

    - name: Set migration flag
      set_fact:
        needs_migration: "{{ old_structure.stat.exists and old_structure.stat.isdir }}"

    - name: Display migration status
      debug:
        msg: "Old structure detected - will migrate to new structure"
      when: needs_migration | bool

  roles:
    - role: common
      tags: [common, base]

    - role: npu-worker
      tags: [npu, worker]

  post_tasks:
    - name: Migration | Backup old structure
      block:
        - name: Create backup directory
          file:
            path: "{{ npu_worker_install_dir }}/backups"
            state: directory
            owner: "{{ npu_worker_user }}"
            group: "{{ npu_worker_group }}"
            mode: '0755'

        - name: Backup old npu-worker directory
          command:
            cmd: "mv {{ npu_worker_old_code_dir }} {{ npu_worker_install_dir }}/backups/npu-worker.backup.{{ ansible_date_time.epoch }}"
          args:
            creates: "{{ npu_worker_install_dir }}/backups/npu-worker.backup.*"
          when: needs_migration | bool

        - name: Log migration
          debug:
            msg: "Old structure backed up to {{ npu_worker_install_dir }}/backups/"
      when: needs_migration | bool
      tags: [migration]

    - name: Verify NPU worker service
      systemd:
        name: "{{ npu_worker_service_name }}"
        state: started
        enabled: true
      tags: [verify]

    - name: Check NPU worker health
      uri:
        url: "http://{{ ansible_host }}:{{ npu_worker_port }}/health"
        status_code: [200, 404]
        timeout: 5
      register: health_check
      failed_when: false
      tags: [verify]

    - name: Display setup summary
      debug:
        msg: |
          ═══════════════════════════════════════════════════════════════
          NPU Worker Setup Complete
          ═══════════════════════════════════════════════════════════════
          Service: {{ npu_worker_service_name }}
          Status: {{ 'Running' if health_check.status == 200 else 'Not responding' }}
          URL: http://{{ ansible_host }}:{{ npu_worker_port }}
          Code: {{ npu_worker_code_dir }}
          Migration: {{ 'Completed' if needs_migration else 'Not needed' }}
          ═══════════════════════════════════════════════════════════════
      tags: [verify]
