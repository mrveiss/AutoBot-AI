---
# AutoBot - Update All Fleet Nodes (Git-Based Deploy)
# Deploys committed code from a specific branch to all fleet VMs.
# Pulls directly from GitHub to /opt/autobot/code_source on the SLM node (.19),
# then uses git archive to create deploy tarballs. (#1170)
#
# Runs FROM: 172.16.168.19 (SLM Manager) — NOT from the dev machine.
#
# Usage:
#   ansible-playbook playbooks/update-all-nodes.yml
#   ansible-playbook playbooks/update-all-nodes.yml -e deploy_ref=main
#   ansible-playbook playbooks/update-all-nodes.yml -e skip_branch_check=true

# =============================================================================
# PLAY 0: Pre-flight Git Safety Check & Create Deploy Archives
# =============================================================================
- name: "Play 0 - Pre-flight & Build Archives"
  hosts: localhost
  gather_facts: false

  vars:
    github_repo: "https://github.com/mrveiss/AutoBot-AI.git"
    git_repo_root: "/opt/autobot/code_source"
    deploy_ref: "Dev_new_gui"
    allowed_branches:
      - Dev_new_gui
      - main
    skip_branch_check: false
    deploy_tmp: "/tmp/autobot-deploy"

  tasks:
    - name: "[PRE-FLIGHT] Sync code from GitHub"
      git:
        repo: "{{ github_repo }}"
        dest: "{{ git_repo_root }}"
        version: "{{ deploy_ref }}"
        force: yes
        depth: 1

    - name: "[PRE-FLIGHT] Get current git branch"
      command: git -C {{ git_repo_root }} branch --show-current
      register: git_branch
      changed_when: false

    - name: "[PRE-FLIGHT] Resolve deploy ref to commit"
      command: >-
        git -C {{ git_repo_root }}
        log -1 --format='%h %s' {{ deploy_ref }}
      register: deploy_info
      changed_when: false

    - name: "[PRE-FLIGHT] Check for uncommitted changes"
      command: git -C {{ git_repo_root }} status --porcelain
      register: git_dirty
      changed_when: false

    - name: "[PRE-FLIGHT] Display deployment summary"
      debug:
        msg:
          - "======================================================="
          - "  AutoBot Fleet Code Update (GitHub Pull)"
          - "======================================================="
          - ""
          - "  Source:  {{ github_repo }}"
          - "  Branch:  {{ deploy_ref }}"
          - "  Commit:  {{ deploy_info.stdout }}"
          - "  Method:  git pull → git archive"
          - ""

    - name: "[PRE-FLIGHT] ABORT - Not on allowed branch"
      fail:
        msg: >-
          Branch '{{ deploy_ref }}' not in allowed list
          ({{ allowed_branches | join(', ') }}).
          Override: -e skip_branch_check=true
      when:
        - not skip_branch_check | bool
        - deploy_ref not in allowed_branches

    - name: "[PRE-FLIGHT] Create deploy archive directory"
      file:
        path: "{{ deploy_tmp }}"
        state: directory
        mode: '0755'

    - name: "[PRE-FLIGHT] Create component archives"
      shell: >-
        git -C {{ git_repo_root }} archive {{ deploy_ref }}
        -- {{ item.path }} | gzip > {{ deploy_tmp }}/{{ item.name }}.tar.gz
      loop:
        - { name: slm-backend, path: autobot-slm-backend/ }
        - { name: slm-frontend, path: autobot-slm-frontend/ }
        - { name: shared, path: autobot-shared/ }
        - { name: backend, path: autobot-backend/ }
        - { name: frontend, path: autobot-frontend/ }
        - { name: npu-worker, path: autobot-npu-worker/ }
        - { name: browser-worker, path: autobot-browser-worker/ }
      loop_control:
        label: "{{ item.name }}"
      changed_when: true

    - name: "[PRE-FLIGHT] Archives ready"
      debug:
        msg: "7 deploy archives created from {{ deploy_ref }} ({{ deploy_info.stdout }})"

    - name: "[PRE-FLIGHT] Get full commit hash"
      command: git -C {{ git_repo_root }} log -1 --format='%H'
      register: deploy_commit_full
      changed_when: false

    - name: "[PRE-FLIGHT] Get commit subject"
      command: git -C {{ git_repo_root }} log -1 --format='%s'
      register: deploy_commit_subject
      changed_when: false

    - name: "[PRE-FLIGHT] Notify SLM of new commit"
      uri:
        url: "https://localhost/api/code-source/notify"
        method: POST
        body_format: json
        body:
          node_id: "00-SLM-Manager"
          commit: "{{ deploy_commit_full.stdout }}"
          branch: "{{ deploy_ref }}"
          message: "{{ deploy_commit_subject.stdout }}"
          is_code_source: true
          changed_roles: []
        validate_certs: false
        status_code: [200, 404]
      ignore_errors: true

# =============================================================================
# PLAY 1: Update SLM Server First
# =============================================================================
- name: "Play 1 - Update SLM Server First"
  hosts: slm_server
  gather_facts: false
  serial: 1

  vars:
    deploy_tmp: "/tmp/autobot-deploy"

  tasks:
    - name: "[PLAY 1] Starting SLM Server Update"
      debug:
        msg:
          - "======================================================="
          - "  PLAY 1: SLM Server Update (git archive)"
          - "======================================================="
          - "  Target: {{ inventory_hostname }} ({{ ansible_host }})"

    - name: "[PLAY 1] SLM | Deploy autobot-slm-backend"
      unarchive:
        src: "{{ deploy_tmp }}/slm-backend.tar.gz"
        dest: /opt/autobot/
      become: true

    - name: "[PLAY 1] SLM | Deploy autobot-slm-frontend"
      unarchive:
        src: "{{ deploy_tmp }}/slm-frontend.tar.gz"
        dest: /opt/autobot/
      become: true

    - name: "[PLAY 1] SLM | Deploy autobot-shared"
      unarchive:
        src: "{{ deploy_tmp }}/shared.tar.gz"
        dest: /opt/autobot/
      become: true

    - name: "[PLAY 1] SLM | Rebuild frontend production build"
      command:
        cmd: npm run build
        chdir: /opt/autobot/autobot-slm-frontend
      register: slm_build

    - name: "[PLAY 1] SLM | Restart backend service"
      systemd:
        name: autobot-slm-backend
        state: restarted
        daemon_reload: true
      become: true

    - name: "[PLAY 1] SLM | Restart nginx"
      systemd:
        name: nginx
        state: restarted
      become: true

    - name: "[PLAY 1] SLM | Wait for backend to be ready"
      wait_for:
        host: "{{ ansible_host }}"
        port: 443
        timeout: 60
        delay: 5
      delegate_to: localhost

    - name: "[PLAY 1] SLM | Login to get auth token"
      uri:
        url: "https://{{ ansible_host }}/api/auth/login"
        method: POST
        body_format: json
        body:
          username: "admin"
          password: "{{ slm_admin_password | default('admin') }}"
        validate_certs: false
        status_code: 200
      register: slm_login_play1
      delegate_to: localhost
      no_log: true

    - name: "[PLAY 1] SLM | Mark node as synced in DB"
      uri:
        url: "https://{{ ansible_host }}/api/code-sync/nodes/00-SLM-Manager/mark-synced"
        method: POST
        headers:
          Authorization: "Bearer {{ slm_login_play1.json.access_token }}"
          Content-Type: "application/json"
        body: "{}"
        body_format: json
        validate_certs: false
        status_code: [200, 404]
      delegate_to: localhost
      ignore_errors: true

    - name: "[PLAY 1] SLM Update Complete"
      debug:
        msg:
          - "SLM Server updated"
          - "  Backend deployed + restarted"
          - "  Frontend built + nginx restarted"

# =============================================================================
# PLAY 2: Update All Other Infrastructure Nodes
# =============================================================================
- name: "Play 2 - Update Other Infrastructure Nodes"
  hosts: infrastructure:!slm_server
  gather_facts: false
  serial: 3

  vars:
    deploy_tmp: "/tmp/autobot-deploy"

  pre_tasks:
    - name: "[PLAY 2] Login to SLM API"
      uri:
        url: "https://172.16.168.19/api/auth/login"
        method: POST
        body_format: json
        body:
          username: "admin"
          password: "{{ slm_admin_password | default('admin') }}"
        validate_certs: false
        status_code: 200
      register: slm_login
      delegate_to: localhost
      run_once: true
      no_log: true

    - name: "[PLAY 2] Set SLM auth token"
      set_fact:
        slm_token: "{{ slm_login.json.access_token }}"
      delegate_to: localhost
      run_once: true

  tasks:
    - name: "[PLAY 2] Starting Node Update"
      debug:
        msg:
          - "======================================================="
          - "  PLAY 2: Node Update (git archive)"
          - "======================================================="
          - "  Target: {{ inventory_hostname }} ({{ ansible_host }})"

    # ----- Backend (172.16.168.20) -----
    - name: "[PLAY 2] Backend | Deploy autobot-backend"
      unarchive:
        src: "{{ deploy_tmp }}/backend.tar.gz"
        dest: /opt/autobot/
      become: true
      when: "'01-Backend' in inventory_hostname"

    - name: "[PLAY 2] Backend | Deploy autobot-shared"
      unarchive:
        src: "{{ deploy_tmp }}/shared.tar.gz"
        dest: /opt/autobot/
      become: true
      when: "'01-Backend' in inventory_hostname"

    - name: "[PLAY 2] Backend | Fix ownership"
      command: chown --no-dereference -R autobot:autobot /opt/autobot/autobot-backend
      become: true
      when: "'01-Backend' in inventory_hostname"
      changed_when: true

    - name: "[PLAY 2] Backend | Create backend symlink for imports"
      file:
        path: /opt/autobot/autobot-backend/backend
        src: "."
        state: link
        owner: autobot
        group: autobot
      become: true
      when: "'01-Backend' in inventory_hostname"

    - name: "[PLAY 2] Backend | Restart service"
      systemd:
        name: autobot-backend
        state: restarted
        daemon_reload: true
      become: true
      when: "'01-Backend' in inventory_hostname"

    # ----- Frontend (172.16.168.21) -----
    - name: "[PLAY 2] Frontend | Deploy autobot-frontend"
      unarchive:
        src: "{{ deploy_tmp }}/frontend.tar.gz"
        dest: /opt/autobot/
      become: true
      when: "'02-Frontend' in inventory_hostname"

    - name: "[PLAY 2] Frontend | Fix ownership"
      file:
        path: /opt/autobot/autobot-frontend
        owner: autobot
        group: autobot
        recurse: true
      become: true
      when: "'02-Frontend' in inventory_hostname"

    - name: "[PLAY 2] Frontend | Rebuild production dist"
      command:
        cmd: npx vite build
        chdir: /opt/autobot/autobot-frontend
      become_user: autobot
      become: true
      when: "'02-Frontend' in inventory_hostname"
      register: frontend_build

    - name: "[PLAY 2] Frontend | Restart nginx"
      systemd:
        name: nginx
        state: restarted
      become: true
      when: "'02-Frontend' in inventory_hostname"

    # ----- NPU Worker (172.16.168.22) -----
    - name: "[PLAY 2] NPU | Deploy autobot-npu-worker"
      unarchive:
        src: "{{ deploy_tmp }}/npu-worker.tar.gz"
        dest: /opt/autobot/
      become: true
      when: >-
        '03-NPU' in inventory_hostname or
        'npu-worker' in inventory_hostname

    # ----- Browser Worker (172.16.168.25) -----
    - name: "[PLAY 2] Browser | Deploy autobot-browser-worker"
      unarchive:
        src: "{{ deploy_tmp }}/browser-worker.tar.gz"
        dest: /opt/autobot/
      become: true
      when: >-
        '05-Browser' in inventory_hostname or
        'browser-automation' in inventory_hostname

    # ----- Shared (non-backend nodes) -----
    - name: "[PLAY 2] Shared | Deploy autobot-shared"
      unarchive:
        src: "{{ deploy_tmp }}/shared.tar.gz"
        dest: /opt/autobot/
      become: true
      when: "'01-Backend' not in inventory_hostname"

    # ----- Mark synced -----
    - name: "[PLAY 2] Mark node as synced in SLM DB"
      uri:
        url: "https://172.16.168.19/api/code-sync/nodes/{{ inventory_hostname }}/mark-synced"
        method: POST
        headers:
          Authorization: "Bearer {{ slm_token }}"
          Content-Type: "application/json"
        body: "{}"
        body_format: json
        validate_certs: false
        status_code: [200, 404]
      delegate_to: localhost
      ignore_errors: true

    - name: "[PLAY 2] Node Update Complete"
      debug:
        msg: "{{ inventory_hostname }} updated"

# =============================================================================
# PLAY 3: Verify + Cleanup
# =============================================================================
- name: "Play 3 - Verify & Cleanup"
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Wait for services to stabilize
      pause:
        seconds: 5

    - name: Check SLM health
      uri:
        url: "https://172.16.168.19/api/health"
        validate_certs: false
      register: slm_health
      ignore_errors: true

    - name: Clean up deploy archives
      file:
        path: /tmp/autobot-deploy
        state: absent

    - name: Display update summary
      debug:
        msg:
          - ""
          - "======================================================="
          - "  Fleet Update Complete (Git-Based Deploy)"
          - "======================================================="
          - ""
          - "  Method:  GitHub pull → git archive"
          - "  SLM:     {{ slm_health.json.status | default('Check manually') }}"
          - "  Nodes:   {{ slm_health.json.nodes_online | default('?') }}/{{ slm_health.json.nodes_total | default('9') }}"
          - ""
          - "  SLM Admin:     https://172.16.168.19/"
          - "  User Frontend: https://172.16.168.21/"
          - ""
