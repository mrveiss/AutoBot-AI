# AutoBot - AI-Powered Automation Platform
# Copyright (c) 2025 mrveiss
# Author: mrveiss
---
# System Package Rollback Playbook
# Issue #682: Emergency rollback for system package updates
#
# This playbook attempts to restore services after a failed system update.
# Full apt package rollback is complex - this focuses on service restoration.
#
# Usage:
#   # Rollback all VMs
#   ansible-playbook playbooks/rollback-system-packages.yml
#
#   # Rollback specific group
#   ansible-playbook playbooks/rollback-system-packages.yml --limit backend

- name: "AutoBot System Rollback - Pre-flight"
  hosts: localhost
  gather_facts: no
  tasks:
    - name: Display rollback warning
      ansible.builtin.debug:
        msg: |
          ═══════════════════════════════════════════════════════════
          ⚠️  AutoBot System Package Rollback - EMERGENCY PROCEDURE ⚠️
          ═══════════════════════════════════════════════════════════
          This will attempt to restore services after a failed update.

          Target hosts: All VMs

          IMPORTANT: Full apt package rollback may require manual steps.
          This procedure will:
          1. Attempt apt --fix-broken
          2. Restart affected services
          3. Verify health checks
          4. Provide dpkg backup paths for manual recovery

          For complete package rollback, you may need to:
          1. SSH to affected VMs
          2. Use dpkg --set-selections < backup-file
          3. Run apt-get dselect-upgrade
          ═══════════════════════════════════════════════════════════

    - name: Confirm rollback
      ansible.builtin.pause:
        prompt: "Press ENTER to proceed with system rollback, or Ctrl+C to abort"
      when: not (auto_confirm | default(false))

# Rollback in reverse order of updates (most dependent first)
- name: "Rollback Browser Services"
  hosts: browser
  become: yes
  serial: 1
  tasks:
    - name: Include system rollback tasks
      ansible.builtin.include_role:
        name: dependency_patching
        tasks_from: rollback-system.yml
  tags:
    - browser

- name: "Rollback Frontend Services"
  hosts: frontend
  become: yes
  serial: 1
  tasks:
    - name: Include system rollback tasks
      ansible.builtin.include_role:
        name: dependency_patching
        tasks_from: rollback-system.yml
  tags:
    - frontend

- name: "Rollback NPU Worker Services"
  hosts: npu
  become: yes
  serial: 1
  tasks:
    - name: Include system rollback tasks
      ansible.builtin.include_role:
        name: dependency_patching
        tasks_from: rollback-system.yml
  tags:
    - npu

- name: "Rollback AI/ML Stack Services"
  hosts: aiml
  become: yes
  serial: 1
  tasks:
    - name: Include system rollback tasks
      ansible.builtin.include_role:
        name: dependency_patching
        tasks_from: rollback-system.yml
  tags:
    - aiml

- name: "Rollback Backend Services"
  hosts: backend
  become: yes
  serial: 1
  tasks:
    - name: Include system rollback tasks
      ansible.builtin.include_role:
        name: dependency_patching
        tasks_from: rollback-system.yml
  tags:
    - backend

- name: "Rollback Database Services"
  hosts: database
  become: yes
  serial: 1
  tasks:
    - name: Include system rollback tasks
      ansible.builtin.include_role:
        name: dependency_patching
        tasks_from: rollback-system.yml
  tags:
    - database

- name: "Post-Rollback Summary"
  hosts: localhost
  gather_facts: no
  tasks:
    - name: Display completion summary
      ansible.builtin.debug:
        msg: |
          ═══════════════════════════════════════════════════════════
          AutoBot System Package Rollback - COMPLETE
          ═══════════════════════════════════════════════════════════

          Service restoration attempted on all VMs.

          Next steps:
          1. Verify application functionality
          2. Check service health: ./deploy.sh --health-check
          3. If issues persist, SSH to affected VMs for manual recovery
          4. Check /var/log/apt/history.log for package changes
          5. Use dpkg backups for manual package restoration if needed

          ═══════════════════════════════════════════════════════════
