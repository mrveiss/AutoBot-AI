# AutoBot - AI-Powered Automation Platform
# Copyright (c) 2025 mrveiss
# Author: mrveiss
---
# Dependency Rollback Playbook
# Issue #682: Emergency rollback for dependency patching
#
# This playbook restores Python venvs from backup after a failed update.
# Only targets hosts with Python virtual environments.
#
# Usage:
#   # Rollback all Python hosts
#   ansible-playbook playbooks/rollback-dependencies.yml
#
#   # Rollback specific group
#   ansible-playbook playbooks/rollback-dependencies.yml --limit backend

- name: "AutoBot Dependency Rollback - Pre-flight"
  hosts: localhost
  gather_facts: no
  tasks:
    - name: Display rollback warning
      ansible.builtin.debug:
        msg: |
          ═══════════════════════════════════════════════════════════
          ⚠️  AutoBot Dependency Rollback - EMERGENCY PROCEDURE ⚠️
          ═══════════════════════════════════════════════════════════
          This will restore Python virtual environments from backup.

          Target hosts: backend, aiml, npu
          (Frontend is skipped - uses Node.js, not Python)
          ═══════════════════════════════════════════════════════════

    - name: Confirm rollback
      ansible.builtin.pause:
        prompt: "Press ENTER to proceed with rollback, or Ctrl+C to abort"
      when: not (auto_confirm | default(false))

# Rollback in REVERSE order of updates (most dependent first, then dependencies)
# Update order: database -> backend -> aiml -> npu -> frontend -> browser
# Rollback order: npu -> aiml -> backend (reverse, most dependent first)

- name: "Rollback NPU Worker Services"
  hosts: npu
  become: yes
  serial: 1
  vars:
    # Use most recent backup if not specified
    latest_backup: "{{ lookup('pipe', 'ls -t ' ~ backup_base_path | default('/opt/autobot/backups') ~ '/venv-*.tar.gz 2>/dev/null | head -1') | default(omit) }}"
  tasks:
    - name: Include rollback tasks
      ansible.builtin.include_role:
        name: dependency_patching
        tasks_from: rollback.yml
  tags:
    - npu

- name: "Rollback AI/ML Stack Services"
  hosts: aiml
  become: yes
  serial: 1
  vars:
    latest_backup: "{{ lookup('pipe', 'ls -t ' ~ backup_base_path | default('/opt/autobot/backups') ~ '/venv-*.tar.gz 2>/dev/null | head -1') | default(omit) }}"
  tasks:
    - name: Include rollback tasks
      ansible.builtin.include_role:
        name: dependency_patching
        tasks_from: rollback.yml
  tags:
    - aiml

- name: "Rollback Backend Services"
  hosts: backend
  become: yes
  serial: 1
  vars:
    latest_backup: "{{ lookup('pipe', 'ls -t ' ~ backup_base_path | default('/opt/autobot/backups') ~ '/venv-*.tar.gz 2>/dev/null | head -1') | default(omit) }}"
  tasks:
    - name: Include rollback tasks
      ansible.builtin.include_role:
        name: dependency_patching
        tasks_from: rollback.yml
  tags:
    - backend

- name: "Post-Rollback Summary"
  hosts: localhost
  gather_facts: no
  tasks:
    - name: Display completion summary
      ansible.builtin.debug:
        msg: |
          ═══════════════════════════════════════════════════════════
          AutoBot Dependency Rollback - COMPLETE
          ═══════════════════════════════════════════════════════════

          All Python services have been rolled back to their previous state.

          Next steps:
          1. Verify application functionality
          2. Check service health: ./deploy.sh --health-check
          3. Investigate why the update failed
          4. Fix issues before attempting update again

          ═══════════════════════════════════════════════════════════
