---
# Base System Deployment Playbook
# Sets up Ubuntu 22.04 LTS base system for all AutoBot VMs

- name: "Deploy Base System Configuration"
  hosts: all
  become: true
  gather_facts: true
  serial: "{{ ansible_serial | default(5) }}"  # Process all VMs in parallel

  vars:
    # System configuration
    autobot_user: "{{ autobot.user }}"
    autobot_group: "{{ autobot.group }}"

  pre_tasks:
    - name: Display VM information
      debug:
        msg:
          - "ğŸ–¥ï¸  Configuring VM: {{ inventory_hostname }}"
          - "IP Address: {{ ansible_default_ipv4.address }}"
          - "OS: {{ ansible_distribution }} {{ ansible_distribution_version }}"
          - "Role: {{ group_names | join(', ') }}"
          - "Resources: {{ hostvars[inventory_hostname]['vm_resources'] | default('Default') }}"

  tasks:
    # ==========================================
    # SYSTEM UPDATE AND PACKAGE MANAGEMENT
    # ==========================================

    - name: Update apt package index
      apt:
        update_cache: true
        cache_valid_time: 3600
      retries: 3
      delay: 10

    - name: Upgrade all system packages
      apt:
        upgrade: dist
        autoremove: true
        autoclean: true
      register: upgrade_result
      retries: 3
      delay: 30

    - name: Display upgrade results
      debug:
        msg: "Upgraded {{ upgrade_result.changed }} packages"
      when: upgrade_result.changed

    - name: Install essential system packages
      apt:
        name:
          # System essentials
          - curl
          - wget
          - git
          - vim
          - htop
          - tree
          - unzip
          - software-properties-common
          - apt-transport-https
          - ca-certificates
          - gnupg
          - lsb-release

          # Network tools
          - net-tools
          - netcat-openbsd
          - iputils-ping
          - dnsutils
          - traceroute
          - nmap

          # System monitoring
          - iotop
          - iftop
          - nethogs
          - lsof
          - strace

          # Security tools
          - ufw
          - fail2ban
          - rkhunter
          - chkrootkit

          # Build essentials
          - build-essential
          - cmake
          - pkg-config

        state: present
        update_cache: true
      retries: 3
      delay: 10

    # ==========================================
    # USER AND GROUP MANAGEMENT
    # ==========================================

    - name: Create autobot group
      group:
        name: "{{ autobot_group }}"
        state: present

    - name: Ensure autobot user exists with proper configuration
      user:
        name: "{{ autobot_user }}"
        group: "{{ autobot_group }}"
        groups: "sudo,adm,staff"
        shell: /bin/bash
        create_home: true
        home: "/home/{{ autobot_user }}"
        state: present
        password_lock: false

    - name: Configure sudo access for autobot user
      lineinfile:
        path: /etc/sudoers.d/autobot
        line: "{{ autobot_user }} ALL=(ALL) NOPASSWD:ALL"
        create: true
        mode: '0440'
        validate: 'visudo -cf %s'

    - name: Create AutoBot directory structure
      file:
        path: "{{ item }}"
        state: directory
        owner: "{{ autobot_user }}"
        group: "{{ autobot_group }}"
        mode: '0755'
      loop: "{{ system.directories }}"

    # ==========================================
    # SSH CONFIGURATION AND SECURITY
    # ==========================================

    - name: Configure SSH for security
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
        backup: true
      loop:
        - { regexp: '^#?PermitRootLogin', line: 'PermitRootLogin no' }
        - { regexp: '^#?PasswordAuthentication', line: 'PasswordAuthentication no' }
        - { regexp: '^#?PubkeyAuthentication', line: 'PubkeyAuthentication yes' }
        - { regexp: '^#?AuthorizedKeysFile', line: 'AuthorizedKeysFile .ssh/authorized_keys' }
        - { regexp: '^#?X11Forwarding', line: 'X11Forwarding yes' }
        - { regexp: '^#?ClientAliveInterval', line: 'ClientAliveInterval 300' }
        - { regexp: '^#?ClientAliveCountMax', line: 'ClientAliveCountMax 2' }
      notify: restart ssh

    - name: Ensure SSH directory exists for autobot user
      file:
        path: "/home/{{ autobot_user }}/.ssh"
        state: directory
        owner: "{{ autobot_user }}"
        group: "{{ autobot_group }}"
        mode: '0700'

    - name: Set up authorized_keys for autobot user (if public key provided)
      authorized_key:
        user: "{{ autobot_user }}"
        key: "{{ lookup('file', '~/.ssh/autobot_key.pub') }}"
        state: present
      ignore_errors: true  # In case key doesn't exist yet

    # ==========================================
    # FIREWALL CONFIGURATION
    # ==========================================

    - name: Configure UFW firewall
      ufw:
        state: enabled
        policy: "{{ item.direction }}"
        default: "{{ item.policy }}"
      loop:
        - { direction: incoming, policy: deny }
        - { direction: outgoing, policy: allow }

    - name: Configure UFW rules for SSH
      ufw:
        rule: allow
        port: "{{ network.ssh.port }}"
        proto: tcp
        src: "{{ network.subnet }}"
        comment: "SSH access from internal network"

    - name: Configure UFW rules for internal communication
      ufw:
        rule: allow
        src: "{{ network.subnet }}"
        comment: "Internal network communication"

    - name: Add VM-specific firewall rules
      ufw:
        rule: "{{ item.rule }}"
        port: "{{ item.port | default(omit) }}"
        proto: "{{ item.protocol | default('tcp') }}"
        src: "{{ item.src | default(omit) }}"
        comment: "{{ item.comment }}"
      loop: "{{ ufw_rules | default([]) }}"

    # ==========================================
    # SYSTEM SERVICES AND CONFIGURATION
    # ==========================================

    - name: Configure timezone
      timezone:
        name: "{{ system.timezone }}"

    - name: Configure locale
      locale_gen:
        name: "{{ system.locale }}"
        state: present

    - name: Set system locale
      command: update-locale LANG="{{ system.locale }}"
      changed_when: false

    - name: Configure automatic security updates
      apt:
        name: unattended-upgrades
        state: present
      when: system.unattended_upgrades

    - name: Configure unattended upgrades
      template:
        src: "50unattended-upgrades.j2"
        dest: /etc/apt/apt.conf.d/50unattended-upgrades
        mode: '0644'
      when: system.unattended_upgrades

    # ==========================================
    # NETWORK CONFIGURATION
    # ==========================================

    - name: Configure hostname
      hostname:
        name: "{{ inventory_hostname }}"

    - name: Update /etc/hosts with VM information
      lineinfile:
        path: /etc/hosts
        regexp: "^{{ hostvars[item]['ansible_default_ipv4']['address'] }}"
        line: "{{ hostvars[item]['ansible_default_ipv4']['address'] }} {{ item }} {{ item }}.{{ network.domain }}"
        state: present
      loop: "{{ groups['all'] }}"
      when: hostvars[item]['ansible_default_ipv4']['address'] is defined

    - name: Configure DNS servers
      lineinfile:
        path: /etc/systemd/resolved.conf
        regexp: "^#?DNS="
        line: "DNS={{ network.dns_servers | join(' ') }}"
        backup: true
      notify: restart systemd-resolved

    # ==========================================
    # LOGGING CONFIGURATION
    # ==========================================

    - name: Configure rsyslog for centralized logging
      template:
        src: "rsyslog-autobot.conf.j2"
        dest: /etc/rsyslog.d/30-autobot.conf
        mode: '0644'
        backup: true
      notify: restart rsyslog
      when: logging.aggregation.enabled

    - name: Configure log rotation for AutoBot
      template:
        src: "logrotate-autobot.j2"
        dest: /etc/logrotate.d/autobot
        mode: '0644'
      when: logging.rotation.enabled

    - name: Create AutoBot log directory
      file:
        path: "/var/log/autobot"
        state: directory
        owner: "{{ autobot_user }}"
        group: "adm"
        mode: '0755'

    # ==========================================
    # SYSTEM OPTIMIZATION
    # ==========================================

    - name: Configure kernel parameters for performance
      sysctl:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        state: present
        reload: true
      loop:
        # Network performance
        - { name: "net.core.rmem_max", value: "16777216" }
        - { name: "net.core.wmem_max", value: "16777216" }
        - { name: "net.ipv4.tcp_rmem", value: "4096 12582912 16777216" }
        - { name: "net.ipv4.tcp_wmem", value: "4096 12582912 16777216" }

        # Memory management
        - { name: "vm.swappiness", value: "10" }
        - { name: "vm.dirty_ratio", value: "15" }
        - { name: "vm.dirty_background_ratio", value: "5" }

        # File system
        - { name: "fs.file-max", value: "65536" }

    - name: Configure systemd system limits
      lineinfile:
        path: /etc/systemd/system.conf
        regexp: "^#?{{ item.key }}="
        line: "{{ item.key }}={{ item.value }}"
        backup: true
      loop:
        - { key: "DefaultLimitNOFILE", value: "65536" }
        - { key: "DefaultLimitNPROC", value: "32768" }
      notify: reload systemd

    # ==========================================
    # MONITORING AND HEALTH CHECKS
    # ==========================================

    - name: Install monitoring tools
      apt:
        name:
          - "prometheus-node-exporter"
        state: present
      when: monitoring.enabled

    - name: Configure node exporter
      systemd:
        name: prometheus-node-exporter
        enabled: true
        state: started
      when: monitoring.enabled

    - name: Create health check script
      template:
        src: "health-check.sh.j2"
        dest: "/opt/autobot/scripts/health-check.sh"
        mode: '0755'
        owner: "{{ autobot_user }}"
        group: "{{ autobot_group }}"

    - name: Configure health check cron job
      cron:
        name: "AutoBot health check"
        minute: "*/5"
        job: "/opt/autobot/scripts/health-check.sh >> /var/log/autobot/health.log 2>&1"
        user: "{{ autobot_user }}"
      when: monitoring.health_checks.enabled

    # ==========================================
    # BACKUP CONFIGURATION
    # ==========================================

    - name: Create backup directories
      file:
        path: "{{ backup.storage.local_path }}"
        state: directory
        owner: "{{ autobot_user }}"
        group: "{{ autobot_group }}"
        mode: '0755'
      when: backup.enabled

    - name: Install backup utilities
      apt:
        name:
          - "rsync"
          - "tar"
          - "gzip"
          - "duplicity"
        state: present
      when: backup.enabled

    # ==========================================
    # SECURITY HARDENING
    # ==========================================

    - name: Configure fail2ban
      template:
        src: "jail.local.j2"
        dest: /etc/fail2ban/jail.local
        mode: '0644'
        backup: true
      notify: restart fail2ban

    - name: Enable and start fail2ban
      systemd:
        name: fail2ban
        enabled: true
        state: started

    - name: Configure automatic security updates
      copy:
        content: |
          APT::Periodic::Update-Package-Lists "1";
          APT::Periodic::Download-Upgradeable-Packages "1";
          APT::Periodic::AutocleanInterval "7";
          APT::Periodic::Unattended-Upgrade "1";
        dest: /etc/apt/apt.conf.d/20auto-upgrades
        mode: '0644'
      when: system.unattended_upgrades

    # ==========================================
    # VM-SPECIFIC CONFIGURATION
    # ==========================================

    - name: Configure VM-specific settings
      include_tasks: "configure-{{ group_names[0] }}-base.yml"
      when: group_names | length > 0
      ignore_errors: true  # Skip if VM-specific file doesn't exist

  handlers:
    - name: restart ssh
      systemd:
        name: ssh
        state: restarted

    - name: restart systemd-resolved
      systemd:
        name: systemd-resolved
        state: restarted

    - name: restart rsyslog
      systemd:
        name: rsyslog
        state: restarted

    - name: restart fail2ban
      systemd:
        name: fail2ban
        state: restarted

    - name: reload systemd
      systemd:
        daemon_reload: true

  post_tasks:
    - name: Display base system deployment summary
      debug:
        msg:
          - "âœ… Base system configuration completed for {{ inventory_hostname }}"
          - "ğŸ” Security: UFW firewall enabled, fail2ban configured"
          - "ğŸ‘¤ User: {{ autobot_user }} created with sudo access"
          - "ğŸ“Š Monitoring: {{ monitoring.enabled | ternary('Enabled', 'Disabled') }}"
          - "ğŸ’¾ Backup: {{ backup.enabled | ternary('Enabled', 'Disabled') }}"
          - "ğŸŒ Network: Internal communication configured"

    - name: Verify critical services are running
      systemd:
        name: "{{ item }}"
        state: started
      loop:
        - ssh
        - ufw
        - fail2ban
        - rsyslog

    - name: Create base deployment marker
      file:
        path: "/etc/autobot/base-system-configured"
        state: touch
        mode: '0644'
        owner: "{{ autobot_user }}"
        group: "{{ autobot_group }}"

    - name: Reboot if kernel was updated
      reboot:
        msg: "Rebooting due to kernel update"
        connect_timeout: 5
        reboot_timeout: 600
        pre_reboot_delay: 0
        post_reboot_delay: 30
      when: upgrade_result.changed and upgrade_result.stdout is search("linux-image")
