# AutoBot - AI-Powered Automation Platform
# Copyright (c) 2025 mrveiss
# Author: mrveiss
#
# Local Enrollment Playbook - Sets up autobot user on local machine
# Run with: ansible-playbook enroll-local.yml -K
---
- name: Enroll Local Machine for SLM
  hosts: localhost
  connection: local
  become: true
  gather_facts: true

  vars:
    autobot_user: autobot
    autobot_group: autobot
    autobot_home: /home/autobot
    slm_agent_dir: /opt/autobot/autobot-slm-agent
    slm_data_dir: /var/lib/slm-agent
    slm_node_id: "{{ lookup('env', 'SLM_NODE_ID') | default('01-Backend', true) }}"
    slm_admin_url: "{{ lookup('env', 'SLM_ADMIN_URL') | default('http://' + (slm_host | default('127.0.0.1')) + ':' + (slm_port | default(8000) | string), true) }}"
    # SLM server's public key - will be fetched dynamically
    slm_server_pubkey: "{{ lookup('env', 'SLM_PUBKEY') | default('', true) }}"
    # Emergency admin user - fallback access when SSH keys fail
    emergency_admin_user: autobot_admin
    # Password hash for emergency admin (AutoBot!Admin2025)
    # Generated with: python3 -c "from passlib.hash import sha512_crypt; print(sha512_crypt.hash('AutoBot!Admin2025'))"
    emergency_admin_password_hash: "$6$rounds=656000$VqQZbIggJvVNjHfl$hunhLQdMKj/TCyE.ftDknskbz4SCnGz5e6Yo4YJzHeIIhdRAp/oIDKdwd54oktyBwmb2nP09MWRyXNu0mLg1L1"

  tasks:
    # ==========================================================
    # Emergency Admin Setup (MUST come first for safety)
    # ==========================================================
    - name: Create emergency admin user (fallback access)
      user:
        name: "{{ emergency_admin_user }}"
        comment: "Emergency Admin User (fallback access)"
        shell: /bin/bash
        create_home: yes
        groups: sudo
        append: yes
        password: "{{ emergency_admin_password_hash }}"
        state: present

    - name: Configure passwordless sudo for emergency admin
      copy:
        dest: "/etc/sudoers.d/90-{{ emergency_admin_user }}"
        content: |
          # Emergency Admin - fallback access when SSH keys fail
          # AutoBot Infrastructure - DO NOT REMOVE
          {{ emergency_admin_user }} ALL=(ALL) NOPASSWD: ALL
        owner: root
        group: root
        mode: '0440'
        validate: '/usr/sbin/visudo -cf %s'

    # ==========================================================
    # User Setup
    # ==========================================================
    - name: Ensure autobot group exists
      group:
        name: "{{ autobot_group }}"
        state: present

    - name: Ensure autobot user exists with proper home
      user:
        name: "{{ autobot_user }}"
        group: "{{ autobot_group }}"
        groups: "sudo"
        append: yes
        shell: /bin/bash
        home: "{{ autobot_home }}"
        create_home: yes
        state: present

    - name: Fix home directory ownership
      file:
        path: "{{ autobot_home }}"
        state: directory
        owner: "{{ autobot_user }}"
        group: "{{ autobot_group }}"
        mode: '0755'

    # ==========================================================
    # SSH Key Setup
    # ==========================================================
    - name: Ensure .ssh directory exists
      file:
        path: "{{ autobot_home }}/.ssh"
        state: directory
        owner: "{{ autobot_user }}"
        group: "{{ autobot_group }}"
        mode: '0700'

    - name: Deploy SLM server SSH public key
      authorized_key:
        user: "{{ autobot_user }}"
        key: "{{ slm_server_pubkey }}"
        state: present
        comment: "SLM Server - AutoBot Fleet Management"
      when: slm_server_pubkey | length > 0

    # ==========================================================
    # Passwordless Sudo
    # ==========================================================
    - name: Configure passwordless sudo for autobot user
      copy:
        dest: /etc/sudoers.d/90-autobot
        content: "{{ autobot_user }} ALL=(ALL) NOPASSWD: ALL\n"
        owner: root
        group: root
        mode: '0440'
        validate: '/usr/sbin/visudo -cf %s'

    # ==========================================================
    # SLM Agent Setup (optional - main machine may not need agent)
    # ==========================================================
    - name: Create SLM agent directories
      file:
        path: "{{ item }}"
        state: directory
        owner: "{{ autobot_user }}"
        group: "{{ autobot_group }}"
        mode: '0755'
      loop:
        - "{{ slm_agent_dir }}"
        - "{{ slm_agent_dir }}/slm"
        - "{{ slm_agent_dir }}/slm/agent"
        - "{{ slm_data_dir }}"

    - name: Display completion message
      debug:
        msg:
          - "========================================"
          - "Local Enrollment Complete"
          - "========================================"
          - "Users configured:"
          - "  - {{ autobot_user }} (SSH key auth, passwordless sudo)"
          - "  - {{ emergency_admin_user }} (password auth, passwordless sudo)"
          - ""
          - "SSH Key: {{ 'Deployed' if slm_server_pubkey | length > 0 else 'Not deployed (no key provided)' }}"
          - ""
          - "Test SSH from SLM server:"
          - "  ssh autobot@{{ ansible_default_ipv4.address | default('localhost') }} hostname"
          - ""
          - "Emergency access (if SSH keys fail):"
          - "  ssh {{ emergency_admin_user }}@{{ ansible_default_ipv4.address | default('localhost') }}"
