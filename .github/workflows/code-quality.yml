# GitHub Actions workflow for code quality enforcement
# Runs on every push and pull request

name: Code Quality

on:
  push:
    branches: [ main, Dev_new_gui, develop ]
  pull_request:
    branches: [ main, Dev_new_gui, develop ]

jobs:
  code-quality:
    runs-on: self-hosted

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python environment
      run: |
        # Use pyenv Python if available
        if [ -d "$HOME/.pyenv" ]; then
          echo "$HOME/.pyenv/shims" >> $GITHUB_PATH
          eval "$(pyenv init -)"
        fi
        python3 --version
        echo "PYTHON_VERSION=$(python3 -c 'import sys; print(".".join(map(str, sys.version_info[:2])))')" >> $GITHUB_ENV

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-py${{ env.PYTHON_VERSION }}-pip-${{ hashFiles('**/requirements*.txt', '**/requirements-dev.txt') }}
        restore-keys: |
          ${{ runner.os }}-py${{ env.PYTHON_VERSION }}-pip-
          ${{ runner.os }}-pip-

    - name: Free up disk space
      run: |
        echo "Disk usage before cleanup:"
        df -h
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf "/usr/local/share/boost"
        sudo rm -rf "$AGENT_TOOLSDIRECTORY"
        sudo apt-get clean
        echo "Disk usage after cleanup:"
        df -h

    - name: Install dependencies
      run: |
        python3 -m pip install --no-cache-dir --upgrade pip
        python3 -m pip install --no-cache-dir black isort flake8 autoflake bandit[toml]
        if [ -f requirements.txt ]; then python3 -m pip install --no-cache-dir -r requirements.txt; fi
        if [ -f requirements-dev.txt ]; then python3 -m pip install --no-cache-dir -r requirements-dev.txt; fi
        echo "Final disk usage:"
        df -h

    - name: Check code formatting with Black
      run: |
        black --check --line-length=88 backend/ src/ || {
          echo "❌ Black formatting check failed"
          echo "Run 'black --line-length=88 backend/ src/' to fix"
          exit 1
        }

    - name: Check import sorting with isort
      run: |
        isort --check --profile=black --line-length=88 backend/ src/ || {
          echo "❌ isort check failed"
          echo "Run 'isort --profile=black --line-length=88 backend/ src/' to fix"
          exit 1
        }

    - name: Lint with flake8
      run: |
        flake8 backend/ src/ \
          --max-line-length=88 \
          --extend-ignore=E203,W503 \
          --exclude=node_modules,.venv,venv,__pycache__,.git,temp,logs,reports,archive \
          --statistics \
          --count || {
          echo "❌ flake8 linting failed"
          exit 1
        }

    - name: Check for unused imports with autoflake
      run: |
        autoflake --check --recursive \
          --remove-all-unused-imports \
          --remove-unused-variables \
          backend/ src/ || {
          echo "❌ Unused imports/variables detected"
          echo "Run 'autoflake --in-place --recursive --remove-all-unused-imports --remove-unused-variables backend/ src/' to fix"
          exit 1
        }

    - name: Security check with bandit
      run: |
        bandit -c .bandit -r backend/ src/ || {
          echo "⚠️ Security issues detected"
          exit 1
        }

    - name: Code quality summary
      if: success()
      run: |
        echo "✅ All code quality checks passed!"
        echo ""
        echo "Checks performed:"
        echo "  ✓ Black formatting"
        echo "  ✓ isort import sorting"
        echo "  ✓ flake8 linting"
        echo "  ✓ autoflake unused code detection"
        echo "  ✓ bandit security analysis"
