# GitHub Actions workflow for code quality enforcement
# Runs on every push and pull request
# Uses self-hosted runner to avoid GitHub Actions quota limits

name: Code Quality

on:
  push:
    branches: [ main, Dev_new_gui, develop ]
  pull_request:
    branches: [ main, Dev_new_gui, develop ]

jobs:
  code-quality:
    runs-on: self-hosted

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python virtual environment
      run: |
        python3 -m venv .venv
        source .venv/bin/activate
        echo "VIRTUAL_ENV=$VIRTUAL_ENV" >> $GITHUB_ENV
        echo "$VIRTUAL_ENV/bin" >> $GITHUB_PATH

    - name: Install dependencies
      run: |
        source .venv/bin/activate
        python3 -m pip install --upgrade pip
        python3 -m pip install black isort flake8 autoflake bandit[toml]
        echo "Final disk usage:"
        df -h

    - name: Check code formatting with Black
      run: |
        source .venv/bin/activate
        python3 -m black --check --line-length=88 backend/ src/ || {
          echo "❌ Black formatting check failed"
          echo "Run 'python3 -m black --line-length=88 backend/ src/' to fix"
          exit 1
        }

    - name: Check import sorting with isort
      run: |
        source .venv/bin/activate
        python3 -m isort --check --profile=black --line-length=88 backend/ src/ || {
          echo "❌ isort check failed"
          echo "Run 'python3 -m isort --profile=black --line-length=88 backend/ src/' to fix"
          exit 1
        }

    - name: Lint with flake8
      run: |
        source .venv/bin/activate
        python3 -m flake8 backend/ src/ \
          --max-line-length=100 \
          --extend-ignore=E203,W503 \
          --exclude=node_modules,.venv,venv,__pycache__,.git,temp,logs,reports,archive \
          --statistics \
          --count || {
          echo "❌ flake8 linting failed"
          exit 1
        }

    - name: Check for unused imports with autoflake
      run: |
        source .venv/bin/activate
        python3 -m autoflake --check --recursive \
          --remove-all-unused-imports \
          --remove-unused-variables \
          backend/ src/ || {
          echo "❌ Unused imports/variables detected"
          echo "Run 'python3 -m autoflake --in-place --recursive --remove-all-unused-imports --remove-unused-variables backend/ src/' to fix"
          exit 1
        }

    - name: Security check with bandit
      run: |
        source .venv/bin/activate
        python3 -m bandit -c .bandit -r backend/ src/ || {
          echo "⚠️ Security issues detected"
          exit 1
        }

    - name: Code quality summary
      if: success()
      run: |
        echo "✅ All code quality checks passed!"
        echo ""
        echo "Checks performed:"
        echo "  ✓ Black formatting"
        echo "  ✓ isort import sorting"
        echo "  ✓ flake8 linting"
        echo "  ✓ autoflake unused code detection"
        echo "  ✓ bandit security analysis"

    - name: Cleanup virtual environment
      if: always()
      run: |
        rm -rf .venv || true
