# GitHub Actions workflow for code quality enforcement
# Runs on every push and pull request

name: Code Quality

on:
  push:
    branches: [ main, Dev_new_gui, develop ]
  pull_request:
    branches: [ main, Dev_new_gui, develop ]

jobs:
  code-quality:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt', '**/requirements-dev.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python3 -m pip install --no-cache-dir --upgrade pip
        python3 -m pip install --no-cache-dir black isort flake8 autoflake bandit[toml]
        # Note: Code quality checks don't require project dependencies
        # Only linting tools are needed
        echo "Final disk usage:"
        df -h

    - name: Check code formatting with Black
      run: |
        python3 -m black --check --line-length=88 backend/ src/ || {
          echo "❌ Black formatting check failed"
          echo "Run 'python3 -m black --line-length=88 backend/ src/' to fix"
          exit 1
        }

    - name: Check import sorting with isort
      run: |
        python3 -m isort --check --profile=black --line-length=88 backend/ src/ || {
          echo "❌ isort check failed"
          echo "Run 'python3 -m isort --profile=black --line-length=88 backend/ src/' to fix"
          exit 1
        }

    - name: Lint with flake8
      run: |
        python3 -m flake8 backend/ src/ \
          --max-line-length=88 \
          --extend-ignore=E203,W503 \
          --exclude=node_modules,.venv,venv,__pycache__,.git,temp,logs,reports,archive \
          --statistics \
          --count || {
          echo "❌ flake8 linting failed"
          exit 1
        }

    - name: Check for unused imports with autoflake
      run: |
        python3 -m autoflake --check --recursive \
          --remove-all-unused-imports \
          --remove-unused-variables \
          backend/ src/ || {
          echo "❌ Unused imports/variables detected"
          echo "Run 'python3 -m autoflake --in-place --recursive --remove-all-unused-imports --remove-unused-variables backend/ src/' to fix"
          exit 1
        }

    - name: Security check with bandit
      run: |
        python3 -m bandit -c .bandit -r backend/ src/ || {
          echo "⚠️ Security issues detected"
          exit 1
        }

    - name: Code quality summary
      if: success()
      run: |
        echo "✅ All code quality checks passed!"
        echo ""
        echo "Checks performed:"
        echo "  ✓ Black formatting"
        echo "  ✓ isort import sorting"
        echo "  ✓ flake8 linting"
        echo "  ✓ autoflake unused code detection"
        echo "  ✓ bandit security analysis"
