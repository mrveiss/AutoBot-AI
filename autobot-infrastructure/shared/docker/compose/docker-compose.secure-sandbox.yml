version: '3.8'

services:
  secure-sandbox:
    build:
      context: ../../
      dockerfile: docker/secure-sandbox.Dockerfile
    image: autobot/secure-sandbox:latest
    container_name: autobot-secure-sandbox

    # Security configurations
    security_opt:
      - no-new-privileges:true
      - apparmor:docker-default
      - seccomp:unconfined  # Required for strace monitoring

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M

    # Capabilities
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - DAC_OVERRIDE
      - FOWNER
      - SETGID
      - SETUID
      - NET_BIND_SERVICE
      - SYS_PTRACE  # For strace monitoring

    # Read-only root filesystem
    read_only: true

    # Volumes
    volumes:
      # Writable workspace
      - sandbox-workspace:/sandbox/workspace:rw
      - sandbox-logs:/var/log/autobot:rw
      - sandbox-tmp:/sandbox/tmp:rw
      - sandbox-config:/sandbox/config:ro

      # Security configs
      - ./security/limits.conf:/etc/security/limits.d/sandbox.conf:ro
      - ./security/aide.conf:/etc/aide/aide.conf:ro
      - ./security/rkhunter.conf:/etc/rkhunter.conf:ro

    # Temporary filesystems
    tmpfs:
      - /tmp:size=50M,mode=1777
      - /run:size=10M,mode=755
      - /var/run:size=10M,mode=755

    # Environment variables
    environment:
      - SECURITY_LEVEL=high
      - MONITOR_ENABLED=true
      - LOG_LEVEL=INFO
      - SANDBOX_MODE=restricted
      - PYTHONUNBUFFERED=1

    # Network configuration
    networks:
      - sandbox-network

    # Process namespace sharing (for monitoring)
    pid: "host"

    # Restart policy
    restart: unless-stopped

    # Health check
    healthcheck:
      test: ["CMD", "python3", "/usr/local/bin/security-monitor", "--health-check"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # Labels for management
    labels:
      com.autobot.service: "secure-sandbox"
      com.autobot.security: "high"
      com.autobot.monitoring: "enabled"

  # Monitoring sidecar container
  sandbox-monitor:
    build:
      context: ../../
      dockerfile: docker/secure-sandbox.Dockerfile
    image: autobot/secure-sandbox:latest
    container_name: autobot-sandbox-monitor

    command: ["python3", "/usr/local/bin/security-monitor"]

    # Security configurations
    security_opt:
      - no-new-privileges:true
      - apparmor:docker-default

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M

    # Read-only root filesystem
    read_only: true

    # Volumes
    volumes:
      - sandbox-logs:/var/log/autobot:rw
      - sandbox-config:/sandbox/config:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro  # For container monitoring

    # Environment
    environment:
      - LOG_LEVEL=INFO
      - MONITOR_MODE=sidecar

    # Network
    networks:
      - sandbox-network

    # Depends on main sandbox
    depends_on:
      - secure-sandbox

    # Restart policy
    restart: unless-stopped

    # Labels
    labels:
      com.autobot.service: "sandbox-monitor"
      com.autobot.role: "monitoring"

# Networks
networks:
  sandbox-network:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: br-sandbox
    ipam:
      config:
        - subnet: 172.28.0.0/24
    labels:
      com.autobot.network: "sandbox"

# Volumes
volumes:
  sandbox-workspace:
    driver: local
    labels:
      com.autobot.volume: "workspace"

  sandbox-logs:
    driver: local
    labels:
      com.autobot.volume: "logs"

  sandbox-tmp:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: size=100m,mode=1777
    labels:
      com.autobot.volume: "tmp"

  sandbox-config:
    driver: local
    labels:
      com.autobot.volume: "config"
