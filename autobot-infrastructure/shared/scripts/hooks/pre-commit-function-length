#!/bin/bash
# AutoBot - AI-Powered Automation Platform
# Copyright (c) 2025 mrveiss
# Author: mrveiss
#
# Pre-commit Hook: Function Length Enforcement
# =============================================
#
# Enforces function length guidelines from CLAUDE.md:
# - <=30 lines: Ideal (INFO)
# - 31-50 lines: Acceptable (OK)
# - 51-65 lines: Must refactor before merge (WARNING)
# - >65 lines: Immediate refactoring required (ERROR/BLOCK)
#
# Issue: #620 - Function Length Enforcement
#
# Install: pre-commit install (uses .pre-commit-config.yaml)

set -uo pipefail

# Colors (matching existing hooks pattern)
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

# Get script directory for Python script location
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PYTHON_SCRIPT="${SCRIPT_DIR}/function_length_checker.py"

# Find Python interpreter
find_python() {
    # Check venv first, then system python
    if [[ -n "${VIRTUAL_ENV:-}" ]]; then
        echo "$VIRTUAL_ENV/bin/python"
    elif [[ -f "$(git rev-parse --show-toplevel 2>/dev/null)/venv/bin/python" ]]; then
        echo "$(git rev-parse --show-toplevel)/venv/bin/python"
    elif command -v python3 &> /dev/null; then
        echo "python3"
    elif command -v python &> /dev/null; then
        echo "python"
    else
        echo ""
    fi
}

# Get staged Python files (excluding tests, __init__, temp directories)
get_staged_files() {
    git diff --cached --name-only --diff-filter=ACM 2>/dev/null | \
        grep -E '\.py$' | \
        grep -v -E '(__pycache__|node_modules|\.venv|venv|archive|temp)' | \
        grep -v -E '(test_|_test\.py|tests/)' | \
        grep -v -E '__init__\.py$' || true
}

main() {
    echo -e "${BOLD}${CYAN}Pre-commit: Function Length Enforcement${NC}"
    echo "Issue #620 - Function Length Guidelines"
    echo "================================================"
    echo ""

    local python_cmd
    python_cmd=$(find_python)

    if [[ -z "$python_cmd" ]]; then
        echo -e "${YELLOW}WARNING: Python not found, skipping function length check${NC}"
        exit 0
    fi

    if [[ ! -f "$PYTHON_SCRIPT" ]]; then
        echo -e "${RED}ERROR: function_length_checker.py not found at $PYTHON_SCRIPT${NC}"
        exit 1
    fi

    local files
    files=$(get_staged_files)

    if [[ -z "$files" ]]; then
        echo -e "${GREEN}No Python files staged for commit.${NC}"
        exit 0
    fi

    # Count files for display
    local file_count
    file_count=$(echo "$files" | wc -l)
    echo -e "Checking ${BOLD}${file_count}${NC} staged Python file(s)..."
    echo ""

    # Run Python analyzer and capture exit code
    echo "$files" | "$python_cmd" "$PYTHON_SCRIPT"
    exit_code=$?

    exit $exit_code
}

main "$@"
