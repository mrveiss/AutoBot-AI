# autobot-slm-backend Infrastructure

> Role: `autobot-slm-backend` | Node: SLM (.19 / 172.16.168.19) | Ansible role: `slm_manager`

---

## Overview

SLM (System Lifecycle Manager) FastAPI backend. Manages the 9-node fleet: role assignment, code distribution, health monitoring, Ansible orchestration, and system updates.

258+ API endpoints. PostgreSQL-backed. Serves as the control plane for all other roles.

---

## Ports

| Port | Protocol | Public | Purpose |
|------|----------|--------|---------|
| 8000 | HTTP | No (loopback only) | uvicorn (served via nginx on 443) |
| 443 | HTTPS | Yes (via nginx) | SLM API + WebSocket + Grafana/Prometheus proxy |

---

## Services

| Unit | Type | Start Order |
|------|------|-------------|
| `autobot-slm-backend` | systemd | 2 |

---

## Health Check

```bash
curl -sk https://172.16.168.19/api/health | jq
```

Expected: `{"status": "healthy", "nodes": 9, ...}`

---

## Secrets

| Secret | File | Description |
|--------|------|-------------|
| `tls_cert` | `/etc/ssl/autobot/slm.crt` | SLM CA cert (self-signed root) |
| `tls_key` | `/etc/ssl/autobot/slm.key` | SLM CA key |
| `jwt_secret` | `/etc/autobot/slm-secrets.env` | JWT signing key |
| `db_password` | `/etc/autobot/slm-secrets.env` | PostgreSQL password |
| `admin_password` | `/etc/autobot/slm-secrets.env` | Admin user initial password |

Environment file: `/etc/autobot/slm-secrets.env` (mode 640, `root:autobot-slm-backend`)

---

## Deployment

```bash
# Full SLM server deployment (from autobot-slm-backend/ansible/)
ansible-playbook playbooks/deploy-slm-manager.yml

# Selective tag deploy
ansible-playbook playbooks/deploy-slm-manager.yml --tags backend,nginx

# Service restart
ansible-playbook playbooks/slm-service-control.yml \
  -e "service=autobot-slm-backend action=restart"

# Manual sync
./infrastructure/shared/scripts/utilities/sync-to-slm.sh
```

---

## Database

PostgreSQL on the same node (loopback only):
- Database: `autobot_slm`
- User: `autobot_slm`
- Password: generated by Ansible, stored in `/etc/autobot/slm-secrets.env`

```bash
# DB shell (from .19)
psql -U autobot_slm -d autobot_slm
```

---

## Logs

```bash
ssh autobot@172.16.168.19 'journalctl -u autobot-slm-backend -f'
ssh autobot@172.16.168.19 'tail -f /var/log/autobot/slm-backend.log'
```

---

## Known Gotchas

- **uvicorn binds loopback**: `host=127.0.0.1` — nginx proxies external traffic. Do not set `host=0.0.0.0`.
- **Admin password**: Generated by Ansible → written to `/etc/autobot/slm-secrets.env` → backend reads `ADMIN_PASSWORD` on startup to call `_ensure_admin_user()`.
- **User management DB**: SLM colocates `autobot_users` DB (used for SSO + user management). Initialized by `_init_user_management_tables()` at startup.
- **Post-commit hook**: `scripts/hooks/slm-post-commit` automatically notifies SLM of code changes via `POST /api/code-source/notify`.

---

## Ansible Role

Role: `slm_manager` in `autobot-slm-backend/ansible/roles/slm_manager/`

Key tasks:
- System packages, Python venv, pip install
- TLS cert generation (idempotent — skip if valid, regen if expiring in <7 days)
- PostgreSQL setup + database creation
- Systemd service install + start
- nginx config (HTTPS + WebSocket + Grafana/Prometheus proxy)
- UFW firewall rules
