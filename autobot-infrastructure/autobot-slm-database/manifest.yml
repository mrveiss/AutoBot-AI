role: autobot-slm-database
description: "PostgreSQL database for SLM backend — node registry, roles, performance traces, SLOs"
version: "1.0.0"
target_node: slm

deploy:
  source: autobot-slm-database/
  destination: /opt/autobot/autobot-slm-database/
  shared: false
  infrastructure: true

system_dependencies:
  - postgresql
  - postgresql-contrib
  - libpq-dev

services:
  - name: autobot-slm-database
    type: systemd
    system_service: postgresql
    start_order: 1
    user: postgres

ports:
  - port: 5432
    protocol: tcp
    public: false
    loopback_only: true
    description: "PostgreSQL (localhost only — SLM backend connects locally)"

health:
  endpoint: "http://localhost:5432"
  interval: "60s"
  timeout: "5s"
  retries: 3
  expected_status: 200

secrets:
  own:
    - db_password
    - db_name
  shared: []

tls:
  auto_rotate: false   # PostgreSQL uses socket auth locally

system_updates:
  policy: security
  reboot_strategy: scheduled

coexistence:
  compatible_with:
    - autobot-slm-backend
    - autobot-slm-frontend
    - autobot-monitoring
    - autobot-slm-agent
    - autobot-shared
  conflicts_with: []
  warns_with: []

depends_on: []

ansible_role: postgresql
notes: |
  PostgreSQL runs on localhost:5432. SLM backend connects via UNIX socket or 127.0.0.1.
  DB credentials in /etc/autobot/autobot-slm-database.env (640, root:autobot-slm-database).
  DB name: autobot_slm. User: autobot_slm.
  Password generated by Ansible and stored in /etc/autobot/db-credentials.env (idempotent).
