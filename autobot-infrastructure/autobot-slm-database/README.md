# autobot-slm-database Infrastructure

> Role: `autobot-slm-database` | Node: SLM (.19 / 172.16.168.19) | Ansible role: `postgresql`

---

## Overview

PostgreSQL instance colocated with the SLM backend on .19. Stores SLM fleet state: nodes, roles, deployments, update history, performance traces, SLO definitions, and alert rules.

Binds loopback only — not accessible from other nodes. The SLM backend accesses it via `localhost:5432`.

---

## Ports

| Port | Protocol | Public | Purpose |
|------|----------|--------|---------|
| 5432 | TCP | No (loopback only) | PostgreSQL |

---

## Services

| Unit | Type | Start Order |
|------|------|-------------|
| `autobot-slm-database` | systemd | 1 (postgresql.service alias) |

---

## Health Check

```bash
ssh autobot@172.16.168.19 'pg_isready -U autobot_slm -d autobot_slm'
# Expected: /var/run/postgresql:5432 - accepting connections
```

---

## Secrets

| Secret | File | Description |
|--------|------|-------------|
| `db_password` | `/etc/autobot/slm-secrets.env` | SLM DB password (generated by Ansible) |

Password is read by `autobot-slm-backend` via `DATABASE_URL` env var.

---

## Deployment

```bash
# Deploy via slm_manager role (handles PostgreSQL setup)
ansible-playbook playbooks/deploy-slm-manager.yml --tags postgresql

# Check migration status (from .19)
ssh autobot@172.16.168.19 'cd /opt/autobot/autobot-slm-backend && \
  source venv/bin/activate && alembic current'
```

---

## Database Schema

Key tables managed by `autobot-slm-backend`:
- `nodes` — fleet node registry
- `node_code_versions` — per-role code version tracking
- `deployments` — deployment history
- `system_updates` — system package update records
- `performance_traces` / `trace_spans` — OTel trace storage
- `slo_definitions` / `alert_rules` — SRE tooling

---

## Known Gotchas

- **Password persistence**: Ansible generates a random password ONCE and persists it in `/etc/autobot/slm-secrets.env`. Never regenerate unconditionally — always check if the file exists first.
- **ProtectHome conflict**: systemd `ProtectHome=true` blocks asyncpg SSL cert lookup in `/home/`. Use `read-only` instead.
- **Migration order**: `db_service.initialize()` (creates tables) must run BEFORE incremental Alembic migrations.
- **System updates policy: manual** — DB schema changes require planned maintenance windows.

---

## Ansible Role

Role: `postgresql` in `autobot-slm-backend/ansible/roles/postgresql/`

Key tasks:
- Install postgresql + postgresql-contrib
- Create `autobot_slm` database and user
- Read existing password (or generate new) → write to secrets file
- Configure `pg_hba.conf` for local trust + loopback md5
