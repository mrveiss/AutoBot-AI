role: autobot-monitoring
description: "Prometheus + Grafana fleet observability stack"
version: "1.0.0"
target_node: slm

deploy:
  source: autobot-monitoring/
  destination: /opt/autobot/autobot-monitoring/
  shared: false
  infrastructure: true

system_dependencies:
  - prometheus
  - grafana

services:
  - name: autobot-monitoring-prometheus
    type: systemd
    system_service: prometheus
    start_order: 1
    user: prometheus
  - name: autobot-monitoring-grafana
    type: systemd
    system_service: grafana-server
    start_order: 2
    user: grafana

ports:
  - port: 9090
    protocol: http
    public: false
    loopback_only: true
    description: "Prometheus (proxied through nginx on .19)"
  - port: 3000
    protocol: http
    public: false
    loopback_only: true
    description: "Grafana (proxied through nginx on .19)"

health:
  endpoint: "http://localhost:9090/-/healthy"
  interval: "60s"
  timeout: "10s"
  retries: 3
  expected_status: 200

secrets:
  own:
    - grafana_admin_password
  shared:
    - prometheus_scrape_targets

tls:
  auto_rotate: false   # TLS terminated by nginx (autobot-slm-backend role)

system_updates:
  policy: security
  reboot_strategy: scheduled

coexistence:
  compatible_with:
    - autobot-slm-backend
    - autobot-slm-frontend
    - autobot-slm-database
    - autobot-slm-agent
    - autobot-shared
  conflicts_with:
    - autobot-browser-worker   # both would bind port 3000 if on same node
  warns_with: []

depends_on: []

ansible_role: monitoring
notes: |
  Prometheus and Grafana exposed via nginx proxy on .19 (path /prometheus and /grafana).
  Grafana admin password generated by Ansible in /etc/autobot/autobot-monitoring.env.
  Prometheus scrapes all 9 fleet nodes (node_exporter on each + per-service metrics).
  autobot-browser-worker also binds port 3000 â€” never assign monitoring to .25.
