---
# Frontend VM Configuration (VM1)
# Services: nginx, Node.js, Vue.js frontend, DNS cache

# ==========================================
# FRONTEND SERVICE CONFIGURATION
# ==========================================

frontend:
  # Node.js and Vue.js configuration
  nodejs:
    version: "20"
    npm_version: "latest"
    global_packages:
      - "@vue/cli"
      - "vite"
      - "pm2"
      
  # Vue.js application
  vue:
    app_name: "autobot-frontend"
    build_mode: "production"
    port: 5173
    host: "0.0.0.0"
    base_dir: "{{ autobot.base_dir }}/frontend"
    dist_dir: "{{ autobot.base_dir }}/frontend/dist"
    
  # Environment variables for Vue/Vite
  environment:
    NODE_ENV: "production"
    VITE_API_BASE_URL: "http://{{ backend_host }}:{{ backend_port }}"
    VITE_API_URL: "http://{{ backend_host }}:{{ backend_port }}"
    VITE_WS_BASE_URL: "ws://{{ backend_host }}:{{ backend_port }}/ws"
    VITE_BACKEND_HOST: "{{ backend_host }}"
    VITE_BACKEND_PORT: "{{ backend_port }}"

# ==========================================
# NGINX CONFIGURATION
# ==========================================

nginx:
  # Installation and basic config
  install: true
  service_enabled: true
  service_started: true
  
  # Main configuration
  user: "www-data"
  worker_processes: "auto"
  worker_connections: 1024
  
  # Performance tuning
  keepalive_timeout: 65
  client_max_body_size: "100m"
  gzip_enabled: true
  
  # Log configuration
  access_log: "/var/log/nginx/autobot-access.log"
  error_log: "/var/log/nginx/autobot-error.log"
  
  # Virtual host configuration
  vhosts:
    - listen: "80 default_server"
      server_name: "autobot.internal {{ ansible_fqdn }} {{ ansible_default_ipv4.address }}"
      root: "{{ autobot.base_dir }}/frontend/dist"
      index: "index.html"
      
      # Static file serving
      locations:
        - name: "/"
          try_files: "$uri $uri/ /index.html"
          expires: "1d"
          add_header: "Cache-Control public"
          
        # API proxy to backend
        - name: "/api/"
          proxy_pass: "http://{{ backend_host }}:{{ backend_port }}/api/"
          proxy_set_header:
            - "Host $host"
            - "X-Real-IP $remote_addr"
            - "X-Forwarded-For $proxy_add_x_forwarded_for"
            - "X-Forwarded-Proto $scheme"
          proxy_timeout: 30s
          
        # WebSocket proxy
        - name: "/ws/"
          proxy_pass: "http://{{ backend_host }}:{{ backend_port }}/ws/"
          proxy_http_version: "1.1"
          proxy_set_header:
            - "Upgrade $http_upgrade"
            - "Connection 'upgrade'"
            - "Host $host"
          proxy_cache_bypass: "$http_upgrade"
          
        # Static assets with long cache
        - name: "~* \\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$"
          expires: "1y"
          add_header: "Cache-Control public, immutable"

# ==========================================
# DNS CACHE CONFIGURATION (Unbound)
# ==========================================

dns_cache:
  # Unbound DNS cache service
  enabled: true
  package: "unbound"
  service: "unbound"
  
  # Configuration
  config:
    interface: "127.0.0.1"
    port: 53
    access_control:
      - "127.0.0.0/8 allow"
      - "192.168.100.0/24 allow"
      - "0.0.0.0/0 refuse"
    
    # Cache settings
    cache_size: "50m"
    cache_ttl: 3600
    
    # Forward zones
    forward_zones:
      - zone: "."
        forward_addr:
          - "8.8.8.8"
          - "1.1.1.1"

# ==========================================
# SYSTEMD SERVICE CONFIGURATION
# ==========================================

systemd_services:
  # Vue.js frontend service
  - name: "autobot-frontend"
    description: "AutoBot Vue.js Frontend Application"
    type: "simple"
    user: "{{ autobot.user }}"
    group: "{{ autobot.group }}"
    working_directory: "{{ autobot.base_dir }}/frontend"
    exec_start: "/usr/bin/npm run preview -- --host 0.0.0.0 --port {{ frontend.vue.port }}"
    restart: "always"
    restart_sec: 10
    environment_file: "/etc/autobot/frontend.env"
    wants:
      - "network-online.target"
    after:
      - "network-online.target"
      - "nginx.service"
    
  # DNS cache service (unbound)
  - name: "autobot-dns-cache"
    description: "AutoBot DNS Cache Service"
    type: "forking"
    exec_start: "/usr/sbin/unbound -d"
    restart: "always"
    wants:
      - "network-online.target"
    after:
      - "network-online.target"

# ==========================================
# FIREWALL CONFIGURATION
# ==========================================

ufw_rules:
  # HTTP traffic
  - rule: allow
    port: 80
    protocol: tcp
    comment: "HTTP web traffic"
    
  # HTTPS traffic  
  - rule: allow
    port: 443
    protocol: tcp
    comment: "HTTPS web traffic"
    
  # Node.js development server (internal only)
  - rule: allow
    port: 5173
    protocol: tcp
    src: "192.168.100.0/24"
    comment: "Vue.js dev server (internal)"
    
  # DNS cache (internal only)
  - rule: allow
    port: 53
    protocol: udp
    src: "192.168.100.0/24"
    comment: "DNS cache service"

# ==========================================
# HEALTH CHECKS
# ==========================================

health_checks:
  # Nginx health check
  - name: "nginx"
    url: "http://127.0.0.1/health"
    method: "GET"
    expected_status: 200
    timeout: 5
    
  # Frontend application health
  - name: "frontend"
    url: "http://127.0.0.1:{{ frontend.vue.port }}/health"
    method: "GET"
    expected_status: 200
    timeout: 10
    
  # DNS cache health
  - name: "dns"
    command: "dig @127.0.0.1 google.com"
    expected_return_code: 0
    timeout: 5

# ==========================================
# BACKUP CONFIGURATION
# ==========================================

backup_paths:
  # Frontend static files
  - path: "{{ autobot.base_dir }}/frontend/dist"
    type: "directory"
    compress: true
    
  # Nginx configuration
  - path: "/etc/nginx/sites-available"
    type: "directory"
    compress: true
    
  # DNS cache configuration
  - path: "/etc/unbound"
    type: "directory"
    compress: true
    
  # Application logs
  - path: "/var/log/autobot/frontend"
    type: "directory"
    compress: true
    retention: 30