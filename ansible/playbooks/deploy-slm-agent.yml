# AutoBot - AI-Powered Automation Platform
# Copyright (c) 2025 mrveiss
# Author: mrveiss
---
# SLM Agent Deployment Playbook
# Deploys the SLM node agent to managed hosts
#
# Usage:
#   ansible-playbook -i inventory/hosts.yml playbooks/deploy-slm-agent.yml
#
# Required variables per host:
#   slm_node_id: Unique identifier for the node (e.g., "vm1-frontend")
#
# Optional variables:
#   slm_services_to_monitor: List of systemd services to monitor
#   slm_heartbeat_interval: Heartbeat interval in seconds (default: 30)

- name: Deploy SLM Agent to managed nodes
  hosts: slm_nodes
  become: yes

  pre_tasks:
    - name: Ensure Python is available
      raw: test -e /usr/bin/python3 || (apt-get update && apt-get install -y python3)
      changed_when: false

  roles:
    - role: common
      tags: ['common']

    - role: slm_agent
      tags: ['slm_agent']

  post_tasks:
    - name: Verify agent is running
      command: systemctl is-active slm-agent
      register: agent_status
      changed_when: false
      failed_when: agent_status.rc != 0

    - name: Display agent status
      debug:
        msg: "SLM Agent on {{ inventory_hostname }} ({{ slm_node_id }}): {{ agent_status.stdout }}"
