# AutoBot - AI-Powered Automation Platform
# Copyright (c) 2025 mrveiss
# Author: mrveiss
---
# AutoBot RBAC Setup Playbook
# Issue #683: Role-Based Access Control Setup via Ansible
#
# This playbook initializes the RBAC system:
# - Creates default system permissions
# - Creates default system roles
# - Assigns permissions to roles
# - Optionally creates initial admin user
#
# Usage:
#   ansible-playbook playbooks/setup-rbac.yml
#   ansible-playbook playbooks/setup-rbac.yml -e "create_admin=true admin_username=admin admin_password=changeme"

- name: "AutoBot RBAC Setup"
  hosts: backend
  gather_facts: true
  become: true
  become_user: autobot
  vars:
    autobot_base_dir: "/opt/autobot"
    python_venv: "{{ autobot_base_dir }}/venv"
    create_admin: false
    admin_username: "admin"
    admin_email: "admin@autobot.local"

    # System permissions matching src/user_management/models/role.py
    system_permissions:
      # User management
      - { name: "users:read", resource: "users", action: "read", description: "View users" }
      - { name: "users:create", resource: "users", action: "create", description: "Create users" }
      - { name: "users:update", resource: "users", action: "update", description: "Update users" }
      - { name: "users:delete", resource: "users", action: "delete", description: "Delete users" }
      # Team management
      - { name: "teams:read", resource: "teams", action: "read", description: "View teams" }
      - { name: "teams:create", resource: "teams", action: "create", description: "Create teams" }
      - { name: "teams:manage", resource: "teams", action: "manage", description: "Manage team members" }
      - { name: "teams:delete", resource: "teams", action: "delete", description: "Delete teams" }
      # Knowledge base
      - { name: "knowledge:read", resource: "knowledge", action: "read", description: "View knowledge base" }
      - { name: "knowledge:write", resource: "knowledge", action: "write", description: "Add/edit knowledge" }
      - { name: "knowledge:delete", resource: "knowledge", action: "delete", description: "Delete knowledge entries" }
      # Chat
      - { name: "chat:use", resource: "chat", action: "use", description: "Use chat functionality" }
      - { name: "chat:history", resource: "chat", action: "history", description: "View chat history" }
      # Files
      - { name: "files:view", resource: "files", action: "view", description: "View files" }
      - { name: "files:upload", resource: "files", action: "upload", description: "Upload files" }
      - { name: "files:download", resource: "files", action: "download", description: "Download files" }
      - { name: "files:delete", resource: "files", action: "delete", description: "Delete files" }
      # Settings
      - { name: "settings:read", resource: "settings", action: "read", description: "View settings" }
      - { name: "settings:write", resource: "settings", action: "write", description: "Modify settings" }
      # Admin
      - { name: "admin:access", resource: "admin", action: "access", description: "Access admin panel" }
      - { name: "admin:users", resource: "admin", action: "users", description: "Manage all users" }
      - { name: "admin:organization", resource: "admin", action: "organization", description: "Manage organization" }
      # Audit
      - { name: "audit:read", resource: "audit", action: "read", description: "View audit logs" }
      - { name: "audit:write", resource: "audit", action: "write", description: "Manage audit logs (cleanup)" }

    # System roles matching src/user_management/models/role.py
    system_roles:
      admin:
        description: "Full administrative access"
        priority: 100
        is_system: true
        permissions:
          - "users:read"
          - "users:create"
          - "users:update"
          - "users:delete"
          - "teams:read"
          - "teams:create"
          - "teams:manage"
          - "teams:delete"
          - "knowledge:read"
          - "knowledge:write"
          - "knowledge:delete"
          - "chat:use"
          - "chat:history"
          - "files:view"
          - "files:upload"
          - "files:download"
          - "files:delete"
          - "settings:read"
          - "settings:write"
          - "admin:access"
          - "admin:users"
          - "admin:organization"
          - "audit:read"
          - "audit:write"
      user:
        description: "Standard user access"
        priority: 50
        is_system: true
        permissions:
          - "users:read"
          - "teams:read"
          - "knowledge:read"
          - "knowledge:write"
          - "chat:use"
          - "chat:history"
          - "files:view"
          - "files:upload"
          - "files:download"
          - "settings:read"
      readonly:
        description: "Read-only access"
        priority: 10
        is_system: true
        permissions:
          - "users:read"
          - "teams:read"
          - "knowledge:read"
          - "chat:history"
          - "files:view"
          - "files:download"
          - "settings:read"
      guest:
        description: "Limited guest access"
        priority: 1
        is_system: true
        permissions:
          - "chat:use"
          - "knowledge:read"
          - "files:view"

  tasks:
    - name: Display RBAC setup information
      debug:
        msg:
          - "ðŸ” AutoBot RBAC Setup Starting"
          - "Environment: {{ autobot.environment }}"
          - "Permissions to create: {{ system_permissions | length }}"
          - "Roles to create: {{ system_roles | length }}"
          - "Create admin user: {{ create_admin }}"

    - name: Ensure AutoBot virtual environment exists
      stat:
        path: "{{ python_venv }}/bin/python"
      register: venv_check

    - name: Fail if virtual environment not found
      fail:
        msg: "Python virtual environment not found at {{ python_venv }}. Please run base setup first."
      when: not venv_check.stat.exists

    - name: Create RBAC initialization script
      copy:
        dest: "{{ autobot_base_dir }}/scripts/init_rbac.py"
        mode: '0755'
        content: |
          #!/usr/bin/env python3
          # AutoBot - AI-Powered Automation Platform
          # Copyright (c) 2025 mrveiss
          # Author: mrveiss
          """
          RBAC Initialization Script

          Issue #683: Role-Based Access Control Setup

          This script initializes the RBAC database tables with:
          - System permissions
          - System roles
          - Role-permission mappings
          - Optional initial admin user
          """

          import asyncio
          import sys
          import os
          import json
          import argparse

          # Add project root to path
          sys.path.insert(0, '{{ autobot_base_dir }}')

          from src.user_management.models.role import (
              Permission, Role, RolePermission,
              SYSTEM_PERMISSIONS, SYSTEM_ROLES
          )
          from src.user_management.models.base import get_session
          from src.user_management.models.user import User
          from sqlalchemy import select
          import uuid


          async def init_permissions(session):
              """Create system permissions if they don't exist."""
              created = 0
              for perm_tuple in SYSTEM_PERMISSIONS:
                  name, resource, action, description = perm_tuple

                  # Check if permission exists
                  result = await session.execute(
                      select(Permission).where(Permission.name == name)
                  )
                  existing = result.scalar_one_or_none()

                  if not existing:
                      perm = Permission(
                          id=uuid.uuid4(),
                          name=name,
                          resource=resource,
                          action=action,
                          description=description
                      )
                      session.add(perm)
                      created += 1
                      print(f"  âœ“ Created permission: {name}")
                  else:
                      print(f"  - Permission exists: {name}")

              await session.commit()
              return created


          async def init_roles(session):
              """Create system roles if they don't exist."""
              created = 0
              for role_name, role_data in SYSTEM_ROLES.items():
                  # Check if role exists
                  result = await session.execute(
                      select(Role).where(Role.name == role_name)
                  )
                  existing = result.scalar_one_or_none()

                  if not existing:
                      role = Role(
                          id=uuid.uuid4(),
                          name=role_name,
                          description=role_data['description'],
                          priority=role_data['priority'],
                          is_system=True
                      )
                      session.add(role)
                      created += 1
                      print(f"  âœ“ Created role: {role_name}")
                  else:
                      print(f"  - Role exists: {role_name}")

              await session.commit()
              return created


          async def assign_permissions_to_roles(session):
              """Assign permissions to roles based on SYSTEM_ROLES configuration."""
              assigned = 0

              for role_name, role_data in SYSTEM_ROLES.items():
                  # Get role
                  result = await session.execute(
                      select(Role).where(Role.name == role_name)
                  )
                  role = result.scalar_one_or_none()

                  if not role:
                      print(f"  âš  Role not found: {role_name}")
                      continue

                  for perm_name in role_data['permissions']:
                      # Get permission
                      result = await session.execute(
                          select(Permission).where(Permission.name == perm_name)
                      )
                      permission = result.scalar_one_or_none()

                      if not permission:
                          print(f"  âš  Permission not found: {perm_name}")
                          continue

                      # Check if assignment exists
                      result = await session.execute(
                          select(RolePermission).where(
                              RolePermission.role_id == role.id,
                              RolePermission.permission_id == permission.id
                          )
                      )
                      existing = result.scalar_one_or_none()

                      if not existing:
                          assignment = RolePermission(
                              role_id=role.id,
                              permission_id=permission.id
                          )
                          session.add(assignment)
                          assigned += 1

              await session.commit()
              print(f"  âœ“ Assigned {assigned} role-permission mappings")
              return assigned


          async def create_admin_user(session, username, email, password_hash):
              """Create initial admin user if not exists."""
              # Check if user exists
              result = await session.execute(
                  select(User).where(User.username == username)
              )
              existing = result.scalar_one_or_none()

              if existing:
                  print(f"  - Admin user exists: {username}")
                  return False

              # Get admin role
              result = await session.execute(
                  select(Role).where(Role.name == 'admin')
              )
              admin_role = result.scalar_one_or_none()

              if not admin_role:
                  print("  âš  Admin role not found!")
                  return False

              # Create user
              user = User(
                  id=uuid.uuid4(),
                  username=username,
                  email=email,
                  password_hash=password_hash,
                  is_active=True,
                  is_verified=True
              )
              session.add(user)
              await session.commit()

              # Assign admin role
              from src.user_management.models.role import UserRole
              user_role = UserRole(
                  user_id=user.id,
                  role_id=admin_role.id
              )
              session.add(user_role)
              await session.commit()

              print(f"  âœ“ Created admin user: {username}")
              return True


          async def main():
              parser = argparse.ArgumentParser(description='Initialize RBAC system')
              parser.add_argument('--create-admin', action='store_true', help='Create admin user')
              parser.add_argument('--admin-username', default='admin', help='Admin username')
              parser.add_argument('--admin-email', default='admin@autobot.local', help='Admin email')
              parser.add_argument('--admin-password-hash', help='Admin password hash')
              args = parser.parse_args()

              print("\nðŸ” AutoBot RBAC Initialization")
              print("=" * 40)

              async with get_session() as session:
                  print("\n1ï¸âƒ£  Initializing permissions...")
                  perm_count = await init_permissions(session)
                  print(f"   Created {perm_count} new permissions")

                  print("\n2ï¸âƒ£  Initializing roles...")
                  role_count = await init_roles(session)
                  print(f"   Created {role_count} new roles")

                  print("\n3ï¸âƒ£  Assigning permissions to roles...")
                  await assign_permissions_to_roles(session)

                  if args.create_admin and args.admin_password_hash:
                      print("\n4ï¸âƒ£  Creating admin user...")
                      await create_admin_user(
                          session,
                          args.admin_username,
                          args.admin_email,
                          args.admin_password_hash
                      )

              print("\nâœ… RBAC initialization complete!")
              print("=" * 40)
              return 0


          if __name__ == '__main__':
              sys.exit(asyncio.run(main()))

    - name: Run RBAC initialization script
      command: >
        {{ python_venv }}/bin/python {{ autobot_base_dir }}/scripts/init_rbac.py
        {% if create_admin %}
        --create-admin
        --admin-username "{{ admin_username }}"
        --admin-email "{{ admin_email }}"
        {% if admin_password is defined %}
        --admin-password-hash "{{ admin_password | password_hash('bcrypt') }}"
        {% endif %}
        {% endif %}
      args:
        chdir: "{{ autobot_base_dir }}"
      environment:
        PYTHONPATH: "{{ autobot_base_dir }}"
      register: rbac_init_result

    - name: Display RBAC initialization results
      debug:
        msg: "{{ rbac_init_result.stdout_lines }}"

    - name: Create RBAC setup marker
      file:
        path: "/etc/autobot/rbac-initialized"
        state: touch
        mode: '0644'
      become: true
      become_user: root

    - name: Display completion message
      debug:
        msg:
          - ""
          - "ðŸŽ‰ RBAC Setup Complete!"
          - "======================"
          - ""
          - "System Permissions: {{ system_permissions | length }} defined"
          - "System Roles: {{ system_roles | length }} defined"
          - ""
          - "Role Hierarchy:"
          - "  admin (100) - Full administrative access"
          - "  user (50)   - Standard user access"
          - "  readonly (10) - Read-only access"
          - "  guest (1)   - Limited guest access"
          - ""
          - "Permission Resources:"
          - "  users, teams, knowledge, chat, files"
          - "  settings, admin, audit"
          - ""
          - "Next Steps:"
          - "  1. Create users via API or admin panel"
          - "  2. Assign roles to users"
          - "  3. Configure organization-specific roles if needed"

# Verification Play
- name: "Verify RBAC Setup"
  hosts: backend
  gather_facts: false
  become: true
  become_user: autobot
  vars:
    autobot_base_dir: "/opt/autobot"
    python_venv: "{{ autobot_base_dir }}/venv"

  tasks:
    - name: Verify permissions count in database
      command: >
        {{ python_venv }}/bin/python -c "
        import asyncio
        import sys
        sys.path.insert(0, '{{ autobot_base_dir }}')
        from src.user_management.models.role import Permission
        from src.user_management.models.base import get_session
        from sqlalchemy import select, func

        async def count():
            async with get_session() as session:
                result = await session.execute(select(func.count(Permission.id)))
                return result.scalar()

        print(asyncio.run(count()))
        "
      args:
        chdir: "{{ autobot_base_dir }}"
      environment:
        PYTHONPATH: "{{ autobot_base_dir }}"
      register: perm_count
      changed_when: false

    - name: Verify roles count in database
      command: >
        {{ python_venv }}/bin/python -c "
        import asyncio
        import sys
        sys.path.insert(0, '{{ autobot_base_dir }}')
        from src.user_management.models.role import Role
        from src.user_management.models.base import get_session
        from sqlalchemy import select, func

        async def count():
            async with get_session() as session:
                result = await session.execute(select(func.count(Role.id)))
                return result.scalar()

        print(asyncio.run(count()))
        "
      args:
        chdir: "{{ autobot_base_dir }}"
      environment:
        PYTHONPATH: "{{ autobot_base_dir }}"
      register: role_count
      changed_when: false

    - name: Display verification results
      debug:
        msg:
          - "RBAC Verification:"
          - "  Permissions in DB: {{ perm_count.stdout }}"
          - "  Roles in DB: {{ role_count.stdout }}"
          - "  Status: {{ 'OK' if (perm_count.stdout | int >= 22) and (role_count.stdout | int >= 4) else 'NEEDS ATTENTION' }}"
