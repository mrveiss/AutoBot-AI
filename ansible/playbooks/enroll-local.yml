# AutoBot - AI-Powered Automation Platform
# Copyright (c) 2025 mrveiss
# Author: mrveiss
#
# Local Enrollment Playbook - Sets up autobot user on local machine
# Run with: ansible-playbook enroll-local.yml -K
---
- name: Enroll Local Machine for SLM
  hosts: localhost
  connection: local
  become: true
  gather_facts: true

  vars:
    autobot_user: autobot
    autobot_group: autobot
    autobot_home: /home/autobot
    slm_agent_dir: /opt/slm-agent
    slm_data_dir: /var/lib/slm-agent
    slm_node_id: "{{ lookup('env', 'SLM_NODE_ID') | default('01-Code-Source', true) }}"
    slm_admin_url: "{{ lookup('env', 'SLM_ADMIN_URL') | default('http://172.16.168.19:8000', true) }}"
    # SLM server's public key - will be fetched dynamically
    slm_server_pubkey: "{{ lookup('env', 'SLM_PUBKEY') | default('', true) }}"

  tasks:
    # ==========================================================
    # User Setup
    # ==========================================================
    - name: Ensure autobot group exists
      group:
        name: "{{ autobot_group }}"
        state: present

    - name: Ensure autobot user exists with proper home
      user:
        name: "{{ autobot_user }}"
        group: "{{ autobot_group }}"
        groups: "sudo"
        append: yes
        shell: /bin/bash
        home: "{{ autobot_home }}"
        create_home: yes
        state: present

    - name: Fix home directory ownership
      file:
        path: "{{ autobot_home }}"
        state: directory
        owner: "{{ autobot_user }}"
        group: "{{ autobot_group }}"
        mode: '0755'

    # ==========================================================
    # SSH Key Setup
    # ==========================================================
    - name: Ensure .ssh directory exists
      file:
        path: "{{ autobot_home }}/.ssh"
        state: directory
        owner: "{{ autobot_user }}"
        group: "{{ autobot_group }}"
        mode: '0700'

    - name: Deploy SLM server SSH public key
      authorized_key:
        user: "{{ autobot_user }}"
        key: "{{ slm_server_pubkey }}"
        state: present
        comment: "SLM Server - AutoBot Fleet Management"
      when: slm_server_pubkey | length > 0

    # ==========================================================
    # Passwordless Sudo
    # ==========================================================
    - name: Configure passwordless sudo for autobot user
      copy:
        dest: /etc/sudoers.d/90-autobot
        content: "{{ autobot_user }} ALL=(ALL) NOPASSWD: ALL\n"
        owner: root
        group: root
        mode: '0440'
        validate: '/usr/sbin/visudo -cf %s'

    # ==========================================================
    # SLM Agent Setup (optional - main machine may not need agent)
    # ==========================================================
    - name: Create SLM agent directories
      file:
        path: "{{ item }}"
        state: directory
        owner: "{{ autobot_user }}"
        group: "{{ autobot_group }}"
        mode: '0755'
      loop:
        - "{{ slm_agent_dir }}"
        - "{{ slm_agent_dir }}/slm"
        - "{{ slm_agent_dir }}/slm/agent"
        - "{{ slm_data_dir }}"

    - name: Display completion message
      debug:
        msg:
          - "========================================"
          - "Local Enrollment Complete"
          - "========================================"
          - "User: {{ autobot_user }}"
          - "SSH Key: {{ 'Deployed' if slm_server_pubkey | length > 0 else 'Not deployed (no key provided)' }}"
          - "Sudo: Passwordless configured"
          - ""
          - "Test SSH from SLM server:"
          - "  ssh autobot@{{ ansible_default_ipv4.address | default('localhost') }} hostname"
