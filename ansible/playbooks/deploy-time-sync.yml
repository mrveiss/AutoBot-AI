---
# AutoBot Time Synchronization Deployment Playbook
# Ensures all VMs use the same timezone and NTP synchronization as main machine

- name: "Deploy Time Synchronization Across AutoBot Infrastructure"
  hosts: production_vms
  become: yes
  gather_facts: yes

  vars:
    # Override time_sync configuration if needed
    time_sync:
      timezone: "{{ system.time_sync.timezone | default('Europe/Riga') }}"
      ntp:
        enabled: true
        servers: "{{ system.time_sync.ntp_servers | default(['0.lv.pool.ntp.org', '1.lv.pool.ntp.org', '2.lv.pool.ntp.org', '3.lv.pool.ntp.org']) }}"
        use_chrony: false  # Use systemd-timesyncd by default
      hardware_clock:
        utc_mode: true
        sync_hwclock: true
      validation:
        max_drift_seconds: 60
        sync_retries: 3
        retry_delay: 10
      logging:
        enable_detailed_logs: true
        log_file: "/var/log/autobot/time-sync.log"

    fallback:
      servers: "{{ system.time_sync.fallback_servers | default(['time.google.com', 'time.cloudflare.com', 'pool.ntp.org']) }}"

  pre_tasks:
    - name: "Time Sync | Display deployment information"
      debug:
        msg:
          - "=============================================="
          - "AutoBot Time Synchronization Deployment"
          - "=============================================="
          - "Target timezone: {{ time_sync.timezone }}"
          - "Main machine: Europe/Riga (EEST, +0300)"
          - "Target hosts: {{ ansible_play_hosts | join(', ') }}"
          - "NTP service: {{ 'chrony' if time_sync.ntp.use_chrony else 'systemd-timesyncd' }}"
          - "Primary NTP servers: {{ time_sync.ntp.servers[:3] | join(', ') }}"
          - "Monitoring: {{ 'enabled' if time_sync.logging.enable_detailed_logs else 'disabled' }}"
          - "=============================================="
      tags: ['time_sync', 'info']

    - name: "Time Sync | Check main machine timezone for reference"
      debug:
        msg: "Ensuring all VMs match main machine timezone: {{ time_sync.timezone }}"
      tags: ['time_sync', 'info']

  roles:
    - time_sync

  post_tasks:
    - name: "Time Sync | Gather final time status from all hosts"
      command: timedatectl status
      register: final_time_status
      changed_when: false
      tags: ['time_sync', 'verification']

    - name: "Time Sync | Display final time status for each host"
      debug:
        msg:
          - "Host: {{ inventory_hostname }}"
          - "{{ final_time_status.stdout_lines }}"
      tags: ['time_sync', 'verification']

    - name: "Time Sync | Create deployment summary"
      local_action:
        module: copy
        content: |
          AutoBot Time Synchronization Deployment Summary
          ===============================================

          Deployment Date: {{ ansible_date_time.iso8601 }}
          Target Timezone: {{ time_sync.timezone }}

          Deployed to Hosts:
          {% for host in ansible_play_hosts %}
          - {{ host }}
          {% endfor %}

          Configuration:
          - NTP Service: {{ 'chrony' if time_sync.ntp.use_chrony else 'systemd-timesyncd' }}
          - Primary NTP Servers: {{ time_sync.ntp.servers | join(', ') }}
          - Fallback Servers: {{ fallback.servers | join(', ') }}
          - Hardware Clock: {{ 'UTC mode' if time_sync.hardware_clock.utc_mode else 'Local time mode' }}
          - Monitoring: {{ 'Enabled (15-minute checks)' if time_sync.logging.enable_detailed_logs else 'Disabled' }}
          - Log File: {{ time_sync.logging.log_file }}

          Validation Commands:
          - Check sync status: /usr/local/bin/check-time-sync.sh status
          - Force synchronization: /usr/local/bin/check-time-sync.sh force-sync
          - View logs: tail -f {{ time_sync.logging.log_file }}

          Network Time Protocol Configuration:
          {% for server in time_sync.ntp.servers %}
          - {{ server }}
          {% endfor %}

          Post-Deployment Steps:
          1. Verify all VMs show synchronized time: timedatectl status
          2. Check NTP server connectivity: /usr/local/bin/check-time-sync.sh status
          3. Monitor synchronization logs: tail -f {{ time_sync.logging.log_file }}
          4. Test time drift monitoring (runs every 15 minutes automatically)

        dest: "/tmp/autobot-time-sync-deployment-{{ ansible_date_time.epoch }}.txt"
      run_once: true
      tags: ['time_sync', 'documentation']

  handlers:
    - name: "restart time services"
      systemd:
        name: "{{ item }}"
        state: restarted
      loop:
        - "{{ 'chrony' if time_sync.ntp.use_chrony else 'systemd-timesyncd' }}"
        - rsyslog
        - cron