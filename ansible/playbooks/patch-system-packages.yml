# AutoBot - AI-Powered Automation Platform
# Copyright (c) 2025 mrveiss
# Author: mrveiss
---
# System Package Patching Playbook (apt updates)
# Issue #682: Rolling system updates for all VMs
#
# This playbook performs apt package updates across all VMs
# with oVirt-style rolling updates and automatic rollback.
#
# Usage:
#   # Preview what will be updated
#   ansible-playbook playbooks/patch-system-packages.yml --check
#
#   # Update all VMs with rolling updates
#   ansible-playbook playbooks/patch-system-packages.yml
#
#   # Update specific group only
#   ansible-playbook playbooks/patch-system-packages.yml --limit backend
#
#   # Security updates only
#   ansible-playbook playbooks/patch-system-packages.yml -e "security_only=true"

- name: "AutoBot System Package Patching - Pre-flight"
  hosts: localhost
  gather_facts: no
  tasks:
    - name: Display patching info
      ansible.builtin.debug:
        msg: |
          ═══════════════════════════════════════════════════════════
          AutoBot System Package Patching (apt updates)
          ═══════════════════════════════════════════════════════════
          Mode: {{ 'DRY RUN' if dry_run | default(false) else 'LIVE UPDATE' }}
          Security Only: {{ security_only | default(false) }}
          Reboot if Required: {{ reboot_if_required | default(false) }}

          Update order (oVirt-style serial execution):
          1. Database (Redis) - stateful, most critical
          2. Backend - depends on Redis
          3. AI Stack - depends on Backend
          4. NPU Workers - depends on AI Stack
          5. Frontend - depends on Backend
          6. Browser - isolated

          Each host will:
          1. Pre-check: List upgradable packages
          2. Backup: Create dpkg state snapshot
          3. Drain: Stop service gracefully
          4. Update: Run apt upgrade
          5. Restart: Restore service
          6. Verify: Health check before proceeding
          ═══════════════════════════════════════════════════════════

    - name: Confirm update
      ansible.builtin.pause:
        prompt: "Press ENTER to proceed with system updates, or Ctrl+C to abort"
      when: not (auto_confirm | default(false))

# Phase 1: Database VMs (Redis Stack) - most critical, update first
- name: "Phase 1: Database VMs (Redis)"
  hosts: database
  become: yes
  serial: 1
  max_fail_percentage: 0
  tasks:
    - name: Include system update tasks
      ansible.builtin.include_role:
        name: dependency_patching
        tasks_from: update-system.yml
  tags:
    - database
    - phase1

# Phase 2: Backend VMs - depends on database
- name: "Phase 2: Backend VMs"
  hosts: backend
  become: yes
  serial: 1
  max_fail_percentage: 0
  tasks:
    - name: Include system update tasks
      ansible.builtin.include_role:
        name: dependency_patching
        tasks_from: update-system.yml
  tags:
    - backend
    - phase2

# Phase 3: AI/ML Stack VMs - depends on backend
- name: "Phase 3: AI/ML Stack VMs"
  hosts: aiml
  become: yes
  serial: 1
  max_fail_percentage: 0
  tasks:
    - name: Include system update tasks
      ansible.builtin.include_role:
        name: dependency_patching
        tasks_from: update-system.yml
  tags:
    - aiml
    - phase3

# Phase 4: NPU Worker VMs - depends on AI stack
- name: "Phase 4: NPU Worker VMs"
  hosts: npu
  become: yes
  serial: 1
  max_fail_percentage: 0
  tasks:
    - name: Include system update tasks
      ansible.builtin.include_role:
        name: dependency_patching
        tasks_from: update-system.yml
  tags:
    - npu
    - phase4

# Phase 5: Frontend VMs - depends on backend API
- name: "Phase 5: Frontend VMs"
  hosts: frontend
  become: yes
  serial: 1
  max_fail_percentage: 0
  tasks:
    - name: Include system update tasks
      ansible.builtin.include_role:
        name: dependency_patching
        tasks_from: update-system.yml
  tags:
    - frontend
    - phase5

# Phase 6: Browser VMs - isolated, can update last
- name: "Phase 6: Browser VMs"
  hosts: browser
  become: yes
  serial: 1
  max_fail_percentage: 0
  tasks:
    - name: Include system update tasks
      ansible.builtin.include_role:
        name: dependency_patching
        tasks_from: update-system.yml
  tags:
    - browser
    - phase6

# Summary
- name: "Post-Update Summary"
  hosts: localhost
  gather_facts: no
  tasks:
    - name: Display completion summary
      ansible.builtin.debug:
        msg: |
          ═══════════════════════════════════════════════════════════
          AutoBot System Package Patching - COMPLETE
          ═══════════════════════════════════════════════════════════

          All system packages have been updated across VMs.

          Next steps:
          1. Verify application functionality
          2. Check service health: ./deploy.sh --health-check
          3. Review update logs in /var/log/apt/

          If issues arise:
          - Check /var/log/dpkg.log for package changes
          - Use ./deploy.sh --rollback-system for emergency rollback

          ═══════════════════════════════════════════════════════════
