# AutoBot - AI-Powered Automation Platform
# Copyright (c) 2025 mrveiss
# Author: mrveiss
#
# Issue #700: Configure Passwordless Sudo for AutoBot User
# =========================================================
#
# This playbook configures passwordless sudo for the autobot user on all VMs.
# This eliminates the need for become passwords in inventory files.
#
# Usage:
#   # First run with become password (one-time setup):
#   ansible-playbook -i inventory/production.yml playbooks/setup-passwordless-sudo.yml --ask-become-pass
#
#   # Or with vault:
#   ansible-playbook -i inventory/production.yml playbooks/setup-passwordless-sudo.yml --ask-vault-pass
#
# After running this playbook, all future ansible operations will work
# without password prompts for the autobot user.

---
- name: Configure Passwordless Sudo for AutoBot
  hosts: all
  become: yes
  gather_facts: yes

  vars:
    sudoers_file: "/etc/sudoers.d/autobot-nopasswd"
    autobot_user: "autobot"

  tasks:
    - name: Display target host information
      ansible.builtin.debug:
        msg: "Configuring passwordless sudo on {{ inventory_hostname }} ({{ ansible_host | default('local') }})"

    - name: Ensure sudoers.d directory exists
      ansible.builtin.file:
        path: /etc/sudoers.d
        state: directory
        owner: root
        group: root
        mode: '0750'

    - name: Create passwordless sudoers file for autobot user
      ansible.builtin.copy:
        dest: "{{ sudoers_file }}"
        content: |
          # AutoBot Passwordless Sudo Configuration
          # Issue #700: Security - Eliminate plaintext passwords
          # Generated by: ansible/playbooks/setup-passwordless-sudo.yml
          #
          # This allows the autobot user to run any command as any user
          # without a password prompt. This is required for Ansible automation.
          #
          # WARNING: Only use this on internal/isolated networks.
          # For production environments with external access, consider
          # limiting sudo privileges to specific commands.

          {{ autobot_user }} ALL=(ALL) NOPASSWD: ALL
        owner: root
        group: root
        mode: '0440'
        validate: '/usr/sbin/visudo -cf %s'
      register: sudoers_result

    - name: Verify sudoers configuration
      ansible.builtin.command:
        cmd: "sudo -l -U {{ autobot_user }}"
      register: sudo_verify
      changed_when: false

    - name: Display sudo verification
      ansible.builtin.debug:
        msg: "{{ sudo_verify.stdout_lines }}"
      when: sudo_verify.stdout_lines is defined

    - name: Report configuration status
      ansible.builtin.debug:
        msg: >
          Passwordless sudo {{ 'configured' if sudoers_result.changed else 'already configured' }}
          for user '{{ autobot_user }}' on {{ inventory_hostname }}

  handlers:
    - name: Validate sudoers
      ansible.builtin.command:
        cmd: "visudo -c"
      changed_when: false
