---
# Manage Services Playbook
# Start, stop, restart, or check status of AutoBot services

- name: "Manage AutoBot Services"
  hosts: "{{ target_host | default('all') }}"
  gather_facts: yes
  become: yes

  vars:
    service_action: "{{ action | default('status') }}"
    valid_actions: ['start', 'stop', 'restart', 'status', 'enable', 'disable']

  pre_tasks:
    - name: "Validate action parameter"
      fail:
        msg: "Invalid action. Valid actions: {{ valid_actions | join(', ') }}"
      when: service_action not in valid_actions
      tags: ['always']

    - name: "Display service management information"
      debug:
        msg:
          - "========================================"
          - "AutoBot Service Management"
          - "========================================"
          - "Target Host: {{ inventory_hostname }}"
          - "Action: {{ service_action }}"
          - "Timestamp: {{ ansible_date_time.iso8601 }}"
      tags: ['always']

  tasks:
    - name: "Manage Frontend Service"
      systemd:
        name: "{{ item }}"
        state: "{{ service_action if service_action in ['started', 'stopped', 'restarted'] else omit }}"
        enabled: "{{ true if service_action == 'enable' else false if service_action == 'disable' else omit }}"
      loop:
        - nginx
        - autobot-frontend
      when: "'frontend' in group_names"
      register: frontend_service_result
      ignore_errors: yes
      tags: ['frontend']

    - name: "Manage Redis Service"
      systemd:
        name: redis-stack-server
        state: "{{ service_action if service_action in ['started', 'stopped', 'restarted'] else omit }}"
        enabled: "{{ true if service_action == 'enable' else false if service_action == 'disable' else omit }}"
      when: "'database' in group_names"
      register: redis_service_result
      ignore_errors: yes
      tags: ['redis']

    - name: "Manage NPU Worker Service"
      systemd:
        name: autobot-npu-worker
        state: "{{ service_action if service_action in ['started', 'stopped', 'restarted'] else omit }}"
        enabled: "{{ true if service_action == 'enable' else false if service_action == 'disable' else omit }}"
      when: "'npu' in group_names"
      register: npu_service_result
      ignore_errors: yes
      tags: ['npu_worker']

    - name: "Manage AI Stack Service"
      systemd:
        name: "{{ item }}"
        state: "{{ service_action if service_action in ['started', 'stopped', 'restarted'] else omit }}"
        enabled: "{{ true if service_action == 'enable' else false if service_action == 'disable' else omit }}"
      loop:
        - ollama
        - autobot-ai-stack
      when: "'aiml' in group_names"
      register: ai_service_result
      ignore_errors: yes
      tags: ['ai_stack']

    - name: "Manage Browser Services"
      systemd:
        name: "{{ item }}"
        state: "{{ service_action if service_action in ['started', 'stopped', 'restarted'] else omit }}"
        enabled: "{{ true if service_action == 'enable' else false if service_action == 'disable' else omit }}"
      loop:
        - autobot-vnc
        - autobot-playwright
      when: "'browser' in group_names"
      register: browser_service_result
      ignore_errors: yes
      tags: ['browser']

  post_tasks:
    - name: "Get service status (when action is status)"
      systemd:
        name: "{{ item }}"
      register: service_status
      loop: "{{ services | default([]) }}"
      when: service_action == 'status'
      ignore_errors: yes

    - name: "Display service management summary"
      debug:
        msg:
          - "========================================"
          - "Service Management Complete"
          - "========================================"
          - "Host: {{ inventory_hostname }}"
          - "Action: {{ service_action }}"
          - "Status: Operation completed"
      tags: ['always']
