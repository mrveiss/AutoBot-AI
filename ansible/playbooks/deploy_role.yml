---
# Deploy Role Playbook
# Deploy or update a specific role on target host(s)

- name: "Deploy AutoBot Role"
  hosts: "{{ target_host | default('all') }}"
  gather_facts: yes
  become: yes

  vars:
    deploy_timestamp: "{{ ansible_date_time.iso8601 }}"
    deploy_role: "{{ role_name | default('common') }}"

  pre_tasks:
    - name: "Validate role_name parameter"
      fail:
        msg: "role_name parameter is required. Use: -e 'role_name=<role>'"
      when: role_name is not defined
      tags: ['always']

    - name: "Display deployment information"
      debug:
        msg:
          - "========================================"
          - "AutoBot Role Deployment"
          - "========================================"
          - "Target Host: {{ inventory_hostname }}"
          - "Role: {{ deploy_role }}"
          - "IP Address: {{ ansible_default_ipv4.address | default('N/A') }}"
          - "Timestamp: {{ deploy_timestamp }}"
      tags: ['always']

  tasks:
    - name: "Apply Common Role"
      include_role:
        name: common
      when: deploy_role == 'common'
      tags: ['common']

    - name: "Apply Frontend Role"
      include_role:
        name: frontend
      when: deploy_role == 'frontend'
      tags: ['frontend']

    - name: "Apply Redis Role"
      include_role:
        name: redis
      when: deploy_role == 'redis'
      tags: ['redis']

    - name: "Apply NPU Worker Role"
      include_role:
        name: npu_worker
      when: deploy_role == 'npu_worker'
      tags: ['npu_worker']

    - name: "Apply AI Stack Role"
      include_role:
        name: ai_stack
      when: deploy_role == 'ai_stack'
      tags: ['ai_stack']

    - name: "Apply Browser Role"
      include_role:
        name: browser
      when: deploy_role == 'browser'
      tags: ['browser']

  post_tasks:
    - name: "Display deployment summary"
      debug:
        msg:
          - "========================================"
          - "Role Deployment Complete"
          - "========================================"
          - "Host: {{ inventory_hostname }}"
          - "Role: {{ deploy_role }}"
          - "Status: Deployed successfully"
      tags: ['always']
