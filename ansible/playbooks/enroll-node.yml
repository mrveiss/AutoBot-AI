---
# Node Enrollment Playbook - Issue #695
# oVirt-style host enrollment for AutoBot infrastructure
#
# This playbook handles the complete enrollment process for new nodes:
# 1. Base system configuration (common role)
# 2. Role-specific setup (frontend, npu, redis, etc.)
# 3. Certificate deployment (via PKI module)
# 4. Service configuration and startup
#
# Usage:
#   ansible-playbook enroll-node.yml -i inventory.yml \
#     -e "target_host=new-node" \
#     -e "node_role=npu-worker"
#
# Required variables:
#   - target_host: Hostname of the node to enroll
#   - node_role: Role to assign (frontend, npu-worker, redis, ai-stack, browser)
#
# Optional variables:
#   - skip_pki: Set to true to skip PKI certificate deployment
#   - dry_run: Set to true for validation only

- name: "AutoBot Node Enrollment"
  hosts: "{{ target_host | default('all') }}"
  gather_facts: yes
  become: yes

  vars:
    enrollment_timestamp: "{{ ansible_date_time.iso8601 }}"
    autobot_user: "autobot"
    autobot_group: "autobot"
    autobot_home: "/home/autobot"
    autobot_data_dir: "/var/lib/autobot"
    autobot_log_dir: "/var/log/autobot"
    autobot_cert_dir: "/etc/autobot/certs"

    # Emergency admin user for fallback access when SSH keys fail
    emergency_admin_user: "autobot_admin"
    # Password hash generated with: python3 -c "from passlib.hash import sha512_crypt; print(sha512_crypt.hash('password'))"
    emergency_admin_password_hash: "$6$rounds=656000$VqQZbIggJvVNjHfl$hunhLQdMKj/TCyE.ftDknskbz4SCnGz5e6Yo4YJzHeIIhdRAp/oIDKdwd54oktyBwmb2nP09MWRyXNu0mLg1L1"

    # Role-specific defaults
    role_configs:
      frontend:
        services: ['nginx', 'node']
        packages: ['nodejs', 'npm', 'nginx']
        ports: [5173, 80, 443]
      npu-worker:
        services: ['npu-service']
        packages: ['python3', 'python3-pip', 'python3-venv']
        ports: [8081]
      redis:
        services: ['redis-stack-server']
        packages: ['redis-stack-server']
        ports: [6379, 6380]
      ai-stack:
        services: ['llm-server']
        packages: ['python3', 'python3-pip', 'python3-venv']
        ports: [8080]
      browser:
        services: ['playwright-service', 'vnc-server']
        packages: ['python3', 'xvfb', 'tigervnc-standalone-server']
        ports: [3000, 5900]
      slm-agent:
        services: ['slm-agent']
        packages: ['python3', 'python3-pip', 'python3-venv']
        ports: [8000]

  pre_tasks:
    - name: "Display enrollment information"
      debug:
        msg:
          - "========================================"
          - "AutoBot Node Enrollment - Issue #695"
          - "========================================"
          - "Target Host: {{ inventory_hostname }}"
          - "Node Role: {{ node_role | default('not specified') }}"
          - "IP Address: {{ ansible_default_ipv4.address | default('N/A') }}"
          - "OS: {{ ansible_distribution }} {{ ansible_distribution_version }}"
          - "Timestamp: {{ enrollment_timestamp }}"
      tags: ['always']

    - name: "Validate node role"
      fail:
        msg: "Invalid or missing node_role. Must be one of: frontend, npu-worker, redis, ai-stack, browser"
      when: node_role is not defined or node_role not in role_configs
      tags: ['always']

    - name: "Check OS compatibility"
      fail:
        msg: "Unsupported OS: {{ ansible_distribution }}. AutoBot requires Debian or Ubuntu."
      when: ansible_os_family != 'Debian'
      tags: ['always']

  tasks:
    # ===========================================
    # Phase 1: Base System Configuration
    # ===========================================
    - name: "Phase 1 - Base System Setup"
      block:
        - name: "Update apt cache"
          apt:
            update_cache: yes
            cache_valid_time: 3600

        - name: "Install base packages"
          apt:
            name:
              - curl
              - wget
              - gnupg
              - ca-certificates
              - apt-transport-https
              - software-properties-common
              - python3
              - python3-pip
              - git
              - vim
              - htop
              - iotop
              - net-tools
              - rsync
            state: present

        - name: "Create AutoBot user"
          user:
            name: "{{ autobot_user }}"
            group: "{{ autobot_group }}"
            groups: sudo
            shell: /bin/bash
            home: "{{ autobot_home }}"
            create_home: yes
            state: present
          ignore_errors: yes  # User may already exist

        - name: "Create AutoBot directories"
          file:
            path: "{{ item }}"
            state: directory
            owner: "{{ autobot_user }}"
            group: "{{ autobot_group }}"
            mode: '0755'
          loop:
            - "{{ autobot_data_dir }}"
            - "{{ autobot_log_dir }}"
            - "{{ autobot_cert_dir }}"
            - "{{ autobot_home }}/.ssh"

        - name: "Configure SSH authorized keys"
          authorized_key:
            user: "{{ autobot_user }}"
            state: present
            key: "{{ lookup('file', '~/.ssh/autobot_key.pub') }}"
          ignore_errors: yes  # Key may not exist during initial enrollment

        - name: "Create emergency admin user"
          user:
            name: "{{ emergency_admin_user }}"
            comment: "Emergency Admin User (fallback access)"
            shell: /bin/bash
            create_home: yes
            groups: sudo
            append: yes
            password: "{{ emergency_admin_password_hash }}"
            state: present

        - name: "Configure passwordless sudo for emergency admin"
          copy:
            content: "{{ emergency_admin_user }} ALL=(ALL) NOPASSWD: ALL\n"
            dest: "/etc/sudoers.d/90-{{ emergency_admin_user }}"
            owner: root
            group: root
            mode: '0440'
            validate: 'visudo -cf %s'

        - name: "Configure passwordless sudo for autobot user"
          copy:
            content: "{{ autobot_user }} ALL=(ALL) NOPASSWD: ALL\n"
            dest: "/etc/sudoers.d/90-{{ autobot_user }}"
            owner: root
            group: root
            mode: '0440'
            validate: 'visudo -cf %s'

      tags: ['base', 'common']

    # ===========================================
    # Phase 2: Role-Specific Configuration
    # ===========================================
    - name: "Phase 2 - Role-Specific Setup for {{ node_role }}"
      block:
        - name: "Install role-specific packages"
          apt:
            name: "{{ role_configs[node_role].packages }}"
            state: present
          when: role_configs[node_role].packages | length > 0

        # Frontend-specific setup
        - name: "Setup Node.js for frontend"
          when: node_role == 'frontend'
          block:
            - name: "Add NodeSource repository"
              shell: |
                curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
              args:
                creates: /etc/apt/sources.list.d/nodesource.list

            - name: "Install Node.js"
              apt:
                name: nodejs
                state: present
                update_cache: yes

        # Redis-specific setup
        - name: "Setup Redis Stack"
          when: node_role == 'redis'
          block:
            - name: "Add Redis Stack repository"
              shell: |
                curl -fsSL https://packages.redis.io/gpg | gpg --dearmor -o /usr/share/keyrings/redis-archive-keyring.gpg
                echo "deb [signed-by=/usr/share/keyrings/redis-archive-keyring.gpg] https://packages.redis.io/deb $(lsb_release -cs) main" > /etc/apt/sources.list.d/redis.list
              args:
                creates: /etc/apt/sources.list.d/redis.list

            - name: "Install Redis Stack Server"
              apt:
                name: redis-stack-server
                state: present
                update_cache: yes

        # NPU Worker setup
        - name: "Setup NPU Worker"
          when: node_role == 'npu-worker'
          block:
            - name: "Create Python virtual environment"
              become_user: "{{ autobot_user }}"
              command: python3 -m venv {{ autobot_home }}/venv
              args:
                creates: "{{ autobot_home }}/venv/bin/activate"

            - name: "Install OpenVINO dependencies"
              apt:
                name:
                  - libopencv-dev
                  - python3-opencv
                state: present

        # AI Stack setup
        - name: "Setup AI Stack"
          when: node_role == 'ai-stack'
          block:
            - name: "Create Python virtual environment for AI"
              become_user: "{{ autobot_user }}"
              command: python3 -m venv {{ autobot_home }}/venv
              args:
                creates: "{{ autobot_home }}/venv/bin/activate"

        # Browser automation setup
        - name: "Setup Browser Automation"
          when: node_role == 'browser'
          block:
            - name: "Install Playwright dependencies"
              apt:
                name:
                  - xvfb
                  - xauth
                  - x11-utils
                  - libnss3
                  - libnspr4
                  - libatk1.0-0
                  - libatk-bridge2.0-0
                  - libcups2
                  - libdrm2
                  - libdbus-1-3
                  - libxkbcommon0
                  - libxcomposite1
                  - libxdamage1
                  - libxfixes3
                  - libxrandr2
                  - libgbm1
                  - libasound2
                state: present

      tags: ['role-setup']

    # ===========================================
    # Phase 3: Firewall Configuration
    # ===========================================
    - name: "Phase 3 - Firewall Configuration"
      block:
        - name: "Install UFW"
          apt:
            name: ufw
            state: present

        - name: "Allow SSH"
          ufw:
            rule: allow
            port: '22'
            proto: tcp

        - name: "Allow role-specific ports"
          ufw:
            rule: allow
            port: "{{ item }}"
            proto: tcp
          loop: "{{ role_configs[node_role].ports }}"

        - name: "Enable UFW"
          ufw:
            state: enabled
            policy: deny
            direction: incoming

      tags: ['firewall']
      ignore_errors: yes  # Firewall may be managed externally

    # ===========================================
    # Phase 4: Service Registration
    # ===========================================
    - name: "Phase 4 - Service Registration"
      block:
        - name: "Create service status file"
          copy:
            content: |
              {
                "hostname": "{{ inventory_hostname }}",
                "role": "{{ node_role }}",
                "ip": "{{ ansible_default_ipv4.address }}",
                "enrolled_at": "{{ enrollment_timestamp }}",
                "status": "enrolled"
              }
            dest: "{{ autobot_data_dir }}/node-status.json"
            owner: "{{ autobot_user }}"
            group: "{{ autobot_group }}"
            mode: '0644'

      tags: ['register']

  post_tasks:
    - name: "Display enrollment summary"
      debug:
        msg:
          - "========================================"
          - "Enrollment Complete"
          - "========================================"
          - "Host: {{ inventory_hostname }}"
          - "Role: {{ node_role }}"
          - "IP: {{ ansible_default_ipv4.address }}"
          - "Status: Ready"
          - ""
          - "Next Steps:"
          - "1. Deploy application code to {{ autobot_home }}"
          - "2. Configure role-specific services"
          - "3. Start services via manage_services.yml"
          - "4. Verify with health-check.yml"
      tags: ['always']

  handlers:
    - name: restart ssh
      service:
        name: ssh
        state: restarted

    - name: restart ufw
      service:
        name: ufw
        state: restarted
