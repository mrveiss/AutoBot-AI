# Redis Stack Configuration for AutoBot
# Generated by Ansible - DO NOT EDIT MANUALLY
# Managed via ansible/inventory/group_vars/database.yml

# ==========================================
# NETWORK CONFIGURATION
# ==========================================

bind {{ redis.bind }}
port {{ redis.port }}
protected-mode {{ redis.protected_mode | lower }}

# ==========================================
# CONNECTION POOLING
# ==========================================

# Maximum number of client connections
maxclients {{ redis.connection.max_connections * 10 }}  # Server allows 10x pool size

# TCP settings
tcp-backlog {{ redis.performance.tcp_backlog }}
tcp-keepalive {{ redis.performance.tcp_keepalive }}
timeout {{ redis.performance.timeout }}

# ==========================================
# MEMORY MANAGEMENT
# ==========================================

maxmemory {{ redis.memory.maxmemory }}
maxmemory-policy {{ redis.memory.maxmemory_policy }}

# ==========================================
# PERSISTENCE (RDB)
# ==========================================

{% for save_rule in redis.persistence.save %}
save {{ save_rule }}
{% endfor %}

stop-writes-on-bgsave-error {{ performance.redis_optimization.stop_writes_on_bgsave_error | lower }}
rdbcompression {{ performance.redis_optimization.rdbcompression | lower }}
rdbchecksum {{ performance.redis_optimization.rdbchecksum | lower }}
dbfilename {{ redis.persistence.rdb_filename }}
dir {{ redis.persistence.rdb_dir }}

# ==========================================
# APPEND ONLY FILE (AOF)
# ==========================================

appendonly {{ redis.persistence.appendonly | lower }}
appendfilename "{{ redis.persistence.appendfilename }}"
appendfsync {{ redis.persistence.appendfsync }}
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# ==========================================
# DATABASE CONFIGURATION
# ==========================================

databases {{ redis.performance.databases }}

# ==========================================
# LOGGING
# ==========================================

loglevel {{ redis.log.level }}
logfile "{{ redis.log.file }}"
syslog-enabled {{ redis.log.syslog_enabled | lower }}
syslog-ident {{ redis.log.syslog_ident }}

# ==========================================
# PERFORMANCE OPTIMIZATION
# ==========================================

# Multi-threaded I/O for better CPU utilization (Redis 6.0+)
# Enables parallel processing across multiple CPU cores
{% if redis.performance.io_threads is defined and redis.performance.io_threads > 1 %}
io-threads {{ redis.performance.io_threads }}
io-threads-do-reads yes
{% else %}
# Default: single-threaded (set redis.performance.io_threads in inventory)
io-threads 1
{% endif %}

# Lazy freeing for better performance
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes
replica-lazy-flush yes

# Hash optimization
hash-max-ziplist-entries {{ performance.redis_optimization.hash_max_ziplist_entries }}
hash-max-ziplist-value {{ performance.redis_optimization.hash_max_ziplist_value }}

# List optimization
list-max-ziplist-entries {{ performance.redis_optimization.list_max_ziplist_entries }}
list-max-ziplist-value {{ performance.redis_optimization.list_max_ziplist_value }}

# Active defragmentation (Redis 4.0+)
activedefrag yes
active-defrag-ignore-bytes 100mb
active-defrag-threshold-lower 10
active-defrag-threshold-upper 25
active-defrag-cycle-min 5
active-defrag-cycle-max 75

# ==========================================
# REDIS STACK MODULES
# ==========================================

# RediSearch module for full-text search
loadmodule /opt/redis-stack/lib/redisearch.so
# RedisJSON for JSON data types
loadmodule /opt/redis-stack/lib/rejson.so
# RedisGraph for graph database
loadmodule /opt/redis-stack/lib/redisgraph.so
# RedisTimeSeries for time series data
loadmodule /opt/redis-stack/lib/redistimeseries.so
# RedisBloom for probabilistic data structures
loadmodule /opt/redis-stack/lib/redisbloom.so

# ==========================================
# SECURITY
# ==========================================

{% if security.redis_security.auth_enabled %}
requirepass {{ redis.password }}
{% endif %}

{% if security.redis_security.acl_enabled %}
aclfile {{ redis_config_dir }}/acl.conf
{% endif %}

# ==========================================
# MONITORING
# ==========================================

# Keyspace notifications for monitoring
notify-keyspace-events "Ex"

# Slow log configuration
slowlog-log-slower-than 10000
slowlog-max-len 128

# ==========================================
# CLIENT OUTPUT BUFFER LIMITS
# ==========================================

client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# ==========================================
# AUTOBOT SPECIFIC CONFIGURATION
# ==========================================

# Database assignments documented here
# DB 0: Main application + Knowledge base (RediSearch requires DB 0)
# DB 1: Performance metrics and monitoring
# DB 2: Prompt templates
# DB 3: Agent coordination
# DB 4: Application cache
# DB 6: User sessions
# DB 8: Chat history
# DB 10: Backup data
# DB 15: Testing (isolated)