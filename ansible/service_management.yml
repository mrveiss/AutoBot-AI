---
# AutoBot Service Management Playbook
- name: Manage AutoBot Services
  hosts: "{{ target | default('autobot_cluster') }}"
  become: yes
  vars:
    action: "{{ service_action | default('status') }}"  # start, stop, restart, status
    
  tasks:
    - name: Manage AutoBot services
      systemd:
        name: "autobot-{{ item.name }}"
        state: "{{ action }}"
        enabled: yes
      loop: "{{ services }}"
      when: services is defined
      
    - name: Check service status
      systemd:
        name: "autobot-{{ item.name }}"
      loop: "{{ services }}"
      register: service_status
      when: action == 'status'
      
    - name: Display service status
      debug:
        msg: "Service {{ item.item.name }}: {{ item.status.ActiveState }}"
      loop: "{{ service_status.results }}"
      when: action == 'status' and service_status is defined

# Health check tasks
- name: Health Check All Services
  hosts: autobot_cluster
  tasks:
    - name: Check HTTP endpoints
      uri:
        url: "http://{{ ansible_host }}:{{ item.port }}/health"
        method: GET
        timeout: 10
      loop: "{{ services }}"
      register: health_checks
      ignore_errors: yes
      when: item.port is defined
      
    - name: Report health status
      debug:
        msg: "{{ ansible_hostname }} - {{ item.item.name }}: {{ 'HEALTHY' if item.status == 200 else 'UNHEALTHY' }}"
      loop: "{{ health_checks.results }}"
      when: health_checks is defined