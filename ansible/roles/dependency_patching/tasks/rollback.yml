# AutoBot - AI-Powered Automation Platform
# Copyright (c) 2025 mrveiss
# Author: mrveiss
---
# Rollback Tasks
# Issue #682: Restore from backup on update failure

- name: Get current service definition
  ansible.builtin.set_fact:
    current_service: "{{ service_definitions[group_names | first] | default({}) }}"

- name: Check if backup exists
  ansible.builtin.stat:
    path: "{{ latest_backup | default('') }}"
  register: backup_exists
  when: latest_backup is defined

- name: Fail if no backup is available
  ansible.builtin.fail:
    msg: "CRITICAL: No backup available for rollback on {{ inventory_hostname }}. Cannot restore."
  when:
    - latest_backup is not defined or (backup_exists.stat.exists | default(false)) == false
    - current_service.has_python_venv | default(false)

- name: Log rollback initiation
  ansible.builtin.debug:
    msg: "Initiating rollback on {{ inventory_hostname }} from {{ latest_backup | default('no backup') }}"

- name: Stop service before rollback
  ansible.builtin.systemd:
    name: "{{ current_service.service_name }}"
    state: stopped
  when:
    - current_service.service_name is defined
  ignore_errors: yes

- name: Set venv path variable
  ansible.builtin.set_fact:
    target_venv_path: "{{ current_service.venv_path | default(venv_path) }}"

- name: Create temporary restore directory
  ansible.builtin.tempfile:
    state: directory
    prefix: venv_restore_
  register: temp_restore_dir
  when:
    - backup_exists.stat.exists | default(false)

- name: Extract backup to temporary location first (safety)
  ansible.builtin.unarchive:
    src: "{{ latest_backup }}"
    dest: "{{ temp_restore_dir.path }}"
    remote_src: yes
  when:
    - backup_exists.stat.exists | default(false)
    - temp_restore_dir.path is defined
  register: temp_extract
  timeout: "{{ rollback_timeout }}"

- name: Verify extracted venv structure exists
  ansible.builtin.stat:
    path: "{{ temp_restore_dir.path }}/venv/bin/python"
  register: extracted_venv_check
  when:
    - temp_extract.changed | default(false)

- name: Fail if extracted backup is invalid
  ansible.builtin.fail:
    msg: "CRITICAL: Backup extraction failed or backup is corrupted. Original venv preserved at {{ target_venv_path }}"
  when:
    - temp_extract.changed | default(false)
    - not (extracted_venv_check.stat.exists | default(false))

- name: Remove failed venv (only after backup verified)
  ansible.builtin.file:
    path: "{{ target_venv_path }}"
    state: absent
  when:
    - temp_extract.changed | default(false)
    - extracted_venv_check.stat.exists | default(false)

- name: Move restored venv to target location
  ansible.builtin.command:
    cmd: "mv {{ temp_restore_dir.path }}/venv {{ target_venv_path }}"
  when:
    - temp_extract.changed | default(false)
    - extracted_venv_check.stat.exists | default(false)
  register: venv_restored

- name: Clean up temporary restore directory
  ansible.builtin.file:
    path: "{{ temp_restore_dir.path }}"
    state: absent
  when:
    - temp_restore_dir.path is defined
  ignore_errors: yes

- name: Restart service after rollback
  ansible.builtin.systemd:
    name: "{{ current_service.service_name }}"
    state: restarted
    daemon_reload: yes
  when:
    - current_service.service_name is defined
    - venv_restored.changed | default(false)
  register: service_restart_rollback

- name: Wait for service to stabilize after rollback
  ansible.builtin.pause:
    seconds: "{{ service_restart_delay }}"
  when: service_restart_rollback.changed | default(false)

- name: Verify service health after rollback
  ansible.builtin.uri:
    url: "http://localhost:{{ current_service.health_port }}{{ current_service.health_endpoint }}"
    method: GET
    status_code: 200
    timeout: "{{ health_check_timeout }}"
  register: rollback_health_check
  until: rollback_health_check.status == 200
  retries: "{{ health_check_retries }}"
  delay: "{{ health_check_delay }}"
  when:
    - current_service.health_endpoint is defined
    - current_service.health_endpoint is not none
    - venv_restored.changed | default(false)

- name: Fail if rollback health check failed
  ansible.builtin.fail:
    msg: "CRITICAL: Rollback completed but service health check FAILED on {{ inventory_hostname }}. Manual intervention required."
  when:
    - current_service.health_endpoint is defined
    - current_service.health_endpoint is not none
    - venv_restored.changed | default(false)
    - rollback_health_check.failed | default(false)

- name: Log rollback result
  ansible.builtin.debug:
    msg: |
      Rollback {{ 'SUCCESSFUL' if (venv_restored.changed | default(false)) else 'FAILED' }} on {{ inventory_hostname }}
      Backup restored: {{ latest_backup | default('none') }}
      Service running: {{ service_restart_rollback.changed | default(false) }}
      Health check: {{ 'PASSED' if rollback_health_check.status | default(0) == 200 else 'FAILED or N/A' }}

- name: Record rollback state
  ansible.builtin.set_fact:
    rollback_state:
      host: "{{ inventory_hostname }}"
      backup_restored: "{{ venv_restored.changed | default(false) }}"
      service_restarted: "{{ service_restart_rollback.changed | default(false) }}"
      health_check_passed: "{{ rollback_health_check.status | default(0) == 200 }}"
      timestamp: "{{ ansible_date_time.iso8601 }}"
