# AutoBot - AI-Powered Automation Platform
# Copyright (c) 2025 mrveiss
# Author: mrveiss
---
# System Package Rollback Tasks
# Issue #682: Emergency rollback for system package updates
#
# Note: Full apt rollback is complex and not always possible.
# This task file handles service restoration and documents the issue.
# For full package rollback, manual intervention may be required.

- name: Get current service definition
  ansible.builtin.set_fact:
    current_service: "{{ service_definitions[group_names | first] | default({}) }}"

- name: Find latest dpkg backup
  ansible.builtin.find:
    paths: "{{ backup_base_path }}/system"
    patterns: "dpkg-selections-*.txt"
    age: "-7d"
  register: dpkg_backups

- name: Set latest backup path
  ansible.builtin.set_fact:
    latest_dpkg_backup: "{{ (dpkg_backups.files | sort(attribute='mtime', reverse=true) | first).path | default('') }}"
  when: dpkg_backups.files | length > 0

- name: Log rollback initiation
  ansible.builtin.debug:
    msg: |
      ═══════════════════════════════════════════════════════════
      ⚠️ SYSTEM ROLLBACK INITIATED on {{ inventory_hostname }}
      ═══════════════════════════════════════════════════════════

      Latest dpkg backup: {{ latest_dpkg_backup | default('NONE FOUND') }}

      NOTE: Full apt package rollback is complex and may require
      manual intervention. This procedure will:
      1. Attempt to restore services
      2. Log the failed packages
      3. Provide dpkg backup for manual recovery
      ═══════════════════════════════════════════════════════════

- name: Stop potentially broken service
  ansible.builtin.systemd:
    name: "{{ current_service.service_name }}"
    state: stopped
  when:
    - current_service.service_name is defined
  ignore_errors: yes
  register: service_stop_rollback

- name: Wait for service to stop
  ansible.builtin.pause:
    seconds: 5
  when: service_stop_rollback.changed | default(false)

- name: Attempt apt fix broken packages
  ansible.builtin.apt:
    state: fixed
  register: apt_fix
  ignore_errors: yes
  timeout: 300

- name: Log apt fix result
  ansible.builtin.debug:
    msg: "apt --fix-broken: {{ 'SUCCESS' if not apt_fix.failed else 'FAILED' }}"

- name: Reload systemd daemon first
  ansible.builtin.systemd:
    daemon_reload: yes

- name: Check if service unit file exists
  ansible.builtin.stat:
    path: "/etc/systemd/system/{{ current_service.service_name }}.service"
  register: service_unit_file
  when: current_service.service_name is defined

- name: Check for service in /lib/systemd if not in /etc
  ansible.builtin.stat:
    path: "/lib/systemd/system/{{ current_service.service_name }}.service"
  register: service_unit_file_lib
  when:
    - current_service.service_name is defined
    - not (service_unit_file.stat.exists | default(false))

- name: Restart service after fix attempt
  ansible.builtin.systemd:
    name: "{{ current_service.service_name }}"
    state: restarted
  when:
    - current_service.service_name is defined
    - (service_unit_file.stat.exists | default(false)) or (service_unit_file_lib.stat.exists | default(false))
  register: service_restart_rollback
  ignore_errors: yes

- name: Wait for service to stabilize after rollback
  ansible.builtin.pause:
    seconds: "{{ service_restart_delay }}"
  when: service_restart_rollback.changed | default(false)

- name: Verify service health after rollback
  ansible.builtin.uri:
    url: "http://localhost:{{ current_service.health_port }}{{ current_service.health_endpoint }}"
    method: GET
    status_code: 200
    timeout: "{{ health_check_timeout }}"
  register: rollback_health_check
  until: rollback_health_check.status == 200
  retries: "{{ health_check_retries }}"
  delay: "{{ health_check_delay }}"
  when:
    - health_check_enabled
    - current_service.health_endpoint is defined
    - current_service.health_endpoint is not none
  ignore_errors: yes

- name: Log rollback result
  ansible.builtin.debug:
    msg: |
      System rollback result on {{ inventory_hostname }}:
      - apt fix-broken: {{ 'SUCCESS' if not (apt_fix.failed | default(false)) else 'FAILED' }}
      - Service restarted: {{ service_restart_rollback.changed | default(false) }}
      - Health check: {{ 'PASSED' if (rollback_health_check.status | default(0)) == 200 else 'FAILED or N/A' }}

      {% if latest_dpkg_backup %}
      For manual package rollback, use:
        dpkg --set-selections < {{ latest_dpkg_backup }}
        apt-get dselect-upgrade
      {% endif %}

- name: Fail if rollback health check failed
  ansible.builtin.fail:
    msg: |
      CRITICAL: System rollback attempted but service health check FAILED on {{ inventory_hostname }}.

      Manual intervention required:
      1. SSH to {{ inventory_hostname }}
      2. Check service logs: journalctl -u {{ current_service.service_name | default('autobot-*') }}
      3. Check apt logs: /var/log/apt/history.log
      4. Consider manual package rollback using dpkg backup
  when:
    - health_check_enabled
    - current_service.health_endpoint is defined
    - current_service.health_endpoint is not none
    - rollback_health_check.failed | default(false)

- name: Record rollback state
  ansible.builtin.set_fact:
    system_rollback_state:
      host: "{{ inventory_hostname }}"
      apt_fixed: "{{ not (apt_fix.failed | default(false)) }}"
      service_restarted: "{{ service_restart_rollback.changed | default(false) }}"
      health_check_passed: "{{ (rollback_health_check.status | default(0)) == 200 }}"
      dpkg_backup: "{{ latest_dpkg_backup | default('none') }}"
      timestamp: "{{ ansible_date_time.iso8601 }}"
