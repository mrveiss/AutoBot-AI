# AutoBot - AI-Powered Automation Platform
# Copyright (c) 2025 mrveiss
# Author: mrveiss
---
# Post-Update Tasks
# Issue #682: Health verification, service restart, cleanup

- name: Get current service definition
  ansible.builtin.set_fact:
    current_service: "{{ service_definitions[group_names | first] | default({}) }}"

- name: Restart service after update
  ansible.builtin.systemd:
    name: "{{ current_service.service_name }}"
    state: restarted
    daemon_reload: yes
  when:
    - restart_service_after_update
    - current_service.service_name is defined
    - pre_update_state.service_was_running | default(false)
  register: service_restart

- name: Wait for service to stabilize
  ansible.builtin.pause:
    seconds: "{{ service_restart_delay }}"
  when: service_restart.changed | default(false)

- name: Verify service health (HTTP endpoint)
  ansible.builtin.uri:
    url: "http://localhost:{{ current_service.health_port }}{{ current_service.health_endpoint }}"
    method: GET
    status_code: 200
    timeout: "{{ health_check_timeout }}"
  register: health_check
  until: health_check.status == 200
  retries: "{{ health_check_retries }}"
  delay: "{{ health_check_delay }}"
  when:
    - health_check_enabled
    - current_service.health_endpoint is defined
    - current_service.health_endpoint is not none

- name: Verify Redis health (for database group)
  ansible.builtin.command:
    cmd: redis-cli ping
  register: redis_health
  until: redis_health.stdout == "PONG"
  retries: "{{ health_check_retries }}"
  delay: "{{ health_check_delay }}"
  when:
    - health_check_enabled
    - "'database' in group_names"
  changed_when: false

- name: Health check failed - initiate rollback
  block:
    - name: Log health check failure
      ansible.builtin.debug:
        msg: "Health check failed on {{ inventory_hostname }}. Initiating rollback..."

    - name: Include rollback tasks
      ansible.builtin.include_tasks: rollback.yml
      when: rollback_on_failure

    - name: Fail the play after rollback
      ansible.builtin.fail:
        msg: "Health check failed after update on {{ inventory_hostname }}. Rollback {{ 'completed' if rollback_on_failure else 'skipped' }}."
  when:
    - health_check_enabled
    - (health_check.failed | default(false)) or (redis_health.failed | default(false))

- name: Clean up old backups (retain last N days)
  ansible.builtin.find:
    paths: "{{ backup_base_path }}"
    patterns: "venv-*.tar.gz"
    age: "{{ backup_retention_days }}d"
  register: old_backups
  when: backup_enabled

- name: Remove old backups
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: absent
  loop: "{{ old_backups.files | default([]) }}"
  when: backup_enabled

- name: Log successful update completion
  ansible.builtin.debug:
    msg: |
      Update completed successfully on {{ inventory_hostname }}
      Service: {{ current_service.service_name | default('N/A') }}
      Health check: {{ 'PASSED' if not (health_check.failed | default(false)) else 'N/A' }}
      Backup retained: {{ latest_backup | default('none') }}

- name: Record post-update state
  ansible.builtin.set_fact:
    post_update_state:
      host: "{{ inventory_hostname }}"
      success: true
      service_running: "{{ service_restart.changed | default(false) }}"
      health_check_passed: "{{ not (health_check.failed | default(false)) }}"
      timestamp: "{{ ansible_date_time.iso8601 }}"
