#!/usr/bin/env python3
"""
Centralized API Router Registry
Manages all FastAPI routers with their configurations
"""

import logging
from dataclasses import dataclass, field
from enum import Enum
from typing import Dict, List

class RouterStatus(Enum):
    ENABLED = "enabled"
    DISABLED = "disabled"
    LAZY_LOAD = "lazy_load"


@dataclass
class RouterConfig:
    """Configuration for a single API router"""
    name: str
    module_path: str
    prefix: str
    tags: List[str]
    status: RouterStatus = RouterStatus.ENABLED
    dependencies: List[str] = field(default_factory=list)
    description: str = ""


def get_router_configs() -> Dict[str, RouterConfig]:
    """Get all router configurations"""
    return {
        "agent": RouterConfig(
            name="agent",
            module_path="backend.api.agent",
            prefix="/api/agent",
            tags=["agent"],
            status=RouterStatus.ENABLED,
            description="AI agent and conversation management"
        ),
        "system": RouterConfig(
            name="system",
            module_path="backend.api.system",
            prefix="/api/system",
            tags=["system"],
            status=RouterStatus.ENABLED,
            description="System monitoring and control"
        ),
        "terminal": RouterConfig(
            name="terminal",
            module_path="backend.api.terminal_consolidated",
            prefix="/api/terminal",
            tags=["terminal"],
            status=RouterStatus.ENABLED,
            description="Terminal access and command execution"
        ),
        "files": RouterConfig(
            name="files",
            module_path="backend.api.files",
            prefix="/api/files",
            tags=["files"],
            status=RouterStatus.ENABLED,
            description="File operations and management"
        ),
        "knowledge": RouterConfig(
            name="knowledge",
            module_path="backend.api.knowledge",
            prefix="/api/knowledge_base",
            tags=["knowledge"],
            status=RouterStatus.ENABLED,
            description="Knowledge base and search"
        ),
        "chat": RouterConfig(
            name="chat",
            module_path="backend.api.chat",
            prefix="/api/chats",
            tags=["chat"],
            status=RouterStatus.ENABLED,
            description="Chat sessions and message handling"
        ),
        "websockets": RouterConfig(
            name="websockets",
            module_path="backend.api.websockets",
            prefix="",  # WebSocket routes don't use prefix
            tags=["websockets"],
            status=RouterStatus.ENABLED,
            description="WebSocket connections for real-time communication"
        ),
        "logs": RouterConfig(
            name="logs",
            module_path="backend.api.logs",
            prefix="/api/logs",
            tags=["logs"],
            status=RouterStatus.ENABLED,
            description="System logs and monitoring"
        ),
        "developer": RouterConfig(
            name="developer",
            module_path="backend.api.developer",
            prefix="/api/developer",
            tags=["developer"],
            status=RouterStatus.ENABLED,
            description="Developer tools and utilities"
        ),
        "batch": RouterConfig(
            name="batch",
            module_path="backend.api.batch",
            prefix="/api/batch",
            tags=["batch"],
            status=RouterStatus.ENABLED,
            description="Batch operations and bulk processing"
        ),
        "playwright": RouterConfig(
            name="playwright",
            module_path="backend.api.playwright",
            prefix="/api/playwright",
            tags=["browser"],
            status=RouterStatus.ENABLED,
            description="Browser automation and web scraping"
        ),
        "llm": RouterConfig(
            name="llm",
            module_path="backend.api.llm",
            prefix="/api/llm",
            tags=["llm"],
            status=RouterStatus.ENABLED,
            description="Large Language Model interactions"
        ),
        "chat_knowledge": RouterConfig(
            name="chat_knowledge",
            module_path="backend.api.chat_knowledge",
            prefix="/api/chat_knowledge",
            tags=["knowledge", "chat"],
            status=RouterStatus.ENABLED,
            description="Chat-specific knowledge management"
        ),
        "intelligent_agent": RouterConfig(
            name="intelligent_agent",
            module_path="backend.api.intelligent_agent",
            prefix="/api/intelligent_agent",
            tags=["agent", "intelligence"],
            status=RouterStatus.ENABLED,  # RE-ENABLED: Fixed blocking initialization issues
            dependencies=["knowledge", "llm"],
            description="Intelligent AI agent with advanced capabilities"
        ),
        "prompts": RouterConfig(
            name="prompts",
            module_path="backend.api.prompts",
            prefix="/api/prompts",
            tags=["prompts", "templates"],
            status=RouterStatus.ENABLED,
            description="Prompt templates and management"
        ),
        "settings": RouterConfig(
            name="settings",
            module_path="backend.api.settings",
            prefix="/api/settings",
            tags=["settings", "config"],
            status=RouterStatus.ENABLED,
            description="Application settings and configuration"
        ),
        "metrics": RouterConfig(
            name="metrics",
            module_path="backend.api.metrics",
            prefix="/api/metrics",
            tags=["metrics", "monitoring", "performance"],
            status=RouterStatus.ENABLED,
            description="System metrics, performance monitoring, and dashboard data"
        ),
        "registry": RouterConfig(
            name="registry",
            module_path="backend.api.registry",
            prefix="/api/registry",
            tags=["registry", "meta"],
            status=RouterStatus.ENABLED,
            description="API router registry management"
        ),
        # NEWLY ADDED ROUTERS - Previously missing from registry
        "async_chat": RouterConfig(
            name="async_chat",
            module_path="backend.api.async_chat",
            prefix="/api/async_chat",
            tags=["chat", "async"],
            status=RouterStatus.ENABLED,  # FIXED: aioredis and xxhash dependencies installed
            dependencies=["llm", "knowledge"],
            description="Async chat workflow with dependency injection architecture"
        ),
        "workflow": RouterConfig(
            name="workflow",
            module_path="backend.api.workflow",
            prefix="/api/workflow",
            tags=["workflow", "orchestration"],
            status=RouterStatus.ENABLED,  # ENABLED: All functions properly async
            dependencies=["agent", "metrics"],
            description="Multi-agent workflow orchestration and coordination"
        ),
        "monitoring": RouterConfig(
            name="monitoring",
            module_path="backend.api.monitoring",
            prefix="/api/monitoring",
            tags=["monitoring", "hardware"],
            status=RouterStatus.ENABLED,  # ENABLED: No blocking operations detected
            description="Real-time system monitoring with GPU/NPU status"
        ),
        "validation_dashboard": RouterConfig(
            name="validation_dashboard",
            module_path="backend.api.validation_dashboard",
            prefix="/api/validation_dashboard",
            tags=["validation", "dashboard"],
            status=RouterStatus.ENABLED,  # ENABLED: Uses async file I/O with aiofiles
            description="Validation dashboard for real-time AutoBot monitoring and reports"
        )
    }


def get_enabled_routers() -> Dict[str, RouterConfig]:
    """Get only enabled router configurations"""
    all_routers = get_router_configs()
    return {
        name: config for name, config in all_routers.items() 
        if config.status == RouterStatus.ENABLED
    }


def get_router_by_name(name: str) -> RouterConfig:
    """Get specific router configuration by name"""
    routers = get_router_configs()
    if name not in routers:
        raise ValueError(f"Router '{name}' not found in registry")
    return routers[name]


def validate_router_dependencies():
    """Validate that all router dependencies exist"""
    routers = get_router_configs()
    errors = []
    
    for name, config in routers.items():
        for dep in config.dependencies:
            if dep not in routers:
                errors.append(f"Router '{name}' depends on non-existent router '{dep}'")
    
    if errors:
        raise ValueError("\n".join(errors))
    
    return True


def get_endpoint_documentation() -> List[Dict]:
    """Get documentation for all registered endpoints"""
    routers = get_router_configs()
    endpoints = []
    
    for name, config in routers.items():
        if config.status == RouterStatus.ENABLED:
            endpoints.append({
                "name": config.name,
                "prefix": config.prefix,
                "tags": config.tags,
                "description": config.description,
                "status": config.status.value,
                "dependencies": config.dependencies
            })
    
    return endpoints