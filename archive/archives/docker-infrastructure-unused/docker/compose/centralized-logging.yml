# AutoBot Centralized Logging - ALL LOGS IN ONE PLACE
# Every container sends logs to a single centralized logging system

version: '3.8'

services:
  # Central Log Collector - Receives ALL container logs
  autobot-log-collector:
    image: fluent/fluentd:v1.16-debian-1
    container_name: autobot-log-collector
    restart: unless-stopped
    ports:
      - "24224:24224"  # Fluentd log input
      - "24224:24224/udp"
    volumes:
      - ${VOLUMES_DIR:-./docker/volumes}/fluentd/fluent.conf:/fluentd/etc/fluent.conf:ro
      - autobot_all_logs:/var/log/autobot  # SINGLE LOCATION FOR ALL LOGS
      - /var/lib/docker/containers:/var/lib/docker/containers:ro  # Direct Docker log access
    environment:
      - FLUENTD_CONF=fluent.conf
      - FLUENTD_OPT=-v
    networks:
      - autobot
    command: ["fluentd", "-c", "/fluentd/etc/fluent.conf", "-v"]

  # Log Aggregation Service - Processes and stores logs
  autobot-log-aggregator:
    image: elasticsearch:8.8.0
    container_name: autobot-log-aggregator
    restart: unless-stopped
    ports:
      - "9200:9200"
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms256m -Xmx512m"
      - cluster.name=autobot-logs
      - node.name=autobot-log-node
    volumes:
      - autobot_all_logs:/var/log/autobot:ro  # Read from single log location
      - autobot_log_index:/usr/share/elasticsearch/data
    networks:
      - autobot
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

  # Log Viewer - Web interface for ALL logs
  autobot-log-viewer:
    image: kibana:8.8.0
    container_name: autobot-log-viewer
    restart: unless-stopped
    ports:
      - "5601:5601"
    environment:
      - ELASTICSEARCH_HOSTS=http://autobot-log-aggregator:9200
      - SERVER_NAME=autobot-logs
    depends_on:
      autobot-log-aggregator:
        condition: service_healthy
    networks:
      - autobot

volumes:
  # SINGLE VOLUME FOR ALL LOGS
  autobot_all_logs:
    name: autobot_all_logs
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/logs/autobot-all-logs

  autobot_log_index:
    name: autobot_log_index

networks:
  autobot:
    external: true
    name: autobot-network
