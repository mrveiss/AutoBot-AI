# AutoBot - AI-Powered Automation Platform
# Copyright (c) 2025 mrveiss
# Author: mrveiss
#!/bin/bash
#
# Git post-commit hook for SLM code version tracking (Issue #741)
#
# This hook notifies the local SLM agent of new code commits.
# The agent then reports the new version to the SLM server,
# which can coordinate deployments to fleet nodes.
#
# Installation:
#   ln -sf /home/kali/Desktop/AutoBot/scripts/hooks/slm-post-commit .git/hooks/post-commit
#   chmod +x .git/hooks/post-commit
#

set -e

# Get the new commit hash
COMMIT_HASH=$(git rev-parse HEAD)
COMMIT_SHORT=$(git rev-parse --short HEAD)
COMMIT_MESSAGE=$(git log -1 --pretty=%B | head -1)
BRANCH=$(git rev-parse --abbrev-ref HEAD)
AUTHOR=$(git log -1 --pretty=%an)

# SLM agent socket/API endpoint (local)
SLM_AGENT_URL="${SLM_AGENT_URL:-http://localhost:8000}"
SLM_CODE_SOURCE="${SLM_CODE_SOURCE:-true}"
# SLM server URL for direct notification (fallback when agent not running)
SLM_SERVER_URL="${SLM_SERVER_URL:-http://172.16.168.19:8000}"
SLM_NODE_ID="${SLM_NODE_ID:-33792bf5}"

# Only notify if this is marked as a code source node
if [ "$SLM_CODE_SOURCE" != "true" ]; then
    exit 0
fi

# Create notification payload
PAYLOAD=$(cat <<EOF
{
    "event_type": "code_commit",
    "commit": "$COMMIT_HASH",
    "commit_short": "$COMMIT_SHORT",
    "branch": "$BRANCH",
    "author": "$AUTHOR",
    "message": "$COMMIT_MESSAGE",
    "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
    "repository": "$(pwd)"
}
EOF
)

# Notify local SLM agent (non-blocking, fail silently)
echo "[SLM] Notifying agent of commit: $COMMIT_SHORT"

# Try to notify via Unix socket or local agent HTTP API
AGENT_NOTIFIED=false
if [ -S "/var/run/slm-agent/notify.sock" ]; then
    # Use Unix socket if available
    echo "$PAYLOAD" | nc -U /var/run/slm-agent/notify.sock 2>/dev/null && AGENT_NOTIFIED=true
elif curl -s -X POST \
        -H "Content-Type: application/json" \
        -d "$PAYLOAD" \
        "${SLM_AGENT_URL}/api/code-change" \
        --connect-timeout 2 \
        --max-time 5 \
        2>/dev/null | grep -q "status.*ok"; then
    AGENT_NOTIFIED=true
fi

# If local agent not available, notify SLM server directly
if [ "$AGENT_NOTIFIED" != "true" ]; then
    # Create server notification payload (different schema)
    SERVER_PAYLOAD=$(cat <<EOFSERVER
{
    "node_id": "$SLM_NODE_ID",
    "commit": "$COMMIT_HASH",
    "is_code_source": true,
    "branch": "$BRANCH",
    "message": "$COMMIT_MESSAGE"
}
EOFSERVER
)
    if curl -s -X POST \
        -H "Content-Type: application/json" \
        -d "$SERVER_PAYLOAD" \
        "${SLM_SERVER_URL}/api/code-sync/notify" \
        --connect-timeout 5 \
        --max-time 10 \
        2>/dev/null | grep -q "success.*true"; then
        echo "[SLM] Server notified directly: $COMMIT_SHORT"
    else
        echo "[SLM] Warning: Could not notify SLM (agent or server)"
    fi
fi

# Also update the local version.json for immediate tracking
VERSION_FILE="/var/lib/slm-agent/version.json"
if [ -w "$(dirname $VERSION_FILE)" ] || [ -w "$VERSION_FILE" ]; then
    cat > "$VERSION_FILE" <<EOF
{
    "commit": "$COMMIT_HASH",
    "built_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
    "branch": "$BRANCH",
    "source": "git-hook"
}
EOF
    echo "[SLM] Updated version.json: $COMMIT_SHORT"
fi

exit 0
